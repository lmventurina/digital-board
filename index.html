<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>School Digital Bulletin Board</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        school: {
                            navy: '#003893',
                            gold: '#facc15',
                            goldDark: '#eab308'
                        }
                    },
                    fontFamily: {
                        sans: ['Open Sans', 'sans-serif'],
                        display: ['Montserrat', 'sans-serif'],
                    },
                    animation: {
                        'weather-pop': 'weather-pop 0.8s ease-in-out',
                    }
                }
            }
        }
    </script>

    <!-- Custom CSS -->
    <style>
        body { overflow: hidden; background-size: cover; background-position: center; transition: background-image 0.5s ease-in-out; }
        .school-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        
        /* Top Ticker */
        .ticker-wrap { width: 100%; overflow: hidden; background-color: #facc15; box-sizing: content-box; white-space: nowrap; }
        .ticker-move { display: inline-block; padding-left: 100%; animation: ticker 30s linear infinite; }
        
        /* Bottom Ticker Specifics - Fixed Layout */
        .bottom-ticker-wrap { width: 100%; overflow: hidden; background-color: #111827; white-space: nowrap; box-sizing: border-box; }
        /* Slowed down animation from 60s to 200s for better readability */
        .bottom-ticker-move { display: inline-block; padding-left: 100%; animation: ticker 200s linear infinite; }

        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }
        
        /* Weather Pulse Animation */
        @keyframes weather-pop {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.3); filter: brightness(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .weather-update-active { animation: weather-pop 0.8s ease-in-out; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        iframe { width: 100%; height: 100%; border: none; }
        
        /* Glassmorphism utility */
        .glass-panel {
            background: rgba(0, 56, 147, 0.65);
            background-image: linear-gradient(to right, rgba(0, 56, 147, 0.8), rgba(30, 58, 138, 0.8));
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-200 h-screen flex flex-col font-sans text-gray-800">
    
    <!-- Dark overlay for background image readability -->
    <div class="fixed inset-0 bg-gray-900/10 z-0 pointer-events-none"></div>

    <!-- NEW SOPHISTICATED HERO HEADER -->
    <header id="main-header" class="glass-panel text-white py-3 px-6 shadow-lg z-10 flex-none flex items-center justify-between relative transition-all duration-1000">
        
        <!-- Left: Logo & School Name -->
        <div class="flex items-center space-x-5 w-1/3">
            <div class="h-28 w-28 bg-white/90 rounded-full flex-none flex items-center justify-center border-4 border-school-gold overflow-hidden school-logo-container shadow-2xl relative">
                <img id="header-logo" src="https://placehold.co/100x100?text=Logo" alt="School Logo" class="h-full w-full object-cover">
            </div>
            <div class="min-w-0 drop-shadow-md">
                <h1 id="header-school-name" class="text-3xl md:text-4xl font-display font-extrabold tracking-tight uppercase leading-none">Navajo Pine HS</h1>
                <p id="header-subtitle" class="text-school-gold font-bold text-lg tracking-wide uppercase mt-1">School of Technology</p>
            </div>
        </div>

        <!-- Center: Clock, Date & Motto (Grouped) -->
        <div class="text-center w-1/3 flex flex-col justify-center items-center drop-shadow-md">
            <!-- Time -->
            <div id="live-time" class="text-6xl font-display font-black tabular-nums leading-none tracking-tight">--:--</div>
            
            <!-- Date -->
            <div id="live-date" class="text-xl text-gray-100 font-semibold uppercase tracking-widest mt-1 mb-2">Fetching Date...</div>
            
            <!-- Motto: Styled as a sophisticated 'tagline' inside the date container -->
            <div class="relative flex items-center w-full justify-center">
                <div class="h-px bg-gradient-to-r from-transparent via-school-gold to-transparent w-full absolute top-1/2 opacity-50"></div>
                <span id="header-subtitle-2" class="relative bg-blue-900/40 backdrop-blur-md px-4 py-0.5 rounded-full text-xs font-bold text-school-gold uppercase tracking-[0.2em] border border-white/10 shadow-sm">
                    Home of the Tech Warriors
                </span>
            </div>
        </div>

        <!-- Right: Weather Widget -->
        <div class="w-1/3 flex justify-end">
            <div class="bg-blue-900/40 backdrop-blur-xl rounded-2xl p-4 border border-white/20 shadow-2xl flex flex-col min-w-[320px] hover:bg-blue-900/50 transition-colors duration-500">
                <!-- Location Header -->
                <div class="flex justify-between items-end border-b border-white/10 pb-2 mb-2">
                    <span id="weather-city" class="text-lg font-bold text-white uppercase tracking-wider truncate">Loading...</span>
                    <span class="text-[10px] text-school-gold uppercase font-bold tracking-widest">Live Weather</span>
                </div>

                <div class="flex items-center justify-between">
                    <!-- Today -->
                    <div class="flex flex-col items-center justify-center px-4 border-r border-white/10">
                        <!-- Icon will pulse when updated via 'weather-update-active' class -->
                        <div class="text-3xl mb-1 text-school-gold drop-shadow-lg scale-110 transition-transform" id="weather-current-icon"><i class="fas fa-circle-notch fa-spin"></i></div>
                        <span id="weather-current-temp" class="text-2xl font-black leading-none text-white">--¬∞</span>
                    </div>
                    
                    <!-- Forecast -->
                    <div class="flex-1 grid grid-cols-3 gap-2 text-center pl-2" id="weather-forecast">
                        <!-- Forecast items injected here -->
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Top Ticker (School News) -->
    <div class="bg-gradient-to-r from-school-gold via-yellow-400 to-school-gold backdrop-blur-sm text-school-navy font-bold py-3 text-2xl border-b-4 border-school-navy/40 flex-none z-10 relative shadow-md w-full overflow-hidden">
        <div class="ticker-wrap bg-transparent">
            <div class="ticker-move" id="ticker-content">
                Welcome to our digital bulletin board! Go Tigers!
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <main class="flex-grow p-4 overflow-hidden flex flex-col md:flex-row gap-4 relative z-0 pb-16">
        
        <!-- Main Grid (75%) -->
        <div class="w-full md:w-3/4 h-full">
            <div class="grid grid-cols-1 md:grid-cols-2 grid-rows-2 gap-4 h-full">
                
                <!-- Top Left: Student Spotlight -->
                <div class="bg-gradient-to-br from-white/95 to-blue-100/90 backdrop-blur-sm rounded-2xl school-shadow border border-white/40 flex flex-col overflow-hidden relative group">
                    <div class="bg-gradient-to-r from-school-navy to-blue-800 py-2 px-4 text-center">
                        <h2 class="text-white font-display font-bold text-xl"><i class="fas fa-star text-school-gold mr-2"></i> Student Spotlight</h2>
                    </div>
                    <div class="flex-grow relative p-2 flex items-center justify-center" id="student-carousel">
                        <div class="text-center w-full"><p class="text-gray-400">Loading...</p></div>
                    </div>
                    <div class="absolute bottom-0 left-0 h-1 bg-school-gold transition-all duration-300" id="student-progress" style="width: 0%"></div>
                </div>

                <!-- Top Right: Teacher Feature -->
                <div class="bg-gradient-to-br from-white/95 to-blue-100/90 backdrop-blur-sm rounded-2xl school-shadow border border-white/40 flex flex-col overflow-hidden relative">
                    <div class="bg-gradient-to-r from-school-navy to-blue-800 py-2 px-4 text-center">
                        <h2 class="text-white font-display font-bold text-xl"><i class="fas fa-chalkboard-teacher text-school-gold mr-2"></i> Teacher/Staff Feature</h2>
                    </div>
                    <div class="flex-grow relative p-2 flex items-center justify-center" id="teacher-carousel">
                         <div class="text-center w-full"><p class="text-gray-400">Loading...</p></div>
                    </div>
                    <div class="absolute bottom-0 left-0 h-1 bg-school-gold transition-all duration-300" id="teacher-progress" style="width: 0%"></div>
                </div>

                <!-- Bottom Left: Announcements -->
                <div class="bg-gradient-to-br from-white/95 to-blue-100/90 backdrop-blur-sm rounded-2xl school-shadow border border-white/40 flex flex-col overflow-hidden relative">
                    <div class="bg-gradient-to-r from-school-navy to-blue-800 py-2 px-4 text-center">
                        <h2 class="text-white font-display font-bold text-xl"><i class="fas fa-bullhorn text-school-gold mr-2"></i> Announcements</h2>
                    </div>
                    <div class="flex-grow relative p-2 flex items-center justify-center" id="announcement-carousel">
                         <div class="text-center w-full"><p class="text-gray-400">No Announcements</p></div>
                    </div>
                    <div class="absolute bottom-0 left-0 h-1 bg-school-gold transition-all duration-300" id="announcement-progress" style="width: 0%"></div>
                </div>

                <!-- Bottom Right: Media Feed -->
                <div class="bg-black rounded-2xl school-shadow border border-gray-600 flex flex-col overflow-hidden relative" id="media-slot-main">
                    <div class="bg-gradient-to-r from-school-navy to-blue-800 py-2 px-4">
                        <h3 class="text-white font-display font-bold text-xl"><i class="fas fa-photo-video text-school-gold mr-2"></i> Media Feed</h3>
                    </div>
                    <div class="flex-grow bg-black relative" id="media-carousel">
                        <div class="absolute inset-0 flex items-center justify-center text-gray-500 text-sm">
                            <div class="text-center">
                                <i class="fas fa-play-circle fa-2x mb-2"></i>
                                <p>No Media Set</p>
                            </div>
                        </div>
                    </div>
                    <div class="absolute bottom-0 left-0 h-1 bg-school-gold transition-all duration-300 z-10" id="media-progress" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Sidebar / Aside (25%) - Upcoming Events -->
        <aside class="w-full md:w-1/4 h-full flex flex-col">
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl school-shadow border border-white/40 flex flex-col overflow-hidden h-full">
                <div class="bg-gradient-to-r from-school-navy to-blue-800 py-3 px-4 flex justify-between items-center">
                    <h2 class="text-white font-display font-bold text-xl"><i class="fas fa-calendar-alt text-school-gold mr-2"></i> Events</h2>
                    <span class="text-xs text-white bg-blue-900/50 px-2 py-1 rounded font-bold uppercase tracking-wider">Upcoming</span>
                </div>
                <div class="flex-grow overflow-y-auto custom-scrollbar p-4" id="events-list">
                        <div class="text-center w-full text-gray-400 mt-4">Loading Events...</div>
                </div>
            </div>
        </aside>

    </main>

    <!-- Bottom News Ticker (Business/Edu) -->
    <div class="fixed bottom-0 left-0 w-full bg-gray-900 text-white py-3 z-40 border-t-2 border-school-gold shadow-2xl">
        <div class="bottom-ticker-wrap">
            <div class="bottom-ticker-move" id="bottom-ticker-content">
                <span class="inline-block mx-4 text-gray-400 font-mono">Loading News Feed...</span>
            </div>
        </div>
    </div>

    <!-- Floating Buttons (Admin & Help) -->
    <div class="fixed bottom-20 right-6 flex flex-col space-y-4 z-50">
        <!-- Help/Tutorial Button -->
        <button onclick="window.openTutorial()" class="bg-school-gold hover:bg-yellow-400 text-school-navy p-3 rounded-full shadow-lg transition-transform hover:scale-110 flex items-center justify-center h-12 w-12 border-2 border-school-navy" title="How to use">
            <i class="fas fa-question fa-lg font-bold"></i>
        </button>
        
        <!-- Admin Button -->
        <button onclick="handleAdminClick()" class="bg-gray-800/90 hover:bg-school-navy text-white p-4 rounded-full shadow-2xl transition-all duration-300 hover:scale-110 backdrop-blur h-16 w-16 flex items-center justify-center" title="Admin Panel">
            <i class="fas fa-cog fa-2x"></i>
        </button>
    </div>

    <!-- PIN Prompt Modal -->
    <div id="pin-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center transform transition-all scale-100">
            <h3 class="text-xl font-bold text-school-navy mb-4"><i class="fas fa-lock mr-2"></i> Admin Access</h3>
            <p class="text-gray-500 mb-4 text-sm">Please enter the security PIN to continue.</p>
            
            <input type="password" id="pin-input" class="w-full text-center text-3xl tracking-[0.5em] font-bold border-2 border-gray-300 rounded-lg p-3 mb-6 focus:border-school-navy focus:outline-none transition-colors text-school-navy" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            
            <div class="flex space-x-3 justify-center">
                <button onclick="closePinModal()" class="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-lg font-medium transition-colors">Cancel</button>
                <button onclick="verifyPin()" class="bg-school-navy hover:bg-blue-800 text-white font-bold py-2 px-8 rounded-lg shadow-lg transition-transform hover:scale-105">Unlock</button>
            </div>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div id="tutorial-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full overflow-hidden transform transition-all scale-100">
            <div class="bg-school-navy p-6 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-white font-display">Welcome to Your Digital Board!</h3>
                <button onclick="window.closeTutorial()" class="text-white/70 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="p-8 space-y-6">
                <p class="text-gray-600 text-lg">Manage your school's digital signage easily. Here is how to get started:</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex items-start space-x-4">
                        <div class="bg-gray-100 p-3 rounded-full text-gray-800"><i class="fas fa-cog fa-lg"></i></div>
                        <div>
                            <h4 class="font-bold text-school-navy">1. Access Admin Panel</h4>
                            <p class="text-sm text-gray-500">Click the Gear icon in the bottom-right corner.</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-4">
                        <div class="bg-gray-100 p-3 rounded-full text-gray-800"><i class="fas fa-edit fa-lg"></i></div>
                        <div>
                            <h4 class="font-bold text-school-navy">2. Manage Content</h4>
                            <p class="text-sm text-gray-500">Add or Edit Announcements, Students, Staff, and Events.</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-4">
                        <div class="bg-gray-100 p-3 rounded-full text-gray-800"><i class="fas fa-smile fa-lg"></i></div>
                        <div>
                            <h4 class="font-bold text-school-navy">3. Rich Editing</h4>
                            <p class="text-sm text-gray-500">Use <b>Bold</b> and Emojis <span class="grayscale hover:grayscale-0">üòÄ</span> to make messages pop.</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-4">
                        <div class="bg-gray-100 p-3 rounded-full text-gray-800"><i class="fas fa-eye-slash fa-lg"></i></div>
                        <div>
                            <h4 class="font-bold text-school-navy">4. Quick Controls</h4>
                            <p class="text-sm text-gray-500">Use the Eye icon üëÅÔ∏è to hide items instantly.</p>
                        </div>
                    </div>
                </div>

                <div class="pt-6 border-t flex justify-end">
                    <button onclick="window.closeTutorial()" class="bg-school-navy hover:bg-blue-800 text-white font-bold py-3 px-8 rounded-lg shadow transition-colors">
                        Get Started
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Modal -->
    <div id="admin-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-5xl h-[85vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
            <!-- Modal Header -->
            <div class="bg-gray-800 text-white p-4 flex justify-between items-center">
                <h3 class="text-xl font-bold font-display"><i class="fas fa-sliders-h mr-2"></i> Dashboard Configuration</h3>
                <button onclick="toggleAdminModal()" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="flex flex-grow overflow-hidden">
                <!-- Sidebar Tabs -->
                <div class="w-1/5 bg-gray-100 border-r border-gray-200 overflow-y-auto">
                    <nav class="flex flex-col p-2 space-y-1" id="admin-tabs">
                        <button onclick="switchTab('tab-announcements')" class="admin-tab-btn active text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-bullhorn w-6"></i> Announcements
                        </button>
                        <button onclick="switchTab('tab-students')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-user-graduate w-6"></i> Students
                        </button>
                        <button onclick="switchTab('tab-teachers')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-chalkboard-teacher w-6"></i> Teacher/Staff
                        </button>
                        <button onclick="switchTab('tab-events')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-calendar-alt w-6"></i> Events
                        </button>
                        <button onclick="switchTab('tab-ticker')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-scroll w-6"></i> Ticker (Top)
                        </button>
                        <button onclick="switchTab('tab-news')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-newspaper w-6"></i> News Ticker (Btm)
                        </button>
                         <button onclick="switchTab('tab-media')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-photo-video w-6"></i> Media Sidebar
                        </button>
                        <button onclick="switchTab('tab-config')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-tools w-6"></i> Config
                        </button>
                    </nav>
                </div>

                <!-- Content Area -->
                <div class="w-4/5 p-8 overflow-y-auto bg-gray-50 relative">
                    
                    <!-- Tab: Announcements -->
                    <div id="tab-announcements" class="admin-content block">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Manage Announcements</h2>
                            <button onclick="openEntryModal('announcements')" class="bg-school-navy hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition-colors"><i class="fas fa-plus mr-2"></i> Add New</button>
                        </div>
                        <div class="space-y-2" id="admin-announcements-list"></div>
                    </div>

                    <!-- Tab: Students -->
                    <div id="tab-students" class="admin-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Manage Student Spotlight</h2>
                            <button onclick="openEntryModal('students')" class="bg-school-navy hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition-colors"><i class="fas fa-plus mr-2"></i> Add Student</button>
                        </div>
                        <div class="space-y-2" id="admin-students-list"></div>
                    </div>

                    <!-- Tab: Teachers -->
                    <div id="tab-teachers" class="admin-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Manage Teacher/Staff Features</h2>
                            <button onclick="openEntryModal('teachers')" class="bg-school-navy hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition-colors"><i class="fas fa-plus mr-2"></i> Add Feature</button>
                        </div>
                        <div class="space-y-2" id="admin-teachers-list"></div>
                    </div>

                    <!-- Tab: Events -->
                    <div id="tab-events" class="admin-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Manage Manual Events</h2>
                            <button onclick="openEntryModal('events')" class="bg-school-navy hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition-colors"><i class="fas fa-plus mr-2"></i> Add Event</button>
                        </div>
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                            <p class="text-sm text-blue-700"><strong>Note:</strong> Events from your Google Calendar link (set in Config) are fetched automatically. Add manual events here for things not on the calendar.</p>
                        </div>
                        <div class="space-y-2" id="admin-events-list"></div>
                    </div>

                    <!-- Tab: Ticker -->
                    <div id="tab-ticker" class="admin-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Manage Ticker Messages (Top)</h2>
                            <button onclick="openEntryModal('ticker')" class="bg-school-navy hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition-colors"><i class="fas fa-plus mr-2"></i> Add Message</button>
                        </div>
                        <div class="space-y-2" id="admin-ticker-list"></div>
                    </div>

                    <!-- Tab: News Ticker -->
                    <div id="tab-news" class="admin-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Manage News Ticker (Bottom)</h2>
                            <button onclick="openEntryModal('news')" class="bg-school-navy hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition-colors"><i class="fas fa-plus mr-2"></i> Add Custom Headline</button>
                        </div>
                        <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 mb-6">
                            <p class="text-sm text-indigo-700">
                                <strong>Live Feed Active:</strong> This ticker automatically displays live Business and Education news from external sources (CNBC, EdWeek).<br>
                                You can add custom items below which will be mixed in with the live news.
                            </p>
                        </div>
                        <div class="space-y-2" id="admin-news-list"></div>
                    </div>

                    <!-- Tab: Media Sidebar -->
                    <div id="tab-media" class="admin-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Manage Media Sidebar</h2>
                            <button onclick="openEntryModal('media')" class="bg-school-navy hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition-colors"><i class="fas fa-plus mr-2"></i> Add Media</button>
                        </div>
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                            <p class="text-sm text-blue-700">
                                <strong>Instructions:</strong> Add YouTube videos, Facebook embeds, or Images. These items will rotate automatically in the sidebar. <br>
                                <strong>Note:</strong> Carousel will wait for videos to finish playing before rotating.
                            </p>
                        </div>
                        <div class="space-y-2" id="admin-media-list"></div>
                    </div>

                    <!-- Tab: Config -->
                    <div id="tab-config" class="admin-content hidden">
                        <div class="max-w-3xl mx-auto space-y-6">
                            <div class="bg-white p-6 rounded-xl shadow-sm border">
                                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">School Identity</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    
                                    <!-- School Name Editor -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">School Name</label>
                                        <div class="border rounded-lg w-full bg-white overflow-hidden border-gray-300 focus-within:border-school-navy focus-within:ring-1 focus-within:ring-school-navy">
                                            <div class="bg-gray-100 px-2 py-1.5 border-b flex space-x-1">
                                                <button type="button" onmousedown="event.preventDefault();" onclick="document.execCommand('bold', false, null)" class="w-6 h-6 flex items-center justify-center hover:bg-gray-300 rounded text-xs font-bold">B</button>
                                                <button type="button" onmousedown="event.preventDefault();" onclick="document.execCommand('italic', false, null)" class="w-6 h-6 flex items-center justify-center hover:bg-gray-300 rounded text-xs italic">I</button>
                                            </div>
                                            <div id="editor-conf-name" class="p-2 min-h-[42px] outline-none text-sm text-gray-700" contenteditable="true"></div>
                                        </div>
                                    </div>

                                    <!-- Subtitle Editor -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Subtitle</label>
                                        <div class="border rounded-lg w-full bg-white overflow-hidden border-gray-300 focus-within:border-school-navy focus-within:ring-1 focus-within:ring-school-navy">
                                            <div class="bg-gray-100 px-2 py-1.5 border-b flex space-x-1">
                                                <button type="button" onmousedown="event.preventDefault();" onclick="document.execCommand('bold', false, null)" class="w-6 h-6 flex items-center justify-center hover:bg-gray-300 rounded text-xs font-bold">B</button>
                                                <button type="button" onmousedown="event.preventDefault();" onclick="document.execCommand('italic', false, null)" class="w-6 h-6 flex items-center justify-center hover:bg-gray-300 rounded text-xs italic">I</button>
                                            </div>
                                            <div id="editor-conf-subtitle" class="p-2 min-h-[42px] outline-none text-sm text-gray-700" contenteditable="true"></div>
                                        </div>
                                    </div>

                                    <!-- Subtitle 2 Editor -->
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Center Tagline (Displayed under date)</label>
                                        <div class="border rounded-lg w-full bg-white overflow-hidden border-gray-300 focus-within:border-school-navy focus-within:ring-1 focus-within:ring-school-navy">
                                            <div class="bg-gray-100 px-2 py-1.5 border-b flex space-x-1">
                                                <button type="button" onmousedown="event.preventDefault();" onclick="document.execCommand('bold', false, null)" class="w-6 h-6 flex items-center justify-center hover:bg-gray-300 rounded text-xs font-bold">B</button>
                                                <button type="button" onmousedown="event.preventDefault();" onclick="document.execCommand('italic', false, null)" class="w-6 h-6 flex items-center justify-center hover:bg-gray-300 rounded text-xs italic">I</button>
                                                <button type="button" onmousedown="event.preventDefault();" onclick="document.execCommand('underline', false, null)" class="w-6 h-6 flex items-center justify-center hover:bg-gray-300 rounded text-xs underline">U</button>
                                            </div>
                                            <div id="editor-conf-subtitle-2" class="p-2 min-h-[42px] outline-none text-sm text-gray-700" contenteditable="true" placeholder="e.g. Home of the Tech Warriors"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Logo Upload Section -->
                                    <div class="md:col-span-2 border-t pt-4 mt-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">School Logo</label>
                                        <div class="flex items-center space-x-4">
                                            <div class="h-16 w-16 bg-white rounded-full border flex items-center justify-center overflow-hidden flex-none">
                                                 <img id="conf-logo-preview" src="https://placehold.co/100x100?text=Logo" class="h-full w-full object-cover">
                                            </div>
                                            <input type="file" id="conf-logo-file" accept="image/*" class="text-sm block w-full text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-school-navy/10 file:text-school-navy hover:file:bg-school-navy/20">
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1 ml-20">Upload a square image (PNG/JPG). Max 1MB (Firestore limit).</p>
                                    </div>
                                    
                                    <!-- Header Background Image Upload Section (Replaced Background Image) -->
                                    <div class="md:col-span-2 border-t pt-4 mt-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Header Background Image</label>
                                        <div class="flex items-center space-x-4">
                                            <div class="h-16 w-16 bg-gray-200 rounded-lg border flex items-center justify-center overflow-hidden flex-none">
                                                 <img id="conf-header-bg-preview" src="https://placehold.co/100x100?text=Header" class="h-full w-full object-cover">
                                            </div>
                                            <input type="file" id="conf-header-bg-file" accept="image/*" class="text-sm block w-full text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-school-navy/10 file:text-school-navy hover:file:bg-school-navy/20">
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1 ml-20">Upload a header background image (PNG/JPG). Max 1MB. Replaces standard blue glass look.</p>
                                    </div>
                                    
                                    <!-- Security PIN Section -->
                                    <div class="md:col-span-2 border-t pt-4 mt-2 bg-red-50 p-4 rounded-lg border border-red-100">
                                        <label class="block text-sm font-bold text-school-navy mb-2"><i class="fas fa-lock mr-2"></i> Security PIN</label>
                                        <div class="flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0 md:space-x-4">
                                            <input type="text" id="conf-admin-pin" class="w-full md:w-32 p-2 border border-gray-300 rounded font-mono text-center tracking-widest text-lg font-bold" placeholder="1234" maxlength="6">
                                            <div class="text-xs text-gray-600">
                                                <p>Set a 4-6 digit PIN to protect this Admin Panel.</p>
                                                <p><strong>Default:</strong> 1234</p>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                            
                            <div class="bg-white p-6 rounded-xl shadow-sm border">
                                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Integrations</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Weather Location (City, State)</label>
                                        <input type="text" id="conf-location" class="w-full p-2 border rounded" placeholder="e.g. Navajo, NM">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Google Calendar Public iCal Link (.ics)</label>
                                        <input type="text" id="conf-calendar" class="w-full p-2 border rounded" placeholder="https://calendar.google.com/.../basic.ics">
                                        <p class="text-xs text-gray-500 mt-1">Paste the "Public address in iCal format" from your Google Calendar settings.</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Stock Market API Key (Finnhub.io)</label>
                                        <input type="text" id="conf-finnhub-key" class="w-full p-2 border rounded" placeholder="Enter Finnhub API Key for real-time stocks">
                                        <p class="text-xs text-gray-500 mt-1">Get a free key at <a href="https://finnhub.io/register" target="_blank" class="text-blue-600 hover:underline">finnhub.io</a>. Leave empty for simulated data.</p>
                                    </div>
                                </div>
                            </div>

                            <button onclick="saveConfig()" class="w-full bg-school-navy hover:bg-blue-800 text-white font-bold py-3 rounded-lg transition-colors shadow">Save Configuration</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Entry Edit/Add Modal (Generic) -->
    <div id="entry-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative">
            <h3 id="entry-modal-title" class="text-xl font-bold mb-4">Add Item</h3>
            <form id="entry-form" onsubmit="handleEntrySubmit(event)" class="space-y-4">
                <!-- Dynamic Fields injected here -->
                <div id="entry-fields"></div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeEntryModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-school-navy text-white rounded hover:bg-blue-800">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="global-loader" class="fixed top-4 right-4 bg-white px-4 py-2 rounded-full shadow-lg z-[100] hidden flex items-center space-x-2">
        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-school-navy"></div>
        <span class="text-xs font-bold text-school-navy">Saving...</span>
    </div>

    <!-- Main Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, setDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Inject YouTube IFrame API
        let ytApiReady = false;
        window.onYouTubeIframeAPIReady = () => { ytApiReady = true; };
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // --- Configuration ---
        // Robust Config: Checks for environment variable (Canvas) OR uses Fallback
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            // Fallback credentials (Demo Project)
            firebaseConfig = {
                apiKey: "AIzaSyAtawxqfPOZqKJZcClKBVXSClC3IsIuDtM",
                authDomain: "digital-bulletin-board-6c660.firebaseapp.com",
                projectId: "digital-bulletin-board-6c660",
                storageBucket: "digital-bulletin-board-6c660.firebasestorage.app",
                messagingSenderId: "1051324595132",
                appId: "1:1051324595132:web:bb95ce7acc65d9e80d49b9",
                measurementId: "G-6VW2SKC09Z"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'navajo-pine-hs-v2'; 

        let currentUser = null;
        let appData = { announcements: [], students: [], teachers: [], events: [], externalEvents: [], ticker: "", settings: {}, media: [], news: [], liveNews: [] };

        const DEPARTMENTS = ["General", "Admin", "History", "Navajo Language", "Math", "ELA", "Science", "Tech", "Special Ed", "PE", "Health", "Welding", "Sports", "Music", "Art"];
        const COLLECTIONS = { ANNOUNCEMENTS: 'announcements', STUDENTS: 'students', TEACHERS: 'teachers', EVENTS: 'events', TICKER: 'ticker', SETTINGS: 'settings', MEDIA: 'media', NEWS: 'news' };

        const els = {
            schoolName: document.getElementById('header-school-name'),
            schoolSubtitle: document.getElementById('header-subtitle'),
            schoolSubtitle2: document.getElementById('header-subtitle-2'),
            liveTime: document.getElementById('live-time'),
            liveDate: document.getElementById('live-date'),
            ticker: document.getElementById('ticker-content'),
            bottomTicker: document.getElementById('bottom-ticker-content'),
            studentCarousel: document.getElementById('student-carousel'),
            studentProgress: document.getElementById('student-progress'),
            teacherCarousel: document.getElementById('teacher-carousel'),
            teacherProgress: document.getElementById('teacher-progress'),
            announcementCarousel: document.getElementById('announcement-carousel'),
            announcementProgress: document.getElementById('announcement-progress'),
            mediaCarousel: document.getElementById('media-carousel'),
            mediaProgress: document.getElementById('media-progress'),
            eventsList: document.getElementById('events-list'),
            weatherCity: document.getElementById('weather-city'),
            weatherIcon: document.getElementById('weather-current-icon'),
            weatherTemp: document.getElementById('weather-current-temp'),
            weatherForecast: document.getElementById('weather-forecast'),
            adminAnnouncements: document.getElementById('admin-announcements-list'),
            adminStudents: document.getElementById('admin-students-list'),
            adminTeachers: document.getElementById('admin-teachers-list'),
            adminEvents: document.getElementById('admin-events-list'),
            adminTicker: document.getElementById('admin-ticker-list'),
            adminNews: document.getElementById('admin-news-list'),
            adminMedia: document.getElementById('admin-media-list'),
            confName: document.getElementById('conf-name'),
            confSubtitle: document.getElementById('conf-subtitle'),
            confSubtitle2: document.getElementById('conf-subtitle-2'),
            confLocation: document.getElementById('conf-location'),
            confCalendar: document.getElementById('conf-calendar')
        };

        // --- Authentication & Initialization ---
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                checkTutorial();
            } catch (e) {
                console.error("Auth failed", e);
            }
        }
        initAuth();

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                console.log("Connected as User:", user.uid);
                setupListeners();
                fetchLiveNews(); // Start fetching live news
            }
        });

        // --- Tutorial Logic ---
        function checkTutorial() {
            if (!localStorage.getItem('tutorial_seen')) {
                document.getElementById('tutorial-modal').classList.remove('hidden');
            }
        }
        
        window.closeTutorial = () => {
            document.getElementById('tutorial-modal').classList.add('hidden');
            localStorage.setItem('tutorial_seen', 'true');
        };

        window.openTutorial = () => {
            document.getElementById('tutorial-modal').classList.remove('hidden');
        };

        // --- Enhanced Time & Weather Logic ---
        let lastDateString = ""; // Track date for changes

        function startClock() {
            const update = () => {
                const now = new Date();
                
                // 1. Update Time
                els.liveTime.innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // 2. Update Date
                const dateOptions = { weekday: 'long', month: 'long', day: 'numeric' };
                const currentDateString = now.toLocaleDateString([], dateOptions);
                els.liveDate.innerText = currentDateString;

                // 3. Intelligent Date Change Check
                if (lastDateString !== "" && currentDateString !== lastDateString) {
                    console.log("Date changed! Refreshing weather...");
                    if (appData.settings && appData.settings.location) {
                        fetchWeather(appData.settings.location);
                    }
                }
                lastDateString = currentDateString;
            };

            update(); 
            setInterval(update, 1000); 
        }
        startClock();

        let weatherInterval;
        let weatherRefreshInterval;

        function startWeatherAutoUpdate(location) {
            if (weatherRefreshInterval) clearInterval(weatherRefreshInterval);
            fetchWeather(location); // Fetch immediately
            // Fetch every 30 minutes
            weatherRefreshInterval = setInterval(() => {
                console.log("Auto-updating weather...");
                fetchWeather(location);
            }, 1800000); 
        }

        async function fetchWeather(location) {
            if (!location) {
                if(els.weatherCity) els.weatherCity.innerText = "NO LOCATION";
                return;
            }
            if(els.weatherCity) els.weatherCity.innerText = location;
            
            // Simple Geocoding fallback logic
            let lat = 35.8973; let lon = -109.0289; // Default Navajo, NM
            const loc = location.toLowerCase();
            if (loc.includes('gallup')) { lat = 35.5281; lon = -108.7426; }
            if (loc.includes('window rock')) { lat = 35.6731; lon = -109.0556; }
            if (loc.includes('albuquerque')) { lat = 35.0844; lon = -106.6504; }

            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,weathercode&temperature_unit=fahrenheit&timezone=auto`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                
                const getWeatherIcon = (code) => {
                    if (code === 0) return 'fa-sun';
                    if (code <= 3) return 'fa-cloud-sun';
                    if (code <= 48) return 'fa-smog';
                    if (code <= 67) return 'fa-cloud-rain';
                    if (code <= 77) return 'fa-snowflake';
                    if (code <= 82) return 'fa-cloud-showers-heavy';
                    if (code <= 86) return 'fa-snowflake';
                    if (code <= 99) return 'fa-bolt';
                    return 'fa-cloud'; 
                };

                if (data.current_weather) {
                    els.weatherTemp.innerText = `${Math.round(data.current_weather.temperature)}¬∞`;
                    const iconClass = getWeatherIcon(data.current_weather.weathercode);
                    els.weatherIcon.innerHTML = `<i class="fas ${iconClass}"></i>`;

                    // Trigger pulse animation
                    els.weatherIcon.classList.remove('weather-update-active');
                    void els.weatherIcon.offsetWidth; // Reflow hack
                    els.weatherIcon.classList.add('weather-update-active');
                    setTimeout(() => els.weatherIcon.classList.remove('weather-update-active'), 1000);
                }

                if (data.daily) {
                    let forecastHtml = '';
                    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                    for(let i=1; i<=3; i++) {
                        if (!data.daily.time[i]) continue;
                        const d = new Date(data.daily.time[i]);
                        d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
                        const dayName = days[d.getDay()];
                        const max = Math.round(data.daily.temperature_2m_max[i]);
                        const min = Math.round(data.daily.temperature_2m_min[i]);
                        const dayIcon = getWeatherIcon(data.daily.weathercode[i]);

                        forecastHtml += `
                            <div class="flex flex-col items-center justify-center">
                                <span class="text-[10px] text-gray-300 font-bold uppercase mb-1">${dayName}</span>
                                <div class="text-xl my-1 text-white"><i class="fas ${dayIcon}"></i></div>
                                <span class="text-xs font-bold leading-none">${max}¬∞/${min}¬∞</span>
                            </div>
                        `;
                    }
                    els.weatherForecast.innerHTML = forecastHtml;
                }

            } catch (e) {
                console.error("Weather Fetch Error", e);
                if(els.weatherCity) els.weatherCity.innerText = "Weather Unavail";
            }
        }

        async function fetchCalendar(icalUrl) {
            // Mocking external events logic for demo
            if(icalUrl && icalUrl.length > 10) {
                console.log("Calendar URL set:", icalUrl);
                appData.externalEvents = [
                    { title: "School Board Mtg", datetime: new Date(Date.now() + 86400000).toISOString().split('T')[0], location: "Admin" },
                    { title: "Early Release", datetime: new Date(Date.now() + 172800000).toISOString().split('T')[0], location: "Campus" }
                ];
                mergeAndRenderEvents();
            } else {
                appData.externalEvents = [];
                mergeAndRenderEvents();
            }
        }

        // --- Live News Fetcher (Business/Edu/Navajo/Stocks) ---
        async function fetchLiveNews() {
            // 1. Get Market Indices, Stocks, Crypto (Real-time)
            // Use provided key as default fallback
            const apiKey = appData.settings?.finnhubApiKey || "d5t4u39r01qt62nh9is0d5t4u39r01qt62nh9isg";
            let marketData = [];

            if (apiKey) {
                // Real Data Fetch
                try {
                    // Indices
                    const indices = [
                        { sym: 'SPY', name: 'S&P 500', type: 'Market Index' },
                        { sym: 'DIA', name: 'DOW', type: 'Market Index' },
                        { sym: 'QQQ', name: 'NASDAQ', type: 'Market Index' }
                    ];
                    
                    // Top 5 US Stocks
                    const stocks = [
                        { sym: 'AAPL', name: 'Apple', type: 'Stock' },
                        { sym: 'MSFT', name: 'Microsoft', type: 'Stock' },
                        { sym: 'NVDA', name: 'Nvidia', type: 'Stock' },
                        { sym: 'GOOGL', name: 'Google', type: 'Stock' },
                        { sym: 'AMZN', name: 'Amazon', type: 'Stock' }
                    ];

                    // Top 5 Crypto (Finnhub usually uses BINANCE: for crypto)
                    const crypto = [
                        { sym: 'BINANCE:BTCUSDT', name: 'BTC', type: 'Crypto' },
                        { sym: 'BINANCE:ETHUSDT', name: 'ETH', type: 'Crypto' },
                        { sym: 'BINANCE:SOLUSDT', name: 'SOL', type: 'Crypto' },
                        { sym: 'BINANCE:BNBUSDT', name: 'BNB', type: 'Crypto' },
                        { sym: 'BINANCE:XRPUSDT', name: 'XRP', type: 'Crypto' }
                    ];

                    const allSymbols = [...indices, ...stocks, ...crypto];
                    
                    for (const s of allSymbols) {
                        const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${s.sym}&token=${apiKey}`);
                        const d = await res.json();
                        // c = current price, dp = percent change
                        if (d.c) {
                            const change = d.dp >= 0 ? `‚ñ≤ +${d.dp.toFixed(2)}%` : `‚ñº ${d.dp.toFixed(2)}%`;
                            marketData.push({ 
                                title: `${s.name}: ${d.c.toFixed(2)} ${change}`, 
                                source: s.type 
                            });
                        }
                    }
                } catch (e) {
                    console.error("Stock API Error", e);
                }
            }
            
            // 2. Fetch RSS Feeds
            // Using rss2json public API to fetch standard feeds
            const feeds = [
                { url: 'https://www.cnbc.com/id/10000664/device/rss/rss.html', type: 'Stock Market' }, 
                { url: 'https://www.cnbc.com/id/10001147/device/rss/rss.html', type: 'Business' },
                { url: 'http://feeds.feedburner.com/EducationWeek', type: 'Education' },
                { url: 'https://news.google.com/rss/search?q=Navajo+Nation&hl=en-US&gl=US&ceid=US:en', type: 'Navajo Nation' }
            ];
            
            let allItems = [];
            
            for (const feed of feeds) {
                try {
                    const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feed.url)}`);
                    const data = await res.json();
                    if (data.status === 'ok') {
                        // Limit to 3 items per feed to keep the loop reasonable
                        const items = data.items.slice(0, 3).map(i => ({ 
                            title: i.title, 
                            source: feed.type 
                        }));
                        allItems = [...allItems, ...items];
                    }
                } catch(e) {
                    console.log("News fetch error", e);
                }
            }
            
            // Shuffle news items slightly so sources are mixed
            allItems.sort(() => Math.random() - 0.5);
            
            // Put Market Indices FIRST, then the news
            appData.liveNews = [...marketData, ...allItems];
            renderBottomTicker();
        }

        function renderBottomTicker() {
            // Combine Manual Items + Live Items
            const manual = appData.news.filter(i => !i.hidden).map(i => ({ title: i.text, source: 'School News' }));
            const combined = [...manual, ...appData.liveNews];
            
            if (combined.length === 0) {
                els.bottomTicker.innerHTML = `<span class="inline-block mx-4 text-gray-400 font-mono">Waiting for news update...</span>`;
                return;
            }
            
            // Headlines Only - Clean Look with subtle color indicators for source
            const html = combined.map(item => {
                let iconColor = 'text-school-gold';
                let icon = 'fa-newspaper';
                
                if (item.source === 'Navajo Nation') { iconColor = 'text-orange-400'; icon = 'fa-feather'; }
                if (item.source === 'Business') { iconColor = 'text-blue-400'; icon = 'fa-briefcase'; }
                if (item.source === 'Stock Market') { iconColor = 'text-emerald-400'; icon = 'fa-chart-line'; } 
                if (item.source === 'Education') { iconColor = 'text-yellow-200'; icon = 'fa-graduation-cap'; }
                
                // Market Data Styling (Indices, Stocks, Crypto)
                if (['Market Index', 'Stock', 'Crypto'].includes(item.source)) {
                    const isUp = item.title.includes('‚ñ≤') || item.title.includes('+');
                    const trendColor = isUp ? 'text-green-400' : 'text-red-400'; 
                    
                    if (item.source === 'Market Index') icon = 'fa-chart-pie';
                    if (item.source === 'Stock') icon = 'fa-building';
                    if (item.source === 'Crypto') icon = 'fa-coins'; 
                    
                    return `
                        <span class="inline-flex items-center mx-8">
                            <i class="fas ${icon} text-gray-400 mr-2 text-sm"></i>
                            <span class="font-mono font-bold text-lg tracking-tight text-white mr-2">${item.title.split(':')[0]}:</span>
                            <span class="font-mono font-bold text-lg ${trendColor}">${item.title.split(':')[1]}</span>
                        </span>
                    `;
                }
                
                return `
                    <span class="inline-flex items-center mx-12">
                        <i class="fas ${icon} ${iconColor} mr-3 text-sm opacity-80"></i>
                        <span class="font-display font-semibold text-lg tracking-wide text-gray-100">${item.title}</span>
                    </span>
                `;
            }).join('');
            
            els.bottomTicker.innerHTML = html;
        }

        // --- Admin/PIN Logic ---
        window.handleAdminClick = () => {
            const pinModal = document.getElementById('pin-modal');
            const pinInput = document.getElementById('pin-input');
            pinModal.classList.remove('hidden');
            pinInput.value = '';
            setTimeout(() => pinInput.focus(), 100);
        };

        window.closePinModal = () => {
            document.getElementById('pin-modal').classList.add('hidden');
        };

        window.verifyPin = () => {
            const input = document.getElementById('pin-input').value;
            const correctPin = (appData.settings && appData.settings.adminPin) ? appData.settings.adminPin : '1234';
            
            if (input === correctPin) {
                closePinModal();
                document.getElementById('admin-modal').classList.remove('hidden');
            } else {
                const inputEl = document.getElementById('pin-input');
                inputEl.classList.add('border-red-500', 'bg-red-50', 'animate-pulse');
                setTimeout(() => {
                    inputEl.classList.remove('border-red-500', 'bg-red-50', 'animate-pulse');
                    inputEl.value = '';
                    inputEl.focus();
                }, 500);
            }
        };

        document.getElementById('pin-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') window.verifyPin();
            if (e.key === 'Escape') window.closePinModal();
        });

        // --- Firebase Listeners ---
        function getCollectionRef(colName) {
            return collection(db, 'artifacts', appId, 'public', 'data', colName);
        }

        function setupListeners() {
            if(window.listenersActive) return;
            window.listenersActive = true;

            const listen = (colName, callback) => {
                onSnapshot(getCollectionRef(colName), (snapshot) => {
                    const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    callback(data);
                }, (error) => console.error(`Error listening to ${colName}:`, error));
            };

            listen(COLLECTIONS.ANNOUNCEMENTS, (data) => {
                appData.announcements = data;
                renderCarousel('announcement', data.filter(item => !item.hidden));
                renderAdminList('announcements', data);
            });

            listen(COLLECTIONS.STUDENTS, (data) => {
                appData.students = data;
                renderCarousel('student', data.filter(item => !item.hidden));
                renderAdminList('students', data);
            });

            listen(COLLECTIONS.TEACHERS, (data) => {
                appData.teachers = data;
                renderCarousel('teacher', data.filter(item => !item.hidden));
                renderAdminList('teachers', data);
            });

            listen(COLLECTIONS.EVENTS, (data) => {
                appData.events = data;
                mergeAndRenderEvents();
                renderAdminList('events', data);
            });

            listen(COLLECTIONS.TICKER, (data) => {
                const visible = data.filter(item => !item.hidden);
                appData.ticker = visible;
                if (visible.length > 0) {
                    els.ticker.innerHTML = visible.map(item => item.text).join(' &nbsp; <span class="text-school-navy/50 mx-2">‚óè</span> &nbsp; ');
                } else {
                    els.ticker.innerHTML = "Welcome to School Board";
                }
                renderAdminList('ticker', data);
            });

            listen(COLLECTIONS.NEWS, (data) => {
                appData.news = data;
                renderBottomTicker();
                renderAdminList('news', data);
            });

            listen(COLLECTIONS.SETTINGS, (data) => {
                if (data.length > 0) {
                    appData.settings = data[0];
                    appData.settingsId = data[0].id;
                    updateUIConfig(data[0]);
                    startWeatherAutoUpdate(data[0].location);
                    fetchLiveNews(); // Re-fetch news when config (API Key) changes
                } else if(currentUser) {
                    // Default settings
                    const defaults = { schoolName: "Navajo Pine HS", subtitle: "School of Technology", location: "Navajo, NM" };
                    addDoc(getCollectionRef(COLLECTIONS.SETTINGS), defaults);
                }
            });

            listen(COLLECTIONS.MEDIA, (data) => {
                appData.media = data;
                renderCarousel('media', data.filter(item => !item.hidden));
                renderAdminList('media', data);
            });
        }

        // --- Core UI Logic ---
        function updateUIConfig(settings) {
            if(settings.schoolName) els.schoolName.innerHTML = settings.schoolName;
            if(settings.subtitle) els.schoolSubtitle.innerHTML = settings.subtitle;
            if(settings.subtitle2) els.schoolSubtitle2.innerHTML = settings.subtitle2;
            if(settings.logo) document.getElementById('header-logo').src = settings.logo;
            
            const headerEl = document.getElementById('main-header');
            if(settings.headerBackground) {
                headerEl.style.backgroundImage = `url('${settings.headerBackground}')`;
                headerEl.style.backgroundSize = 'cover';
                headerEl.style.backgroundPosition = 'center';
            } else {
                headerEl.style.backgroundImage = ''; 
            }
            
            // Populate Editors
            const confName = document.getElementById('editor-conf-name');
            const confSub = document.getElementById('editor-conf-subtitle');
            const confSub2 = document.getElementById('editor-conf-subtitle-2');
            if(confName) confName.innerHTML = settings.schoolName || "";
            if(confSub) confSub.innerHTML = settings.subtitle || "";
            if(confSub2) confSub2.innerHTML = settings.subtitle2 || "";
            els.confLocation.value = settings.location || "";
            els.confCalendar.value = settings.googleCalendar || "";
            document.getElementById('conf-finnhub-key').value = settings.finnhubApiKey || "";
            const pinField = document.getElementById('conf-admin-pin');
            if (pinField) pinField.value = settings.adminPin || "1234";
            
            if(settings.headerBackground) document.getElementById('conf-header-bg-preview').src = settings.headerBackground;
            if(settings.logo) document.getElementById('conf-logo-preview').src = settings.logo;
            
            fetchCalendar(settings.googleCalendar);
        }

        function mergeAndRenderEvents() {
            const all = [...appData.events, ...appData.externalEvents];
            all.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
            
            const now = new Date();
            now.setHours(0,0,0,0);
            
            const upcoming = all.filter(e => {
                const eventDate = new Date(e.datetime);
                eventDate.setMinutes(eventDate.getMinutes() + eventDate.getTimezoneOffset());
                if (e.startDate) {
                    const visibleStart = new Date(e.startDate);
                    visibleStart.setMinutes(visibleStart.getMinutes() + visibleStart.getTimezoneOffset());
                    if (now < visibleStart) return false;
                }
                if (e.endDate) {
                    const visibleEnd = new Date(e.endDate);
                    visibleEnd.setMinutes(visibleEnd.getMinutes() + visibleEnd.getTimezoneOffset());
                    if (now > visibleEnd) return false;
                } else {
                    if (now > eventDate) return false;
                }
                return true;
            });

            if (upcoming.length === 0) {
                els.eventsList.innerHTML = `<p class="text-center text-gray-400 mt-4">No Upcoming Events</p>`;
                return;
            }

            els.eventsList.innerHTML = upcoming.map(e => {
                const d = new Date(e.datetime);
                d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
                const diffTime = d.getTime() - now.getTime();
                const daysUntil = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const isSoon = daysUntil >= 0 && daysUntil <= 3;

                const borderClass = isSoon ? 'border-red-600 bg-red-50' : 'border-school-navy bg-white';
                const dateColor = isSoon ? 'text-red-700' : 'text-school-navy';
                const badge = isSoon ? `<div class="bg-red-600 text-white text-[9px] px-1 py-0.5 rounded font-bold uppercase mt-1 animate-pulse leading-none inline-block">Soon</div>` : '';
                const month = d.toLocaleDateString([], {month:'short'});
                const day = d.toLocaleDateString([], {day:'numeric'});
                
                return `
                <div class="flex items-center p-3 rounded-lg shadow-sm mb-3 border-l-4 ${borderClass} transition-colors duration-300">
                    <div class="flex-none w-14 text-center flex flex-col items-center justify-center">
                        <div class="text-xs font-bold text-gray-500 uppercase leading-none">${month}</div>
                        <div class="text-xl font-bold ${dateColor} leading-none my-0.5">${day}</div>
                        ${badge}
                    </div>
                    <div class="ml-3 flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <h4 class="font-bold text-sm text-gray-800 leading-tight truncate">${e.title}</h4>
                        </div>
                        <p class="text-xs text-gray-500 truncate">${e.location || 'TBA'}</p>
                    </div>
                </div>`;
            }).join('');
        }

        // Carousel Logic
        const carousels = {
            student: { index: 0, timer: null, interval: 8000 },
            teacher: { index: 0, timer: null, interval: 10000 },
            announcement: { index: 0, timer: null, interval: 12000 },
            media: { index: 0, timer: null, interval: 15000 }
        };

        function extractYouTubeID(url) {
            let videoId = '';
            try {
                const u = new URL(url);
                if (u.hostname.includes('youtube.com')) {
                    if (u.searchParams.has('v')) videoId = u.searchParams.get('v');
                    else if (u.pathname.includes('/shorts/')) videoId = u.pathname.split('/shorts/')[1];
                    else if (u.pathname.includes('/embed/')) videoId = u.pathname.split('/embed/')[1];
                } else if (u.hostname.includes('youtu.be')) videoId = u.pathname.slice(1);
            } catch(e) {}
            return videoId ? videoId.split('?')[0].split('&')[0] : null;
        }

        function renderCarousel(type, data) {
            const container = els[`${type}Carousel`];
            const progressBar = els[`${type}Progress`];
            const config = carousels[type];

            if (config.timer) { clearTimeout(config.timer); clearInterval(config.timer); }
            if (type === 'media' && window.currentMediaPlayer) { try { window.currentMediaPlayer.destroy(); } catch(e){} window.currentMediaPlayer = null; }

            if (!data || data.length === 0) {
                container.innerHTML = `<div class="w-full h-full flex items-center justify-center text-center text-gray-400">No content available</div>`;
                return;
            }
            if (config.index >= data.length) config.index = 0;

            const showSlide = () => {
                if (config.timer) clearTimeout(config.timer);
                if (type === 'media' && window.currentMediaPlayer) { try { window.currentMediaPlayer.destroy(); } catch(e){} window.currentMediaPlayer = null; }

                if (progressBar) { progressBar.style.transition = 'none'; progressBar.style.width = '0%'; }
                const item = data[config.index];
                container.innerHTML = `<div class="w-full h-full flex flex-col items-center justify-center opacity-0 transition-opacity duration-500 relative" id="${type}-slide-content"></div>`;
                const slide = document.getElementById(`${type}-slide-content`);
                
                const queueNext = (delay) => {
                    if (data.length <= 1) {
                         if (progressBar) { progressBar.style.width = '0%'; progressBar.style.display = 'none'; } 
                         return; 
                    }
                    if (progressBar) { 
                        progressBar.style.display = 'block';
                        setTimeout(() => { progressBar.style.transition = `width ${delay}ms linear`; progressBar.style.width = '100%'; }, 50); 
                    }
                    config.timer = setTimeout(() => { config.index = (config.index + 1) % data.length; showSlide(); }, delay);
                };

                if (type === 'media' && item.type === 'youtube') {
                    slide.classList.remove('opacity-0'); 
                    let videoId = extractYouTubeID(item.content);
                    if (videoId && ytApiReady) {
                        const playerId = `yt-player-${Date.now()}`;
                        slide.innerHTML = `<div id="${playerId}" style="width:100%; height:100%;"></div>`;
                        const origin = window.location.protocol.startsWith('http') ? window.location.origin : undefined;
                        window.currentMediaPlayer = new YT.Player(playerId, {
                            height: '100%', width: '100%', videoId: videoId,
                            playerVars: { 'autoplay': 1, 'controls': 0, 'rel': 0, 'showinfo': 0, 'modestbranding': 1, 'mute': 0, 'origin': origin, 'enablejsapi': 1, 'iv_load_policy': 3 },
                            events: {
                                'onReady': (event) => { event.target.playVideo(); },
                                'onStateChange': (event) => { 
                                    if (event.data === 0) { 
                                        if (data.length > 1) { config.index = (config.index + 1) % data.length; showSlide(); } 
                                        else { event.target.playVideo(); }
                                    } 
                                },
                                'onError': (e) => { queueNext(3000); }
                            }
                        });
                        if (data.length > 1) config.timer = setTimeout(() => { config.index = (config.index + 1) % data.length; showSlide(); }, 600000); 
                    } else { queueNext(5000); }
                } else if (type === 'media' && item.type === 'facebook') {
                    slide.innerHTML = item.content.includes('<iframe') ? item.content : `<div class="flex items-center justify-center h-full text-red-500 font-bold">Invalid Embed Code</div>`;
                    const fbFrame = slide.querySelector('iframe');
                    if (fbFrame) { fbFrame.style.width = '100%'; fbFrame.style.height = '100%'; }
                    setTimeout(() => slide.classList.remove('opacity-0'), 50);
                    queueNext(config.interval);
                } else {
                    if (type === 'media' && item.type === 'image') {
                         slide.innerHTML = `<img src="${item.content}" class="w-full h-full object-cover">`;
                    } else if (type === 'student') {
                        slide.innerHTML = `
                            <div class="flex flex-row items-center w-full h-full gap-3">
                                <div class="flex-none w-32 h-32 md:w-40 md:h-40 rounded-full border-4 border-school-gold overflow-hidden shadow-lg bg-gray-200 ml-2">
                                    <img src="${item.image || 'https://placehold.co/200?text=Student'}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/200?text=No+Img'">
                                </div>
                                <div class="flex-1 flex flex-col items-start justify-center text-left min-w-0 pr-2">
                                    <h3 class="text-2xl font-bold text-school-navy mb-1 leading-tight">${item.name}</h3>
                                    <span class="bg-school-gold text-school-navy px-3 py-1 rounded-full text-sm font-bold mb-3">${item.focus || 'Student'}</span>
                                    <p class="text-gray-600 italic line-clamp-4 text-sm md:text-base">"${item.description}"</p>
                                </div>
                            </div>`;
                    } else if (type === 'teacher') {
                        slide.innerHTML = `
                            <div class="flex flex-row items-center w-full h-full gap-3">
                                <div class="flex-none w-32 h-32 md:w-40 md:h-40 rounded-full border-4 border-school-navy overflow-hidden shadow-lg bg-gray-200 ml-2">
                                    <img src="${item.image || 'https://placehold.co/200?text=Staff'}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/200?text=No+Img'">
                                </div>
                                <div class="flex-1 text-left min-w-0 pr-2">
                                    <h3 class="text-2xl font-bold text-gray-800 leading-tight">${item.name}</h3>
                                    <div class="text-school-navy font-bold uppercase tracking-wide text-sm mb-2">${item.dept}</div>
                                    <p class="text-gray-600 text-sm line-clamp-5 border-l-4 border-school-gold pl-3">${item.bio}</p>
                                </div>
                            </div>`;
                    } else if (type === 'announcement') {
                        const isImg = item.image && item.image.length > 50; 
                        slide.innerHTML = `
                            <div class="flex flex-row items-center w-full h-full gap-4 relative ${item.urgent ? 'border-4 border-red-600 rounded-xl bg-red-50' : ''} overflow-hidden">
                                ${isImg ? `<div class="flex-none w-1/3 h-full flex items-center justify-center p-1"><img src="${item.image}" class="w-full h-full rounded-lg shadow-sm object-contain"></div>` : `<div class="flex-none w-24 flex items-center justify-center text-school-gold ml-2"><i class="fas fa-bullhorn fa-4x"></i></div>`}
                                <div class="flex-1 flex flex-col justify-center text-left min-w-0 pr-2">
                                    <h3 class="text-xl md:text-2xl font-bold text-school-navy mb-2 leading-tight">${item.title}</h3>
                                    <div class="h-1 w-20 bg-school-gold mb-3"></div>
                                    <p class="text-gray-700 text-sm md:text-lg line-clamp-5">${item.description}</p>
                                </div>
                                ${item.urgent ? '<span class="absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-bl-lg uppercase animate-pulse">Urgent</span>' : ''}
                            </div>`;
                    }
                    setTimeout(() => slide.classList.remove('opacity-0'), 50);
                    queueNext(config.interval);
                }
            };
            showSlide();
        }

        // --- Admin Interface ---
        window.toggleAdminModal = () => { document.getElementById('admin-modal').classList.toggle('hidden'); };

        window.switchTab = (tabId) => {
            document.querySelectorAll('.admin-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.admin-tab-btn').forEach(el => {
                el.classList.remove('bg-white', 'shadow-sm', 'border-l-4', 'border-school-navy', 'text-school-navy');
                el.classList.add('border-transparent');
            });
            document.getElementById(tabId).classList.remove('hidden');
            const btn = Array.from(document.querySelectorAll('.admin-tab-btn')).find(b => b.getAttribute('onclick').includes(tabId));
            if(btn) {
                btn.classList.add('bg-white', 'shadow-sm', 'border-l-4', 'border-school-navy', 'text-school-navy');
                btn.classList.remove('border-transparent');
            }
        };

        window.saveConfig = async () => {
            showLoader();
            try {
                const logoFile = document.getElementById('conf-logo-file').files[0];
                let logoBase64 = appData.settings?.logo || "";
                if (logoFile) logoBase64 = await processAndCompressImage(logoFile, 500);
                
                const headerBgFile = document.getElementById('conf-header-bg-file').files[0];
                let headerBgBase64 = appData.settings?.headerBackground || "";
                if (headerBgFile) headerBgBase64 = await processAndCompressImage(headerBgFile, 1280);

                const conf = {
                    schoolName: document.getElementById('editor-conf-name').innerHTML,
                    subtitle: document.getElementById('editor-conf-subtitle').innerHTML,
                    subtitle2: document.getElementById('editor-conf-subtitle-2').innerHTML,
                    location: els.confLocation.value,
                    googleCalendar: els.confCalendar.value,
                    finnhubApiKey: document.getElementById('conf-finnhub-key').value,
                    logo: logoBase64,
                    headerBackground: headerBgBase64,
                    adminPin: document.getElementById('conf-admin-pin').value || "1234"
                };
                if (appData.settingsId) await updateDoc(doc(getCollectionRef(COLLECTIONS.SETTINGS), appData.settingsId), conf);
                else await addDoc(getCollectionRef(COLLECTIONS.SETTINGS), conf);
                
                // Immediately refresh weather if location changed
                startWeatherAutoUpdate(conf.location);
                
            } catch(e) { console.error(e); alert("Error saving config."); }
            hideLoader();
        };

        function showLoader() { document.getElementById('global-loader').classList.remove('hidden'); }
        function hideLoader() { document.getElementById('global-loader').classList.add('hidden'); }

        window.toggleVisibility = async (type, id, currentHiddenState) => {
            showLoader();
            try { await updateDoc(doc(getCollectionRef(type), id), { hidden: !currentHiddenState }); } catch(e) { console.error(e); }
            hideLoader();
        };

        window.moveItem = async (type, id, direction) => {
            showLoader();
            try {
                const collectionData = [...appData[type]];
                collectionData.forEach((item, index) => { if (item.order === undefined) item.order = index; });
                collectionData.sort((a, b) => a.order - b.order);
                const currentIndex = collectionData.findIndex(item => item.id === id);
                if (currentIndex === -1) { hideLoader(); return; }
                const targetIndex = currentIndex + direction;
                if (targetIndex < 0 || targetIndex >= collectionData.length) { hideLoader(); return; }
                const currentItem = collectionData[currentIndex];
                const targetItem = collectionData[targetIndex];
                const tempOrder = currentItem.order;
                currentItem.order = targetItem.order;
                targetItem.order = tempOrder;
                await updateDoc(doc(getCollectionRef(type), currentItem.id), { order: currentItem.order });
                await updateDoc(doc(getCollectionRef(type), targetItem.id), { order: targetItem.order });
            } catch(e) { console.error(e); }
            hideLoader();
        };

        function renderAdminList(type, data) {
            const container = els[`admin${type.charAt(0).toUpperCase() + type.slice(1)}`];
            if (!container) return;
            if (data.length === 0) { container.innerHTML = `<p class="text-gray-500 italic col-span-3">No items found.</p>`; return; }
            
            container.innerHTML = data.map((item, index) => {
                let mainText = item.title || item.name || item.text;
                let subText = item.description || item.dept || item.datetime || '';
                let img = item.image;
                if(type === 'ticker' || type === 'news') { mainText = item.text; subText = "Ticker Headline"; }
                if(type === 'media') { mainText = item.type.toUpperCase(); subText = item.content ? item.content.substring(0,30) + '...' : ''; if(item.type==='image') img = item.content; }
                if(type === 'events' && item.datetime) {
                    const d = new Date(item.datetime);
                    d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
                    subText = d.toLocaleDateString() + (item.location ? ` - ${item.location}` : '');
                }

                const hiddenClass = item.hidden ? 'opacity-60 bg-gray-50' : '';
                const hiddenIcon = item.hidden ? 'fa-eye-slash text-gray-500' : 'fa-eye text-green-600';
                
                return `
                <div class="bg-white p-4 rounded-lg shadow border border-gray-200 flex justify-between items-start group ${hiddenClass}">
                    <div class="flex items-start space-x-3 overflow-hidden">
                        ${img ? `<img src="${img}" class="w-10 h-10 rounded-full object-cover border">` : ''}
                        <div class="min-w-0">
                            <h4 class="font-bold text-gray-800 truncate text-sm">${mainText}</h4>
                            <p class="text-xs text-gray-500 truncate">${subText || ''}</p>
                        </div>
                    </div>
                    <div class="flex space-x-3 opacity-0 group-hover:opacity-100 transition-opacity items-center">
                         <div class="flex flex-col space-y-1 items-center mr-2">
                            ${index > 0 ? `<button onclick="moveItem('${type}', '${item.id}', -1)" class="text-gray-500 hover:text-school-navy"><i class="fas fa-arrow-up"></i></button>` : `<span class="w-4"></span>`}
                            ${index < data.length - 1 ? `<button onclick="moveItem('${type}', '${item.id}', 1)" class="text-gray-500 hover:text-school-navy"><i class="fas fa-arrow-down"></i></button>` : `<span class="w-4"></span>`}
                        </div>
                        <div class="h-8 w-px bg-gray-200 mx-1"></div>
                        <button onclick="toggleVisibility('${type}', '${item.id}', ${item.hidden || false})" class="${hiddenIcon} hover:text-gray-800"><i class="fas ${hiddenIcon}"></i></button>
                        <button onclick="editEntry('${type}', '${item.id}')" class="text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteEntry('${type}', '${item.id}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }).join('');
        }

        let currentEditType = null;
        let currentEditId = null;

        window.openEntryModal = (type) => {
            currentEditType = type; currentEditId = null;
            document.getElementById('entry-modal-title').innerText = `Add ${type.charAt(0).toUpperCase() + type.slice(1, type.endsWith('s') ? -1 : undefined)}`;
            document.getElementById('entry-form').reset();
            generateFormFields(type, null);
            document.getElementById('entry-modal').classList.remove('hidden');
        };

        window.editEntry = (type, id) => {
            currentEditType = type; currentEditId = id;
            const item = appData[type].find(i => i.id === id);
            if (!item) return;
            document.getElementById('entry-modal-title').innerText = `Edit ${type.charAt(0).toUpperCase() + type.slice(1, type.endsWith('s') ? -1 : undefined)}`;
            generateFormFields(type, item);
            document.getElementById('entry-modal').classList.remove('hidden');
        };

        window.closeEntryModal = () => { document.getElementById('entry-modal').classList.add('hidden'); };

        window.deleteEntry = async (type, id) => {
            if(!confirm("Are you sure?")) return;
            showLoader();
            try { await deleteDoc(doc(getCollectionRef(type), id)); } catch(e) { console.error(e); }
            hideLoader();
        };

        window.handleEntrySubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            const descEditor = document.getElementById('editor-description'); if (descEditor) data.description = descEditor.innerHTML;
            const bioEditor = document.getElementById('editor-bio'); if (bioEditor) data.bio = bioEditor.innerHTML;
            const msgEditor = document.getElementById('editor-text'); if (msgEditor) data.text = msgEditor.innerHTML;

            if (currentEditType === 'announcements') data.urgent = formData.get('urgent') === 'on';
            showLoader();
            try {
                const fileInput = document.getElementById('form-image-file');
                if (fileInput && fileInput.files.length > 0) {
                    data.image = await processAndCompressImage(fileInput.files[0], 1024);
                } else if (!data.image && currentEditId) {
                     const oldItem = appData[currentEditType].find(i => i.id === currentEditId);
                     if(oldItem && oldItem.image) data.image = oldItem.image;
                }
                if (currentEditId) await updateDoc(doc(getCollectionRef(currentEditType), currentEditId), data);
                else await addDoc(getCollectionRef(currentEditType), data);
                closeEntryModal();
            } catch(err) { console.error(err); alert("Error saving: " + err.message); }
            hideLoader();
        };

        function generateFormFields(type, v) {
            const container = document.getElementById('entry-fields');
            let html = '';
            v = v || {};
            const richEditor = (name, val, label) => `<div><label class="block text-sm font-bold mb-1">${label}</label><div id="editor-${name}" class="border rounded p-3 min-h-[80px] max-h-48 overflow-y-auto text-sm" contenteditable="true">${val || ''}</div></div>`;
            
            if (type === 'announcements') {
                html += `<div><label class="block text-sm font-bold mb-1">Title</label><input name="title" required value="${v.title || ''}" class="w-full p-2 border rounded"></div>
                        ${richEditor('description', v.description, 'Description')}
                        <div class="grid grid-cols-2 gap-4 bg-gray-50 p-3 rounded border mt-2">
                            <div><label class="block text-xs font-bold uppercase">Start Date</label><input type="date" name="startDate" value="${v.startDate || ''}" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-xs font-bold uppercase">End Date</label><input type="date" name="endDate" value="${v.endDate || ''}" class="w-full p-2 border rounded"></div>
                        </div>
                        <div class="flex items-center mt-2"><input type="checkbox" name="urgent" ${v.urgent ? 'checked' : ''} class="h-4 w-4"><label class="ml-2 text-sm font-bold text-red-600">Mark as Urgent</label></div>`;
            } else if (type === 'students') {
                html += `<div><label class="block text-sm font-bold mb-1">Student Name</label><input name="name" required value="${v.name || ''}" class="w-full p-2 border rounded"></div>
                        <div><label class="block text-sm font-bold mb-1">Focus Area</label><input name="focus" value="${v.focus || ''}" class="w-full p-2 border rounded"></div>
                        ${richEditor('description', v.description, 'Quote / Description')}`;
            } else if (type === 'teachers') {
                html += `<div><label class="block text-sm font-bold mb-1">Name</label><input name="name" required value="${v.name || ''}" class="w-full p-2 border rounded"></div>
                        <div><label class="block text-sm font-bold mb-1">Department</label><select name="dept" class="w-full p-2 border rounded">${DEPARTMENTS.map(d => `<option value="${d}" ${v.dept === d ? 'selected' : ''}>${d}</option>`).join('')}</select></div>
                        ${richEditor('bio', v.bio, 'Bio')}`;
            } else if (type === 'events') {
                html += `<div><label class="block text-sm font-bold mb-1">Title</label><input name="title" required value="${v.title || ''}" class="w-full p-2 border rounded"></div>
                        <div><label class="block text-sm font-bold mb-1">Event Date</label><input type="date" name="datetime" required value="${v.datetime || ''}" class="w-full p-2 border rounded"></div>
                        <div><label class="block text-sm font-bold mb-1">Location</label><input name="location" value="${v.location || ''}" class="w-full p-2 border rounded"></div>
                        <div class="grid grid-cols-2 gap-4 bg-gray-50 p-3 rounded border mt-2">
                            <div><label class="block text-xs font-bold uppercase">Display Start</label><input type="date" name="startDate" value="${v.startDate || ''}" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-xs font-bold uppercase">Display End</label><input type="date" name="endDate" value="${v.endDate || ''}" class="w-full p-2 border rounded"></div>
                        </div>`;
            } else if (type === 'ticker' || type === 'news') {
                html += richEditor('text', v.text, 'Headline / Message');
            } else if (type === 'media') {
                html += `<div><label class="block text-sm font-bold mb-1">Type</label><select name="type" class="w-full p-2 border rounded"><option value="youtube" ${v.type==='youtube'?'selected':''}>YouTube</option><option value="facebook" ${v.type==='facebook'?'selected':''}>Facebook</option><option value="image" ${v.type==='image'?'selected':''}>Image</option></select></div>
                        <div><label class="block text-sm font-bold mb-1">Content (URL/Code)</label><textarea name="content" required rows="3" class="w-full p-2 border rounded text-xs">${v.content || ''}</textarea></div>`;
            }

            if (type !== 'events' && type !== 'ticker' && type !== 'news' && type !== 'media') {
                html += `<div class="border-t pt-4 mt-2"><label class="block text-sm font-bold mb-1">Image (URL or Upload)</label><input name="image" value="${v.image && v.image.startsWith('http') ? v.image : ''}" class="w-full p-2 border rounded mb-2 text-sm"><input type="file" id="form-image-file" accept="image/*" class="text-sm"></div>`;
            }
            container.innerHTML = html;
        }

        const processAndCompressImage = (file, maxWidth = 1024, quality = 0.7) => {
            return new Promise((resolve, reject) => {
                if (!file) return resolve(null);
                if (file.size < 800 * 1024) { const r = new FileReader(); r.onload = () => resolve(r.result); r.readAsDataURL(file); return; }
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        let w = img.width, h = img.height;
                        if (w > maxWidth) { h = Math.round((h * maxWidth) / w); w = maxWidth; }
                        const canvas = document.createElement('canvas');
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = "#FFFFFF"; ctx.fillRect(0, 0, w, h);
                        ctx.drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                };
            });
        };
    </script>
</body>
</html>
