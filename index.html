<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>School Digital Bulletin Board</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        school: {
                            navy: '#003893',
                            gold: '#facc15',
                            goldDark: '#eab308'
                        }
                    },
                    fontFamily: {
                        sans: ['Open Sans', 'sans-serif'],
                        display: ['Montserrat', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Custom CSS -->
    <style>
        body { overflow: hidden; background-size: cover; background-position: center; transition: background-image 0.5s ease-in-out; }
        .school-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .ticker-wrap { width: 100%; overflow: hidden; background-color: #facc15; padding-left: 100%; box-sizing: content-box; }
        .ticker-move { display: inline-block; white-space: nowrap; padding-right: 100%; box-sizing: content-box; animation: ticker 20s linear infinite; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-enter { opacity: 0; }
        .fade-enter-active { opacity: 1; transition: opacity 500ms ease-in; }
        .fade-exit { opacity: 1; }
        .fade-exit-active { opacity: 0; transition: opacity 500ms ease-out; }
        .aspect-circle { aspect-ratio: 1 / 1; }
        iframe { width: 100%; height: 100%; border: none; }
        
        /* Glassmorphism utility */
        .glass-panel {
            background: rgba(0, 56, 147, 0.65);
            /* Added gradient support for glass panel */
            background-image: linear-gradient(to right, rgba(0, 56, 147, 0.8), rgba(30, 58, 138, 0.8));
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-200 h-screen flex flex-col font-sans text-gray-800">
    
    <!-- Dark overlay for background image readability -->
    <div class="fixed inset-0 bg-gray-900/10 z-0 pointer-events-none"></div>

    <!-- Header with Glassmorphism -->
    <header id="main-header" class="glass-panel text-white pt-3 px-4 pb-2 shadow-lg z-10 flex-none flex flex-col relative">
        <div class="flex justify-between items-center mb-1">
            <!-- Logo & School Info -->
            <div class="flex items-center space-x-4 w-1/3">
                <div class="h-36 w-36 bg-white/90 rounded-full flex-none flex items-center justify-center border-4 border-school-gold overflow-hidden school-logo-container relative shadow-md">
                    <img id="header-logo" src="https://placehold.co/100x100?text=Logo" alt="School Logo" class="h-full w-full object-cover">
                </div>
                <div class="min-w-0 drop-shadow-md">
                    <h1 id="header-school-name" class="text-3xl font-display font-extrabold tracking-wide uppercase whitespace-nowrap overflow-visible">Navajo Pine HS</h1>
                    <p id="header-subtitle" class="text-school-gold font-semibold text-lg leading-tight">School of Technology</p>
                </div>
            </div>

            <!-- Clock & Date -->
            <div class="text-center w-1/3 drop-shadow-md">
                <div id="live-time" class="text-5xl font-display font-bold tabular-nums leading-none">--:--</div>
                <div id="live-date" class="text-lg text-gray-100 mt-1 uppercase tracking-wider leading-none">Fetching Date...</div>
            </div>

            <!-- Weather Widget (Nested Glass) -->
            <div class="w-1/3 flex justify-end">
                <div class="bg-blue-900/30 backdrop-blur-xl rounded-xl p-3 border border-white/20 shadow-2xl flex flex-col min-w-[350px]">
                    <!-- Location Header -->
                    <div class="text-center border-b border-white/10 pb-2 mb-2">
                        <span id="weather-city" class="text-xl font-bold text-white uppercase tracking-widest drop-shadow-md">Loading...</span>
                    </div>

                    <div class="flex items-center justify-between">
                        <!-- Today Column -->
                        <div class="flex flex-col items-center justify-center px-2 border-r border-white/10 w-1/4">
                            <span class="text-[10px] text-school-gold font-bold uppercase mb-1 drop-shadow-md">Today</span>
                            <div class="text-2xl my-1 text-school-gold drop-shadow-md" id="weather-current-icon"><i class="fas fa-cloud"></i></div>
                            <span id="weather-current-temp" class="text-base font-bold leading-none text-white drop-shadow-md">--¬∞</span>
                        </div>
                        
                        <!-- Forecast Columns -->
                        <div class="flex-1 grid grid-cols-3 gap-1 text-center" id="weather-forecast">
                            <!-- Forecast items injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subtitle 2: Full Width -->
        <div class="w-full text-center border-t border-white/10 pt-2 mt-1 drop-shadow-md">
            <p id="header-subtitle-2" class="text-gray-200 font-medium text-sm tracking-[0.2em] uppercase">Home of the Tech Warriors</p>
        </div>
    </header>

    <!-- Ticker -->
    <div class="bg-gradient-to-r from-school-gold via-yellow-400 to-school-gold backdrop-blur-sm text-school-navy font-bold py-4 text-3xl border-b-4 border-school-navy/40 flex-none z-10 relative shadow-md w-full overflow-hidden">
        <div class="ticker-wrap bg-transparent">
            <div class="ticker-move" id="ticker-content">
                Welcome to our digital bulletin board! Go Tigers!
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <main class="flex-grow p-2 overflow-hidden flex flex-col md:flex-row gap-3 relative z-0">
        
        <!-- Main Grid (75%) -->
        <div class="w-full md:w-3/4 h-full">
            <div class="grid grid-cols-1 md:grid-cols-2 grid-rows-2 gap-3 h-full">
                
                <!-- Top Left: Student Spotlight -->
                <div class="bg-gradient-to-br from-white/95 to-blue-100/90 backdrop-blur-sm rounded-2xl school-shadow border border-white/40 flex flex-col overflow-hidden relative group">
                    <div class="bg-gradient-to-r from-school-navy to-blue-800 py-2 px-4 text-center">
                        <h2 class="text-white font-display font-bold text-xl"><i class="fas fa-star text-school-gold mr-2"></i> Student Spotlight</h2>
                    </div>
                    <!-- Reduced padding from p-6 to p-2 to fit content better -->
                    <div class="flex-grow relative p-2 flex items-center justify-center" id="student-carousel">
                        <div class="text-center w-full"><p class="text-gray-400">Loading...</p></div>
                    </div>
                    <div class="absolute bottom-0 left-0 h-1 bg-school-gold transition-all duration-300" id="student-progress" style="width: 0%"></div>
                </div>

                <!-- Top Right: Teacher Feature -->
                <div class="bg-gradient-to-br from-white/95 to-blue-100/90 backdrop-blur-sm rounded-2xl school-shadow border border-white/40 flex flex-col overflow-hidden relative">
                    <div class="bg-gradient-to-r from-school-navy to-blue-800 py-2 px-4 text-center">
                        <h2 class="text-white font-display font-bold text-xl"><i class="fas fa-chalkboard-teacher text-school-gold mr-2"></i> Teacher/Staff Feature</h2>
                    </div>
                    <!-- Reduced padding from p-6 to p-2 -->
                    <div class="flex-grow relative p-2 flex items-center justify-center" id="teacher-carousel">
                         <div class="text-center w-full"><p class="text-gray-400">Loading...</p></div>
                    </div>
                    <div class="absolute bottom-0 left-0 h-1 bg-school-gold transition-all duration-300" id="teacher-progress" style="width: 0%"></div>
                </div>

                <!-- Bottom Left: Announcements -->
                <div class="bg-gradient-to-br from-white/95 to-blue-100/90 backdrop-blur-sm rounded-2xl school-shadow border border-white/40 flex flex-col overflow-hidden relative">
                    <div class="bg-gradient-to-r from-school-navy to-blue-800 py-2 px-4 text-center">
                        <h2 class="text-white font-display font-bold text-xl"><i class="fas fa-bullhorn text-school-gold mr-2"></i> Announcements</h2>
                    </div>
                    <!-- Reduced padding from p-6 to p-2 -->
                    <div class="flex-grow relative p-2 flex items-center justify-center" id="announcement-carousel">
                         <div class="text-center w-full"><p class="text-gray-400">No Announcements</p></div>
                    </div>
                    <div class="absolute bottom-0 left-0 h-1 bg-school-gold transition-all duration-300" id="announcement-progress" style="width: 0%"></div>
                </div>

                <!-- Bottom Right: Media Feed -->
                <div class="bg-black rounded-2xl school-shadow border border-gray-600 flex flex-col overflow-hidden relative" id="media-slot-main">
                    <div class="bg-gradient-to-r from-school-navy to-blue-800 py-2 px-4">
                        <h3 class="text-white font-display font-bold text-xl"><i class="fas fa-photo-video text-school-gold mr-2"></i> Media Feed</h3>
                    </div>
                    <div class="flex-grow bg-black relative" id="media-carousel">
                        <!-- Dynamic Media Content -->
                        <div class="absolute inset-0 flex items-center justify-center text-gray-500 text-sm">
                            <div class="text-center">
                                <i class="fas fa-play-circle fa-2x mb-2"></i>
                                <p>No Media Set</p>
                            </div>
                        </div>
                    </div>
                    <div class="absolute bottom-0 left-0 h-1 bg-school-gold transition-all duration-300 z-10" id="media-progress" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Sidebar / Aside (25%) - Upcoming Events -->
        <aside class="w-full md:w-1/4 h-full flex flex-col">
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl school-shadow border border-white/40 flex flex-col overflow-hidden h-full">
                <div class="bg-gradient-to-r from-school-navy to-blue-800 py-2 px-4 flex justify-between items-center">
                    <h2 class="text-white font-display font-bold text-xl"><i class="fas fa-calendar-alt text-school-gold mr-2"></i> Events</h2>
                    <span class="text-xs text-white bg-blue-800 px-2 py-1 rounded">Upcoming</span>
                </div>
                <div class="flex-grow overflow-y-auto custom-scrollbar p-4" id="events-list">
                        <div class="text-center w-full text-gray-400 mt-4">Loading Events...</div>
                </div>
            </div>
        </aside>

    </main>

    <!-- Floating Buttons (Admin & Help) -->
    <div class="fixed bottom-6 right-6 flex flex-col space-y-4 z-50">
        <!-- Help/Tutorial Button -->
        <button onclick="window.openTutorial()" class="bg-school-gold hover:bg-yellow-400 text-school-navy p-3 rounded-full shadow-lg transition-transform hover:scale-110 flex items-center justify-center h-12 w-12 border-2 border-school-navy" title="How to use">
            <i class="fas fa-question fa-lg font-bold"></i>
        </button>
        
        <!-- Admin Button -->
        <button onclick="handleAdminClick()" class="bg-gray-800/90 hover:bg-school-navy text-white p-4 rounded-full shadow-2xl transition-all duration-300 hover:scale-110 backdrop-blur h-16 w-16 flex items-center justify-center" title="Admin Panel">
            <i class="fas fa-cog fa-2x"></i>
        </button>
    </div>

    <!-- PIN Prompt Modal -->
    <div id="pin-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center transform transition-all scale-100">
            <h3 class="text-xl font-bold text-school-navy mb-4"><i class="fas fa-lock mr-2"></i> Admin Access</h3>
            <p class="text-gray-500 mb-4 text-sm">Please enter the security PIN to continue.</p>
            
            <input type="password" id="pin-input" class="w-full text-center text-3xl tracking-[0.5em] font-bold border-2 border-gray-300 rounded-lg p-3 mb-6 focus:border-school-navy focus:outline-none transition-colors text-school-navy" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            
            <div class="flex space-x-3 justify-center">
                <button onclick="closePinModal()" class="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-lg font-medium transition-colors">Cancel</button>
                <button onclick="verifyPin()" class="bg-school-navy hover:bg-blue-800 text-white font-bold py-2 px-8 rounded-lg shadow-lg transition-transform hover:scale-105">Unlock</button>
            </div>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div id="tutorial-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full overflow-hidden transform transition-all scale-100">
            <div class="bg-school-navy p-6 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-white font-display">Welcome to Your Digital Board!</h3>
                <button onclick="window.closeTutorial()" class="text-white/70 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="p-8 space-y-6">
                <p class="text-gray-600 text-lg">Manage your school's digital signage easily. Here is how to get started:</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex items-start space-x-4">
                        <div class="bg-gray-100 p-3 rounded-full text-gray-800"><i class="fas fa-cog fa-lg"></i></div>
                        <div>
                            <h4 class="font-bold text-school-navy">1. Access Admin Panel</h4>
                            <p class="text-sm text-gray-500">Click the Gear icon in the bottom-right corner to open the dashboard.</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-4">
                        <div class="bg-gray-100 p-3 rounded-full text-gray-800"><i class="fas fa-edit fa-lg"></i></div>
                        <div>
                            <h4 class="font-bold text-school-navy">2. Manage Content</h4>
                            <p class="text-sm text-gray-500">Use the tabs to Add or Edit Announcements, Students, Staff, and Events.</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-4">
                        <div class="bg-gray-100 p-3 rounded-full text-gray-800"><i class="fas fa-smile fa-lg"></i></div>
                        <div>
                            <h4 class="font-bold text-school-navy">3. Rich Editing</h4>
                            <p class="text-sm text-gray-500">Use <b>Bold</b>, <i>Italic</i>, and <span class="grayscale hover:grayscale-0">üòÄ</span> Emojis to make your messages pop.</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-4">
                        <div class="bg-gray-100 p-3 rounded-full text-gray-800"><i class="fas fa-eye-slash fa-lg"></i></div>
                        <div>
                            <h4 class="font-bold text-school-navy">4. Quick Controls</h4>
                            <p class="text-sm text-gray-500">Use the Eye icon üëÅÔ∏è in lists to hide items instantly. Schedule posts with Start/End dates.</p>
                        </div>
                    </div>
                </div>

                <div class="pt-6 border-t flex justify-end">
                    <button onclick="window.closeTutorial()" class="bg-school-navy hover:bg-blue-800 text-white font-bold py-3 px-8 rounded-lg shadow transition-colors">
                        Get Started
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Modal -->
    <div id="admin-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-5xl h-[85vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
            <!-- Modal Header -->
            <div class="bg-gray-800 text-white p-4 flex justify-between items-center">
                <h3 class="text-xl font-bold font-display"><i class="fas fa-sliders-h mr-2"></i> Dashboard Configuration</h3>
                <button onclick="toggleAdminModal()" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="flex flex-grow overflow-hidden">
                <!-- Sidebar Tabs -->
                <div class="w-1/5 bg-gray-100 border-r border-gray-200 overflow-y-auto">
                    <nav class="flex flex-col p-2 space-y-1" id="admin-tabs">
                        <button onclick="switchTab('tab-announcements')" class="admin-tab-btn active text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-bullhorn w-6"></i> Announcements
                        </button>
                        <button onclick="switchTab('tab-students')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-user-graduate w-6"></i> Students
                        </button>
                        <button onclick="switchTab('tab-teachers')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-chalkboard-teacher w-6"></i> Teacher/Staff
                        </button>
                        <button onclick="switchTab('tab-events')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-calendar-alt w-6"></i> Events
                        </button>
                        <button onclick="switchTab('tab-ticker')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-scroll w-6"></i> Ticker
                        </button>
                         <button onclick="switchTab('tab-media')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-photo-video w-6"></i> Media Sidebar
                        </button>
                        <button onclick="switchTab('tab-config')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-tools w-6"></i> Config
                        </button>
                    </nav>
                </div>

                <!-- Content Area -->
                <div class="w-4/5 p-8 overflow-y-auto bg-gray-50 relative">
                    
                    <!-- Tab: Announcements -->
                    <div id="tab-announcements" class="admin-content block">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Manage Announcements</h2>
                            <button onclick="openEntryModal('announcements')" class="bg-school-navy hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition-colors"><i class="fas fa-plus mr-2"></i> Add New</button>
                        </div>
                        <div class="space-y-2" id="admin-announcements-list"></div>
                    </div>

                    <!-- Tab: Students -->
                    <div id="tab-students" class="admin-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Manage Student Spotlight</h2>
                            <button onclick="openEntryModal('students')" class="bg-school-navy hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition-colors"><i class="fas fa-plus mr-2"></i> Add Student</button>
                        </div>
                        <div class="space-y-2" id="admin-students-list"></div>
                    </div>

                    <!-- Tab: Teachers -->
                    <div id="tab-teachers" class="admin-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Manage Teacher/Staff Features</h2>
                            <button onclick="openEntryModal('teachers')" class="bg-school-navy hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition-colors"><i class="fas fa-plus mr-2"></i> Add Feature</button>
                        </div>
                        <div class="space-y-2" id="admin-teachers-list"></div>
                    </div>

                    <!-- Tab: Events -->
                    <div id="tab-events" class="admin-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Manage Manual Events</h2>
                            <button onclick="openEntryModal('events')" class="bg-school-navy hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition-colors"><i class="fas fa-plus mr-2"></i> Add Event</button>
                        </div>
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                            <p class="text-sm text-blue-700"><strong>Note:</strong> Events from your Google Calendar link (set in Config) are fetched automatically. Add manual events here for things not on the calendar.</p>
                        </div>
                        <div class="space-y-2" id="admin-events-list"></div>
                    </div>

                    <!-- Tab: Ticker -->
                    <div id="tab-ticker" class="admin-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Manage Ticker Messages</h2>
                            <button onclick="openEntryModal('ticker')" class="bg-school-navy hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition-colors"><i class="fas fa-plus mr-2"></i> Add Message</button>
                        </div>
                        <div class="space-y-2" id="admin-ticker-list"></div>
                    </div>

                    <!-- Tab: Media Sidebar -->
                    <div id="tab-media" class="admin-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Manage Media Sidebar</h2>
                            <button onclick="openEntryModal('media')" class="bg-school-navy hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition-colors"><i class="fas fa-plus mr-2"></i> Add Media</button>
                        </div>
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                            <p class="text-sm text-blue-700">
                                <strong>Instructions:</strong> Add YouTube videos, Facebook embeds, or Images. These items will rotate automatically in the sidebar. <br>
                                <strong>Note:</strong> Carousel will wait for videos to finish playing before rotating.
                            </p>
                        </div>
                        <div class="space-y-2" id="admin-media-list"></div>
                    </div>

                    <!-- Tab: Config -->
                    <div id="tab-config" class="admin-content hidden">
                        <div class="max-w-3xl mx-auto space-y-6">
                            <div class="bg-white p-6 rounded-xl shadow-sm border">
                                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">School Identity</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    
                                    <!-- School Name Editor -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">School Name</label>
                                        <div class="border rounded-lg w-full bg-white overflow-hidden border-gray-300 focus-within:border-school-navy focus-within:ring-1 focus-within:ring-school-navy">
                                            <div class="bg-gray-100 px-2 py-1.5 border-b flex space-x-1">
                                                <button type="button" onmousedown="event.preventDefault();" onclick="document.execCommand('bold', false, null)" class="w-6 h-6 flex items-center justify-center hover:bg-gray-300 rounded text-xs font-bold">B</button>
                                                <button type="button" onmousedown="event.preventDefault();" onclick="document.execCommand('italic', false, null)" class="w-6 h-6 flex items-center justify-center hover:bg-gray-300 rounded text-xs italic">I</button>
                                            </div>
                                            <div id="editor-conf-name" class="p-2 min-h-[42px] outline-none text-sm text-gray-700" contenteditable="true"></div>
                                        </div>
                                    </div>

                                    <!-- Subtitle Editor -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Subtitle</label>
                                        <div class="border rounded-lg w-full bg-white overflow-hidden border-gray-300 focus-within:border-school-navy focus-within:ring-1 focus-within:ring-school-navy">
                                            <div class="bg-gray-100 px-2 py-1.5 border-b flex space-x-1">
                                                <button type="button" onmousedown="event.preventDefault();" onclick="document.execCommand('bold', false, null)" class="w-6 h-6 flex items-center justify-center hover:bg-gray-300 rounded text-xs font-bold">B</button>
                                                <button type="button" onmousedown="event.preventDefault();" onclick="document.execCommand('italic', false, null)" class="w-6 h-6 flex items-center justify-center hover:bg-gray-300 rounded text-xs italic">I</button>
                                            </div>
                                            <div id="editor-conf-subtitle" class="p-2 min-h-[42px] outline-none text-sm text-gray-700" contenteditable="true"></div>
                                        </div>
                                    </div>

                                    <!-- Subtitle 2 Editor -->
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Subtitle 2</label>
                                        <div class="border rounded-lg w-full bg-white overflow-hidden border-gray-300 focus-within:border-school-navy focus-within:ring-1 focus-within:ring-school-navy">
                                            <div class="bg-gray-100 px-2 py-1.5 border-b flex space-x-1">
                                                <button type="button" onmousedown="event.preventDefault();" onclick="document.execCommand('bold', false, null)" class="w-6 h-6 flex items-center justify-center hover:bg-gray-300 rounded text-xs font-bold">B</button>
                                                <button type="button" onmousedown="event.preventDefault();" onclick="document.execCommand('italic', false, null)" class="w-6 h-6 flex items-center justify-center hover:bg-gray-300 rounded text-xs italic">I</button>
                                                <button type="button" onmousedown="event.preventDefault();" onclick="document.execCommand('underline', false, null)" class="w-6 h-6 flex items-center justify-center hover:bg-gray-300 rounded text-xs underline">U</button>
                                            </div>
                                            <div id="editor-conf-subtitle-2" class="p-2 min-h-[42px] outline-none text-sm text-gray-700" contenteditable="true" placeholder="e.g. Home of the Tech Warriors"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Logo Upload Section -->
                                    <div class="md:col-span-2 border-t pt-4 mt-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">School Logo</label>
                                        <div class="flex items-center space-x-4">
                                            <div class="h-16 w-16 bg-white rounded-full border flex items-center justify-center overflow-hidden flex-none">
                                                 <img id="conf-logo-preview" src="https://placehold.co/100x100?text=Logo" class="h-full w-full object-cover">
                                            </div>
                                            <input type="file" id="conf-logo-file" accept="image/*" class="text-sm block w-full text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-school-navy/10 file:text-school-navy hover:file:bg-school-navy/20">
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1 ml-20">Upload a square image (PNG/JPG). Max 1MB (Firestore limit).</p>
                                    </div>
                                    
                                    <!-- Header Background Image Upload Section (Replaced Background Image) -->
                                    <div class="md:col-span-2 border-t pt-4 mt-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Header Background Image</label>
                                        <div class="flex items-center space-x-4">
                                            <div class="h-16 w-16 bg-gray-200 rounded-lg border flex items-center justify-center overflow-hidden flex-none">
                                                 <img id="conf-header-bg-preview" src="https://placehold.co/100x100?text=Header" class="h-full w-full object-cover">
                                            </div>
                                            <input type="file" id="conf-header-bg-file" accept="image/*" class="text-sm block w-full text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-school-navy/10 file:text-school-navy hover:file:bg-school-navy/20">
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1 ml-20">Upload a header background image (PNG/JPG). Max 1MB. Replaces standard blue glass look.</p>
                                    </div>
                                    
                                    <!-- Security PIN Section -->
                                    <div class="md:col-span-2 border-t pt-4 mt-2 bg-red-50 p-4 rounded-lg border border-red-100">
                                        <label class="block text-sm font-bold text-school-navy mb-2"><i class="fas fa-lock mr-2"></i> Security PIN</label>
                                        <div class="flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0 md:space-x-4">
                                            <input type="text" id="conf-admin-pin" class="w-full md:w-32 p-2 border border-gray-300 rounded font-mono text-center tracking-widest text-lg font-bold" placeholder="1234" maxlength="6">
                                            <div class="text-xs text-gray-600">
                                                <p>Set a 4-6 digit PIN to protect this Admin Panel.</p>
                                                <p><strong>Default:</strong> 1234</p>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                            
                            <div class="bg-white p-6 rounded-xl shadow-sm border">
                                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Integrations</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Weather Location (City, State)</label>
                                        <input type="text" id="conf-location" class="w-full p-2 border rounded" placeholder="e.g. Navajo, NM">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Google Calendar Public iCal Link (.ics)</label>
                                        <input type="text" id="conf-calendar" class="w-full p-2 border rounded" placeholder="https://calendar.google.com/.../basic.ics">
                                        <p class="text-xs text-gray-500 mt-1">Paste the "Public address in iCal format" from your Google Calendar settings.</p>
                                    </div>
                                </div>
                            </div>

                            <button onclick="saveConfig()" class="w-full bg-school-navy hover:bg-blue-800 text-white font-bold py-3 rounded-lg transition-colors shadow">Save Configuration</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Entry Edit/Add Modal (Generic) -->
    <div id="entry-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative">
            <h3 id="entry-modal-title" class="text-xl font-bold mb-4">Add Item</h3>
            <form id="entry-form" onsubmit="handleEntrySubmit(event)" class="space-y-4">
                <!-- Dynamic Fields injected here -->
                <div id="entry-fields"></div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeEntryModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-school-navy text-white rounded hover:bg-blue-800">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="global-loader" class="fixed top-4 right-4 bg-white px-4 py-2 rounded-full shadow-lg z-[100] hidden flex items-center space-x-2">
        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-school-navy"></div>
        <span class="text-xs font-bold text-school-navy">Saving...</span>
    </div>

    <!-- Main Logic -->
    <script type="module">
        // !!! UPDATED: Reverted to Version 10.12.2 to match original app.js and fix 404s !!!
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, setDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Inject YouTube IFrame API
        let ytApiReady = false;
        window.onYouTubeIframeAPIReady = () => { ytApiReady = true; };
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // --- Configuration ---
        // Robust Config: Checks for environment variable (Canvas) OR uses Fallback (Local/GitHub)
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            // Fallback to original app.js credentials
            firebaseConfig = {
                apiKey: "AIzaSyAtawxqfPOZqKJZcClKBVXSClC3IsIuDtM",
                authDomain: "digital-bulletin-board-6c660.firebaseapp.com",
                projectId: "digital-bulletin-board-6c660",
                storageBucket: "digital-bulletin-board-6c660.firebasestorage.app",
                messagingSenderId: "1051324595132",
                appId: "1:1051324595132:web:bb95ce7acc65d9e80d49b9",
                measurementId: "G-6VW2SKC09Z"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Handle appId similarly
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'navajo-pine-hs-v1'; 

        let currentUser = null;
        let appData = { announcements: [], students: [], teachers: [], events: [], externalEvents: [], ticker: "", settings: {}, media: [] };

        const DEPARTMENTS = ["General", "Admin", "History", "Navajo Language", "Math", "ELA", "Science", "Tech", "Special Ed", "PE", "Health", "Welding", "Sports", "Music", "Art"];
        const COLLECTIONS = { ANNOUNCEMENTS: 'announcements', STUDENTS: 'students', TEACHERS: 'teachers', EVENTS: 'events', TICKER: 'ticker', SETTINGS: 'settings', MEDIA: 'media' };

        const els = {
            schoolName: document.getElementById('header-school-name'),
            schoolSubtitle: document.getElementById('header-subtitle'),
            schoolSubtitle2: document.getElementById('header-subtitle-2'),
            liveTime: document.getElementById('live-time'),
            liveDate: document.getElementById('live-date'),
            ticker: document.getElementById('ticker-content'),
            studentCarousel: document.getElementById('student-carousel'),
            studentProgress: document.getElementById('student-progress'),
            teacherCarousel: document.getElementById('teacher-carousel'),
            teacherProgress: document.getElementById('teacher-progress'),
            announcementCarousel: document.getElementById('announcement-carousel'),
            announcementProgress: document.getElementById('announcement-progress'),
            mediaCarousel: document.getElementById('media-carousel'),
            mediaProgress: document.getElementById('media-progress'),
            eventsList: document.getElementById('events-list'),
            weatherCity: document.getElementById('weather-city'),
            weatherIcon: document.getElementById('weather-current-icon'),
            weatherTemp: document.getElementById('weather-current-temp'),
            weatherForecast: document.getElementById('weather-forecast'),
            adminAnnouncements: document.getElementById('admin-announcements-list'),
            adminStudents: document.getElementById('admin-students-list'),
            adminTeachers: document.getElementById('admin-teachers-list'),
            adminEvents: document.getElementById('admin-events-list'),
            adminTicker: document.getElementById('admin-ticker-list'),
            adminMedia: document.getElementById('admin-media-list'),
            confName: document.getElementById('conf-name'),
            confSubtitle: document.getElementById('conf-subtitle'),
            confSubtitle2: document.getElementById('conf-subtitle-2'),
            confLocation: document.getElementById('conf-location'),
            confCalendar: document.getElementById('conf-calendar')
        };

        // --- Authentication & Initialization ---
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                checkTutorial();
            } catch (e) {
                console.error("Auth failed", e);
            }
        }
        initAuth();

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                console.log("Connected as User:", user.uid);
                setupListeners();
            }
        });

        // --- Tutorial Logic ---
        function checkTutorial() {
            if (!localStorage.getItem('tutorial_seen')) {
                document.getElementById('tutorial-modal').classList.remove('hidden');
            }
        }
        
        window.closeTutorial = () => {
            document.getElementById('tutorial-modal').classList.add('hidden');
            localStorage.setItem('tutorial_seen', 'true');
        };

        window.openTutorial = () => {
            document.getElementById('tutorial-modal').classList.remove('hidden');
        };

        // --- Missing Functions Implementation ---
        function startClock() {
            const update = () => {
                const now = new Date();
                els.liveTime.innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                els.liveDate.innerText = now.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' });
            };
            update();
            setInterval(update, 1000);
        }
        startClock();

        let weatherInterval;
        async function fetchWeather(location) {
            if (!location) {
                if(els.weatherCity) els.weatherCity.innerText = "NO LOCATION";
                return;
            }
            if(els.weatherCity) els.weatherCity.innerText = location;
            
            // Simple Open-Meteo Integration
            // 1. Geocoding (Simulated for common places or using a simple heuristic)
            // For this demo, we will use coordinates for Navajo, NM as default if lookup fails
            // Navajo, NM: 35.8973, -109.0289
            let lat = 35.8973;
            let lon = -109.0289;

            // Very basic "Geocoding" for demo purposes. 
            // In a real production app, use Google Maps Geocoding API or OpenStreetMap Nominatim.
            if (location.toLowerCase().includes('gallup')) { lat = 35.5281; lon = -108.7426; }
            if (location.toLowerCase().includes('window rock')) { lat = 35.6731; lon = -109.0556; }
            if (location.toLowerCase().includes('albuquerque')) { lat = 35.0844; lon = -106.6504; }

            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,weathercode&temperature_unit=fahrenheit&timezone=auto`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                
                // Helper to map WMO codes to Font Awesome
                // Defined here to be accessible to both current and daily logic
                const getWeatherIcon = (code) => {
                    if (code === 0) return 'fa-sun';
                    if (code <= 3) return 'fa-cloud-sun';
                    if (code <= 48) return 'fa-smog';
                    if (code <= 67) return 'fa-cloud-rain';
                    if (code <= 77) return 'fa-snowflake';
                    if (code <= 82) return 'fa-cloud-showers-heavy';
                    if (code <= 86) return 'fa-snowflake';
                    if (code <= 99) return 'fa-bolt';
                    return 'fa-cloud'; // default
                };

                if (data.current_weather) {
                    els.weatherTemp.innerText = `${Math.round(data.current_weather.temperature)}¬∞`;
                    const iconClass = getWeatherIcon(data.current_weather.weathercode);
                    els.weatherIcon.innerHTML = `<i class="fas ${iconClass}"></i>`;
                }

                if (data.daily) {
                    let forecastHtml = '';
                    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                    // Limit to 3 days
                    for(let i=1; i<=3; i++) {
                        if (!data.daily.time[i]) continue;
                        
                        const d = new Date(data.daily.time[i]);
                        // Fix for timezone offset in daily strings (Open-Meteo returns YYYY-MM-DD which is UTC midnight)
                        d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
                        
                        const dayName = days[d.getDay()];
                        const max = Math.round(data.daily.temperature_2m_max[i]);
                        const min = Math.round(data.daily.temperature_2m_min[i]);
                        // Get icon for the day
                        const dayIcon = getWeatherIcon(data.daily.weathercode[i]);

                        forecastHtml += `
                            <div class="flex flex-col items-center justify-center">
                                <span class="text-[10px] text-gray-300 font-bold uppercase mb-1">${dayName}</span>
                                <div class="text-2xl my-1 text-white"><i class="fas ${dayIcon}"></i></div>
                                <span class="text-base font-bold leading-none">${max}¬∞/${min}¬∞</span>
                            </div>
                        `;
                    }
                    els.weatherForecast.innerHTML = forecastHtml;
                }

            } catch (e) {
                console.error("Weather Fetch Error", e);
                if(els.weatherCity) els.weatherCity.innerText = "Weather Unavail";
            }
        }

        async function fetchCalendar(icalUrl) {
            // CORS restrictions prevent direct fetching of iCal files from Google in the browser.
            // In a real app, this requires a backend proxy.
            // For this demo, we will acknowledge the URL but not fail.
            if(icalUrl && icalUrl.length > 10) {
               console.log("Calendar URL set:", icalUrl);
               // If we could fetch:
               // const res = await fetch(icalUrl);
               // const text = await res.text();
               // parseICal(text);
               
               // Mocking external events for demo when URL is present
               appData.externalEvents = [
                   { title: "School Board Mtg", datetime: new Date(Date.now() + 86400000).toISOString().split('T')[0], location: "Admin" },
                   { title: "Early Release", datetime: new Date(Date.now() + 172800000).toISOString().split('T')[0], location: "Campus" }
               ];
               mergeAndRenderEvents();
            } else {
                appData.externalEvents = [];
                mergeAndRenderEvents();
            }
        }

        // --- Auth Functions ---
        
        // OLD: window.handleAdminClick = () => { document.getElementById('admin-modal').classList.remove('hidden'); };
        
        // NEW: PIN Logic
        window.handleAdminClick = () => {
            const pinModal = document.getElementById('pin-modal');
            const pinInput = document.getElementById('pin-input');
            
            pinModal.classList.remove('hidden');
            pinInput.value = '';
            setTimeout(() => pinInput.focus(), 100);
        };

        window.closePinModal = () => {
            document.getElementById('pin-modal').classList.add('hidden');
        };

        window.verifyPin = () => {
            const input = document.getElementById('pin-input').value;
            // Get saved PIN or default to '1234'
            const correctPin = (appData.settings && appData.settings.adminPin) ? appData.settings.adminPin : '1234';
            
            if (input === correctPin) {
                closePinModal();
                document.getElementById('admin-modal').classList.remove('hidden');
            } else {
                // Shake effect for wrong PIN
                const inputEl = document.getElementById('pin-input');
                inputEl.classList.add('border-red-500', 'bg-red-50');
                inputEl.classList.add('animate-pulse'); // Simple visual feedback
                setTimeout(() => {
                    inputEl.classList.remove('border-red-500', 'bg-red-50', 'animate-pulse');
                    inputEl.value = '';
                    inputEl.focus();
                }, 500);
            }
        };

        // Allow Enter key to submit PIN
        document.getElementById('pin-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') window.verifyPin();
            if (e.key === 'Escape') window.closePinModal();
        });

        // --- Firebase Listeners ---
        function getCollectionRef(colName) {
            return collection(db, 'artifacts', appId, 'public', 'data', colName);
        }

        function setupListeners() {
            if(window.listenersActive) return;
            window.listenersActive = true;

            const listen = (colName, callback) => {
                onSnapshot(getCollectionRef(colName), (snapshot) => {
                    const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    callback(data);
                }, (error) => console.error(`Error listening to ${colName}:`, error));
            };

            listen(COLLECTIONS.ANNOUNCEMENTS, (data) => {
                appData.announcements = data;
                // Filter out hidden items
                const visible = data.filter(item => !item.hidden);
                renderCarousel('announcement', visible);
                renderAdminList('announcements', data);
            });

            listen(COLLECTIONS.STUDENTS, (data) => {
                appData.students = data;
                // Filter out hidden items
                const visible = data.filter(item => !item.hidden);
                renderCarousel('student', visible);
                renderAdminList('students', data);
            });

            listen(COLLECTIONS.TEACHERS, (data) => {
                appData.teachers = data;
                // Filter out hidden items
                const visible = data.filter(item => !item.hidden);
                renderCarousel('teacher', visible);
                renderAdminList('teachers', data);
            });

            listen(COLLECTIONS.EVENTS, (data) => {
                appData.events = data;
                mergeAndRenderEvents();
                renderAdminList('events', data);
            });

            listen(COLLECTIONS.TICKER, (data) => {
                if (data.length > 0) {
                    // Filter out hidden ticker items
                    const visibleTicker = data.filter(item => !item.hidden);
                    appData.ticker = visibleTicker;
                    
                    if (visibleTicker.length > 0) {
                        const combinedText = visibleTicker.map(item => item.text).join(' &nbsp; <span class="text-school-navy/50 mx-2">‚óè</span> &nbsp; ');
                        els.ticker.innerHTML = combinedText;
                    } else {
                         els.ticker.innerHTML = "Welcome to School Board";
                    }
                } else {
                      els.ticker.innerHTML = "Welcome to School Board";
                }
                renderAdminList('ticker', data);
            });

            listen(COLLECTIONS.SETTINGS, (data) => {
                if (data.length > 0) {
                    appData.settings = data[0];
                    appData.settingsId = data[0].id;
                    updateUIConfig(data[0]);
                } else {
                    // Create default settings if they don't exist
                    if(currentUser) {
                        const defaults = {
                            schoolName: "Navajo Pine HS",
                            subtitle: "School of Technology",
                            subtitle2: "<b><i>Home of the Tech Warriors (T√≥ √©√≠ Tech Naal º√°n√≠g√≠√≠ K√©yah)</i></b>",
                            location: "Navajo, NM",
                            googleCalendar: ""
                        };
                        addDoc(getCollectionRef(COLLECTIONS.SETTINGS), defaults);
                    }
                }
            });

            listen(COLLECTIONS.MEDIA, (data) => {
                appData.media = data;
                // Only pass visible items to the carousel
                const visibleMedia = data.filter(item => !item.hidden);
                renderCarousel('media', visibleMedia);
                renderAdminList('media', data);
            });
        }

        // --- Core Logic ---
        function updateUIConfig(settings) {
            if(settings.schoolName) els.schoolName.innerHTML = settings.schoolName;
            if(settings.subtitle) els.schoolSubtitle.innerHTML = settings.subtitle;
            if(settings.subtitle2) els.schoolSubtitle2.innerHTML = settings.subtitle2;
            if(settings.logo) {
                document.getElementById('header-logo').src = settings.logo;
            }
            
            // Updated: Set Header Background instead of Body Background
            const headerEl = document.getElementById('main-header');
            if(settings.headerBackground) {
                headerEl.style.backgroundImage = `url('${settings.headerBackground}')`;
                headerEl.style.backgroundSize = 'cover';
                headerEl.style.backgroundPosition = 'center';
            } else {
                headerEl.style.backgroundImage = ''; 
            }
            
            // Updated to populate WYSIWYG editors
            const confName = document.getElementById('editor-conf-name');
            const confSub = document.getElementById('editor-conf-subtitle');
            const confSub2 = document.getElementById('editor-conf-subtitle-2');
            
            if(confName) confName.innerHTML = settings.schoolName || "";
            if(confSub) confSub.innerHTML = settings.subtitle || "";
            if(confSub2) confSub2.innerHTML = settings.subtitle2 || "";

            els.confLocation.value = settings.location || "";
            els.confCalendar.value = settings.googleCalendar || "";
            
            // Populate PIN Field
            const pinField = document.getElementById('conf-admin-pin');
            if (pinField) pinField.value = settings.adminPin || "1234";
            
            if(settings.headerBackground) {
                document.getElementById('conf-header-bg-preview').src = settings.headerBackground;
            }
            
            // Call API functions
            fetchWeather(settings.location);
            fetchCalendar(settings.googleCalendar);
        }

        function mergeAndRenderEvents() {
            const all = [...appData.events, ...appData.externalEvents];
            // Sort by date
            all.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
            
            // Filter past events (keep today + future)
            const now = new Date();
            now.setHours(0,0,0,0);
            
            const upcoming = all.filter(e => {
                const eventDate = new Date(e.datetime);
                // Adjust for timezone to ensure we don't accidentally filter out today's event due to UTC diffs
                eventDate.setMinutes(eventDate.getMinutes() + eventDate.getTimezoneOffset());
                
                // --- Visibility Logic ---
                // 1. Scheduled Start: If set, hide until this date
                if (e.startDate) {
                    const visibleStart = new Date(e.startDate);
                    visibleStart.setMinutes(visibleStart.getMinutes() + visibleStart.getTimezoneOffset());
                    if (now < visibleStart) return false;
                }

                // 2. Scheduled End: If set, hide after this date. 
                // If NOT set, default to hiding after the actual Event Date.
                if (e.endDate) {
                    const visibleEnd = new Date(e.endDate);
                    visibleEnd.setMinutes(visibleEnd.getMinutes() + visibleEnd.getTimezoneOffset());
                    if (now > visibleEnd) return false;
                } else {
                    if (now > eventDate) return false;
                }

                return true;
            });

            if (upcoming.length === 0) {
                els.eventsList.innerHTML = `<p class="text-center text-gray-400 mt-4">No Upcoming Events</p>`;
                return;
            }

            els.eventsList.innerHTML = upcoming.map(e => {
                const d = new Date(e.datetime);
                // Fix for timezone offset
                d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
                
                // Calculate highlights
                const diffTime = d.getTime() - now.getTime();
                const daysUntil = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const isSoon = daysUntil >= 0 && daysUntil <= 3;

                const borderClass = isSoon ? 'border-red-600 bg-red-50' : 'border-school-navy bg-white';
                const dateColor = isSoon ? 'text-red-700' : 'text-school-navy';
                // Badge is now moved inside the date container, so we make it block-level and centered
                const badge = isSoon ? `<div class="bg-red-600 text-white text-[9px] px-1 py-0.5 rounded font-bold uppercase mt-1 animate-pulse leading-none inline-block">Soon</div>` : '';

                const month = d.toLocaleDateString([], {month:'short'});
                const day = d.toLocaleDateString([], {day:'numeric'});
                
                return `
                <div class="flex items-center p-3 rounded-lg shadow-sm mb-3 border-l-4 ${borderClass} transition-colors duration-300">
                    <div class="flex-none w-14 text-center flex flex-col items-center justify-center">
                        <div class="text-xs font-bold text-gray-500 uppercase leading-none">${month}</div>
                        <div class="text-xl font-bold ${dateColor} leading-none my-0.5">${day}</div>
                        ${badge}
                    </div>
                    <div class="ml-3 flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <h4 class="font-bold text-sm text-gray-800 leading-tight truncate">${e.title}</h4>
                        </div>
                        <p class="text-xs text-gray-500 truncate">${e.location || 'TBA'}</p>
                    </div>
                </div>`;
            }).join('');
        }

        // Carousel Logic
        const carousels = {
            student: { index: 0, timer: null, interval: 8000 },
            teacher: { index: 0, timer: null, interval: 10000 },
            announcement: { index: 0, timer: null, interval: 12000 },
            media: { index: 0, timer: null, interval: 15000 }
        };

        function extractYouTubeID(url) {
            let videoId = '';
            try {
                const u = new URL(url);
                if (u.hostname.includes('youtube.com')) {
                    if (u.searchParams.has('v')) videoId = u.searchParams.get('v');
                    else if (u.pathname.includes('/shorts/')) videoId = u.pathname.split('/shorts/')[1];
                    else if (u.pathname.includes('/live/')) videoId = u.pathname.split('/live/')[1]; // Added support for /live/ links
                    else if (u.pathname.includes('/embed/')) videoId = u.pathname.split('/embed/')[1];
                } else if (u.hostname.includes('youtu.be')) {
                    videoId = u.pathname.slice(1);
                }
            } catch(e) {}
            return videoId ? videoId.split('?')[0].split('&')[0] : null;
        }

        function renderCarousel(type, data) {
            const container = els[`${type}Carousel`];
            const progressBar = els[`${type}Progress`];
            const config = carousels[type];

            if (config.timer) { clearTimeout(config.timer); clearInterval(config.timer); }
            if (type === 'media' && window.currentMediaPlayer) { try { window.currentMediaPlayer.destroy(); } catch(e){} window.currentMediaPlayer = null; }

            if (!data || data.length === 0) {
                container.innerHTML = `<div class="w-full h-full flex items-center justify-center text-center text-gray-400">No content available</div>`;
                return;
            }
            if (config.index >= data.length) config.index = 0;

            const showSlide = () => {
                // Clear any running timer to prevent overlaps
                if (config.timer) clearTimeout(config.timer);
                
                // Cleanup previous media player if exists
                if (type === 'media' && window.currentMediaPlayer) { 
                    try { window.currentMediaPlayer.destroy(); } catch(e){} 
                    window.currentMediaPlayer = null; 
                }

                if (progressBar) { progressBar.style.transition = 'none'; progressBar.style.width = '0%'; }
                const item = data[config.index];
                container.innerHTML = `<div class="w-full h-full flex flex-col items-center justify-center opacity-0 transition-opacity duration-500 relative" id="${type}-slide-content"></div>`;
                const slide = document.getElementById(`${type}-slide-content`);
                
                const queueNext = (delay) => {
                    // Stop effect if there is only 1 item
                    if (data.length <= 1) {
                        if (progressBar) { 
                            progressBar.style.width = '0%'; 
                            progressBar.style.display = 'none'; // Hide bar
                        } 
                        return; // Stop recursion/timer
                    }

                    if (progressBar) { 
                        progressBar.style.display = 'block';
                        setTimeout(() => { progressBar.style.transition = `width ${delay}ms linear`; progressBar.style.width = '100%'; }, 50); 
                    }
                    config.timer = setTimeout(() => { config.index = (config.index + 1) % data.length; showSlide(); }, delay);
                };

                if (type === 'media' && item.type === 'youtube') {
                    slide.classList.remove('opacity-0'); 
                    let videoId = extractYouTubeID(item.content);
                    if (videoId && ytApiReady) {
                        const playerId = `yt-player-${Date.now()}`;
                        slide.innerHTML = `<div id="${playerId}" style="width:100%; height:100%;"></div>`;
                        
                        const origin = window.location.protocol.startsWith('http') ? window.location.origin : undefined;

                        window.currentMediaPlayer = new YT.Player(playerId, {
                            height: '100%', width: '100%', videoId: videoId,
                            playerVars: { 
                                'autoplay': 1, 
                                'controls': 0, 
                                'rel': 0, 
                                'showinfo': 0, 
                                'modestbranding': 1, 
                                'mute': 0, 
                                'origin': origin, 
                                'enablejsapi': 1,
                                'iv_load_policy': 3 // Removes video annotations/popups
                            },
                            events: {
                                'onReady': (event) => { event.target.playVideo(); },
                                // event.data === 0 is YT.PlayerState.ENDED.
                                'onStateChange': (event) => { 
                                    if (event.data === 0) { 
                                        if (data.length > 1) {
                                            // Normal rotation
                                            config.index = (config.index + 1) % data.length; 
                                            showSlide(); 
                                        } else {
                                            // Single video loop - replay without reloading player
                                            event.target.playVideo();
                                        }
                                    } 
                                },
                                'onError': (e) => { 
                                    console.warn("Skipping restricted/unavailable video."); 
                                    slide.innerHTML = `<div class="flex items-center justify-center h-full text-white bg-black"><p>Video Unavailable</p></div>`; 
                                    queueNext(3000); 
                                }
                            }
                        });
                        // Fallback timer: Only set if we have multiple items to rotate through
                        if (data.length > 1) {
                            config.timer = setTimeout(() => { config.index = (config.index + 1) % data.length; showSlide(); }, 600000); 
                        }
                    } else {
                        slide.innerHTML = `<p class="text-red-500">Video Loading...</p>`;
                        if (!ytApiReady) setTimeout(showSlide, 1000); else queueNext(5000);
                    }
                } else if (type === 'media' && item.type === 'facebook') {
                    slide.innerHTML = item.content.includes('<iframe') ? item.content : `<div class="flex items-center justify-center h-full text-red-500 font-bold">Invalid Embed Code</div>`;
                    const fbFrame = slide.querySelector('iframe');
                    if (fbFrame) { fbFrame.style.width = '100%'; fbFrame.style.height = '100%'; }
                    setTimeout(() => slide.classList.remove('opacity-0'), 50);
                    queueNext(config.interval);
                } else {
                    // Standard content
                    if (type === 'media' && item.type === 'image') {
                         slide.innerHTML = `<img src="${item.content}" class="w-full h-full object-cover">`;
                    } else if (type === 'student') {
                        // Removed inner px-4 to allow content to fit container width fully
                        slide.innerHTML = `
                            <div class="flex flex-row items-center w-full h-full gap-3">
                                <div class="flex-none w-32 h-32 md:w-40 md:h-40 rounded-full border-4 border-school-gold overflow-hidden shadow-lg bg-gray-200 ml-2">
                                    <img src="${item.image || 'https://placehold.co/200?text=Student'}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/200?text=No+Img'">
                                </div>
                                <div class="flex-1 flex flex-col items-start justify-center text-left min-w-0 pr-2">
                                    <h3 class="text-2xl font-bold text-school-navy mb-1 leading-tight">${item.name}</h3>
                                    <span class="bg-school-gold text-school-navy px-3 py-1 rounded-full text-sm font-bold mb-3">${item.focus || 'Student'}</span>
                                    <p class="text-gray-600 italic line-clamp-4 text-sm md:text-base">"${item.description}"</p>
                                </div>
                            </div>
                        `;
                    } else if (type === 'teacher') {
                        // Removed inner px-4
                        slide.innerHTML = `
                            <div class="flex flex-row items-center w-full h-full gap-3">
                                <div class="flex-none w-32 h-32 md:w-40 md:h-40 rounded-full border-4 border-school-navy overflow-hidden shadow-lg bg-gray-200 ml-2">
                                    <img src="${item.image || 'https://placehold.co/200?text=Staff'}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/200?text=No+Img'">
                                </div>
                                <div class="flex-1 text-left min-w-0 pr-2">
                                    <h3 class="text-2xl font-bold text-gray-800 leading-tight">${item.name}</h3>
                                    <div class="text-school-navy font-bold uppercase tracking-wide text-sm mb-2">${item.dept}</div>
                                    <p class="text-gray-600 text-sm line-clamp-5 border-l-4 border-school-gold pl-3">${item.bio}</p>
                                </div>
                            </div>
                        `;
                    } else if (type === 'announcement') {
                        const isImg = item.image && item.image.length > 50; 
                        // Apply red border if urgent
                        const urgentClasses = item.urgent ? 'border-4 border-red-600 rounded-xl bg-red-50' : '';
                        
                        // Removed inner px-4
                        slide.innerHTML = `
                            <div class="flex flex-row items-center w-full h-full gap-4 relative ${urgentClasses} overflow-hidden">
                                ${isImg ? 
                                    `<div class="flex-none w-1/3 h-full flex items-center justify-center p-1">
                                        <img src="${item.image}" class="w-full h-full rounded-lg shadow-sm object-contain">
                                     </div>` : 
                                    `<div class="flex-none w-24 flex items-center justify-center text-school-gold ml-2">
                                        <i class="fas fa-bullhorn fa-4x"></i>
                                     </div>`
                                }
                                <div class="flex-1 flex flex-col justify-center text-left min-w-0 pr-2">
                                    <h3 class="text-xl md:text-2xl font-bold text-school-navy mb-2 leading-tight">${item.title}</h3>
                                    <div class="h-1 w-20 bg-school-gold mb-3"></div>
                                    <p class="text-gray-700 text-sm md:text-lg line-clamp-5">${item.description}</p>
                                </div>
                                ${item.urgent ? '<span class="absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-bl-lg uppercase animate-pulse">Urgent</span>' : ''}
                            </div>
                        `;
                    }
                    setTimeout(() => slide.classList.remove('opacity-0'), 50);
                    queueNext(config.interval);
                }
            };
            showSlide();
        }

        // --- Admin Interface ---
        window.formatText = (identifier, tag) => {
            let textarea = document.querySelector(`textarea[name="${identifier}"]`);
            if (!textarea) textarea = document.getElementById(identifier);
            if (!textarea) return;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            textarea.value = text.substring(0, start) + `<${tag}>` + text.substring(start, end) + `</${tag}>` + text.substring(end);
            textarea.focus();
        };

        window.toggleAdminModal = () => { document.getElementById('admin-modal').classList.toggle('hidden'); };

        window.switchTab = (tabId) => {
            document.querySelectorAll('.admin-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.admin-tab-btn').forEach(el => {
                el.classList.remove('bg-white', 'shadow-sm', 'border-l-4', 'border-school-navy', 'text-school-navy');
                el.classList.add('border-transparent');
            });
            document.getElementById(tabId).classList.remove('hidden');
            const btn = Array.from(document.querySelectorAll('.admin-tab-btn')).find(b => b.getAttribute('onclick').includes(tabId));
            if(btn) {
                btn.classList.add('bg-white', 'shadow-sm', 'border-l-4', 'border-school-navy', 'text-school-navy');
                btn.classList.remove('border-transparent');
            }
        };

        window.saveConfig = async () => {
            showLoader();
            try {
                const logoFile = document.getElementById('conf-logo-file').files[0];
                let logoBase64 = appData.settings?.logo || "";
                if (logoFile) { 
                    try { 
                        // Compress logo to max 500px width
                        logoBase64 = await processAndCompressImage(logoFile, 500); 
                    } catch (err) { 
                        console.error(err);
                        alert("Logo Error: " + err.message);
                        hideLoader();
                        return;
                    } 
                }

                // Handle Header background image upload
                const headerBgFile = document.getElementById('conf-header-bg-file').files[0];
                let headerBgBase64 = appData.settings?.headerBackground || "";
                if (headerBgFile) { 
                    try { 
                        // Compress header to max 1280px width
                        headerBgBase64 = await processAndCompressImage(headerBgFile, 1280); 
                    } catch (err) { 
                        console.error(err);
                        alert("Header Image Error: " + err.message);
                        hideLoader();
                        return;
                    } 
                }
                
                // Get data from WYSIWYG editors
                const conf = {
                    schoolName: document.getElementById('editor-conf-name').innerHTML,
                    subtitle: document.getElementById('editor-conf-subtitle').innerHTML,
                    subtitle2: document.getElementById('editor-conf-subtitle-2').innerHTML,
                    location: els.confLocation.value,
                    googleCalendar: els.confCalendar.value,
                    logo: logoBase64,
                    headerBackground: headerBgBase64,
                    adminPin: document.getElementById('conf-admin-pin').value || "1234" // Save PIN
                };
                if (appData.settingsId) await updateDoc(doc(getCollectionRef(COLLECTIONS.SETTINGS), appData.settingsId), conf);
                else await addDoc(getCollectionRef(COLLECTIONS.SETTINGS), conf);
            } catch(e) { console.error(e); alert("Error saving config."); }
            hideLoader();
        };

        function showLoader() { document.getElementById('global-loader').classList.remove('hidden'); }
        function hideLoader() { document.getElementById('global-loader').classList.add('hidden'); }

        // Function to toggle visibility directly from list
        window.toggleVisibility = async (type, id, currentHiddenState) => {
            showLoader();
            try {
                await updateDoc(doc(getCollectionRef(type), id), { hidden: !currentHiddenState });
            } catch(e) { console.error(e); alert("Error updating visibility."); }
            hideLoader();
        };

        // Function to move item up or down in the list
        window.moveItem = async (type, id, direction) => {
            showLoader();
            try {
                const collectionData = [...appData[type]];
                // Ensure items have an order property
                collectionData.forEach((item, index) => {
                    if (item.order === undefined) item.order = index;
                });
                
                // Sort by current order to be safe
                collectionData.sort((a, b) => a.order - b.order);

                const currentIndex = collectionData.findIndex(item => item.id === id);
                if (currentIndex === -1) { hideLoader(); return; }

                const targetIndex = currentIndex + direction; // -1 for up, +1 for down

                // Check bounds
                if (targetIndex < 0 || targetIndex >= collectionData.length) {
                    hideLoader();
                    return;
                }

                // Swap order values
                const currentItem = collectionData[currentIndex];
                const targetItem = collectionData[targetIndex];

                const tempOrder = currentItem.order;
                currentItem.order = targetItem.order;
                targetItem.order = tempOrder;

                // Update both documents in Firestore
                await updateDoc(doc(getCollectionRef(type), currentItem.id), { order: currentItem.order });
                await updateDoc(doc(getCollectionRef(type), targetItem.id), { order: targetItem.order });

            } catch(e) { console.error(e); alert("Error moving item."); }
            hideLoader();
        };

        function renderAdminList(type, data) {
            const container = els[`admin${type.charAt(0).toUpperCase() + type.slice(1)}`];
            if (!container) return;
            if (data.length === 0) { container.innerHTML = `<p class="text-gray-500 italic col-span-3">No items found.</p>`; return; }
            
            const now = new Date();
            now.setHours(0,0,0,0);

            container.innerHTML = data.map((item, index) => {
                let mainText = item.title || item.name || item.text;
                let subText = item.description || item.dept || item.datetime || '';
                let img = item.image;
                let statusBadge = '';

                // Content specific formatting
                if (type === 'announcements') {
                    // Calculate Schedule Status
                    let isExpired = false;
                    let isScheduled = false;

                    if (item.endDate) {
                        const end = new Date(item.endDate);
                        end.setMinutes(end.getMinutes() + end.getTimezoneOffset());
                        if (end < now) isExpired = true;
                    }
                    
                    if (item.startDate && !isExpired) {
                        const start = new Date(item.startDate);
                        start.setMinutes(start.getMinutes() + start.getTimezoneOffset());
                        if (start > now) isScheduled = true;
                    }

                    if (isExpired) {
                        statusBadge = '<span class="bg-red-100 text-red-800 text-[10px] px-1.5 py-0.5 rounded uppercase font-bold tracking-wider ml-2">Expired</span>';
                    } else if (isScheduled) {
                        statusBadge = '<span class="bg-yellow-100 text-yellow-800 text-[10px] px-1.5 py-0.5 rounded uppercase font-bold tracking-wider ml-2">Scheduled</span>';
                    } else {
                        statusBadge = '<span class="bg-green-100 text-green-800 text-[10px] px-1.5 py-0.5 rounded uppercase font-bold tracking-wider ml-2">Active</span>';
                    }
                }
                else if (type === 'ticker') { 
                    const tmp = document.createElement("DIV"); 
                    tmp.innerHTML = mainText; 
                    mainText = tmp.textContent || tmp.innerText || ""; 
                    subText = "Ticker Message"; 
                } 
                else if (type === 'media') { 
                    mainText = item.type.toUpperCase() + ' Media'; 
                    subText = item.content ? item.content.substring(0, 40) + '...' : 'No Content'; 
                    if (item.type === 'image') img = item.content; 
                } else if (type === 'events') {
                    // Format date for better readability in list
                    if (item.datetime) {
                        const dateObj = new Date(item.datetime);
                        // Fix timezone offset for display
                        dateObj.setMinutes(dateObj.getMinutes() + dateObj.getTimezoneOffset());
                        subText = dateObj.toLocaleDateString() + (item.location ? ` - ${item.location}` : '');
                    }

                    // --- Event Status Logic ---
                    let isExpired = false;
                    let isScheduled = false;
                    const eventDate = new Date(item.datetime);
                    eventDate.setMinutes(eventDate.getMinutes() + eventDate.getTimezoneOffset());

                    // Check Start Date
                    if (item.startDate) {
                        const start = new Date(item.startDate);
                        start.setMinutes(start.getMinutes() + start.getTimezoneOffset());
                        if (start > now) isScheduled = true;
                    }

                    // Check End Date (Explicit or Default to Event Date)
                    if (item.endDate) {
                        const end = new Date(item.endDate);
                        end.setMinutes(end.getMinutes() + end.getTimezoneOffset());
                        if (end < now) isExpired = true;
                    } else {
                        if (eventDate < now) isExpired = true;
                    }

                    if (isExpired) {
                        statusBadge = '<span class="bg-red-100 text-red-800 text-[10px] px-1.5 py-0.5 rounded uppercase font-bold tracking-wider ml-2">Expired</span>';
                    } else if (isScheduled) {
                        statusBadge = '<span class="bg-yellow-100 text-yellow-800 text-[10px] px-1.5 py-0.5 rounded uppercase font-bold tracking-wider ml-2">Scheduled</span>';
                    } else {
                        statusBadge = '<span class="bg-green-100 text-green-800 text-[10px] px-1.5 py-0.5 rounded uppercase font-bold tracking-wider ml-2">Active</span>';
                    }
                }
                
                // Visual indicator for hidden items
                const hiddenClass = item.hidden ? 'opacity-60 bg-gray-50' : '';
                const hiddenIcon = item.hidden ? 'fa-eye-slash text-gray-500' : 'fa-eye text-green-600';
                const hiddenTitle = item.hidden ? 'Show in Feed' : 'Hide from Feed';

                // Visibility Toggle Button (Universal for all types)
                const visibilityButton = `
                    <button onclick="toggleVisibility('${type}', '${item.id}', ${item.hidden || false})" class="${hiddenIcon} hover:text-gray-800" title="${hiddenTitle}">
                        <i class="fas ${hiddenIcon}"></i>
                    </button>
                `;

                // Order Buttons
                const upButton = index > 0 ? `
                    <button onclick="moveItem('${type}', '${item.id}', -1)" class="text-gray-500 hover:text-school-navy" title="Move Up">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                ` : `<span class="w-4"></span>`; // Spacer

                const downButton = index < data.length - 1 ? `
                    <button onclick="moveItem('${type}', '${item.id}', 1)" class="text-gray-500 hover:text-school-navy" title="Move Down">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                ` : `<span class="w-4"></span>`; // Spacer

                return `
                <div class="bg-white p-4 rounded-lg shadow border border-gray-200 flex justify-between items-start group ${hiddenClass}">
                    <div class="flex items-start space-x-3 overflow-hidden">
                        ${img ? `<img src="${img}" class="w-10 h-10 rounded-full object-cover border">` : ''}
                        <div class="min-w-0">
                            <div class="flex items-center space-x-2">
                                <h4 class="font-bold text-gray-800 truncate text-sm">${mainText}</h4>
                                ${statusBadge}
                                ${item.hidden ? '<span class="bg-gray-200 text-gray-600 text-[10px] px-1.5 py-0.5 rounded uppercase font-bold tracking-wider">Hidden</span>' : ''}
                            </div>
                            <p class="text-xs text-gray-500 truncate">${subText || ''}</p>
                        </div>
                    </div>
                    <div class="flex space-x-3 opacity-0 group-hover:opacity-100 transition-opacity items-center">
                        <!-- Order Controls -->
                        <div class="flex flex-col space-y-1 items-center mr-2">
                            ${upButton}
                            ${downButton}
                        </div>
                        <div class="h-8 w-px bg-gray-200 mx-1"></div>
                        
                        ${visibilityButton}
                        <button onclick="editEntry('${type}', '${item.id}')" class="text-blue-600 hover:text-blue-800" title="Edit"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteEntry('${type}', '${item.id}')" class="text-red-600 hover:text-red-800" title="Delete"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }).join('');
        }

        let currentEditType = null;
        let currentEditId = null;
        // Global variable to track the last focused editor for emoji insertion
        let lastFocusedEditor = null;

        // --- Emoji Picker Logic ---
        const COMMON_EMOJIS = [
            'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá',
            'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö',
            'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü§©',
            'ü•≥', 'üòè', 'üòí', 'üòû', 'üòî', 'wwüòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£',
            'üòñ', 'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†', 'üò°', 'ü§¨',
            'ü§Ø', 'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®', 'woüò∞', 'üò•', 'üòì', 'ü§ó',
            'ü§î', 'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ', 'üòØ',
            'üò¶', 'üòß', 'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê',
            'ü•¥', 'ü§¢', 'ü§Æ', 'sneezing_face', 'üò∑', 'ü§í', 'ü§ï', 'ü§ë', 'ü§†',
            'üòà', 'üëø', 'ghoul', 'ü§°', 'üí©', 'üëª', 'üíÄ', '‚ò†Ô∏è', 'üëΩ', 'üëæ',
            'ü§ñ', 'üéÉ', 'üò∫', 'üò∏', 'üòπ', 'üòª', 'üòº', 'üòΩ', 'üôÄ', 'üòø',
            'üòæ', 'üëã', 'ü§ö', 'üñê', '‚úã', 'üññ', 'üëå', 'ü§è', '‚úåÔ∏è', 'ü§û',
            'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ', 'üëÜ', 'üñï', 'üëá', '‚òùÔ∏è', 'üëç',
            'üëé', '‚úä', 'üëä', 'ü§õ', 'ü§ú', 'üëè', 'üôå', 'üëê', 'ü§≤', 'ü§ù',
            'üôè', '‚úçÔ∏è', 'üíÖ', 'ü§≥', 'üí™', 'ü¶æ', 'ü¶ø', 'ü¶µ', 'ü¶∂', 'üëÇ',
            'ü¶ª', 'üëÉ', 'üß†', 'ü´Ä', 'ü´Å', 'ü¶∑', 'ü¶¥', 'üëÄ', 'üëÅ', 'üëÖ',
            'üëÑ', 'üíã', 'ü©∏', 'üë∂', 'üëß', 'üßí', 'üë¶', 'üë©', 'üßë', 'üë®',
            'üë©‚Äçü¶±', 'üßë‚Äçü¶±', 'üë®‚Äçü¶±', 'üë©‚Äçü¶∞', 'üßë‚Äçü¶∞', 'üë®‚Äçü¶∞', 'üë±‚Äç‚ôÄÔ∏è', 'üë±', 'üë±‚Äç‚ôÇÔ∏è', 'üë©‚Äçü¶≥',
            'üßë‚Äçü¶≥', 'üë®‚Äçü¶≥', 'üë©‚Äçü¶≤', 'üßë‚Äçü¶≤', 'üë®‚Äçü¶≤', 'üßî', 'üëµ', 'üßì', 'üë¥', 'üë≤',
            'üë≥‚Äç‚ôÄÔ∏è', 'üë≥', 'üë≥‚Äç‚ôÇÔ∏è', 'üßï', 'üëÆ‚Äç‚ôÄÔ∏è', 'üëÆ', 'üëÆ‚Äç‚ôÇÔ∏è', 'üë∑‚Äç‚ôÄÔ∏è', 'üë∑', 'üë∑‚Äç‚ôÇÔ∏è',
            'üíÇ‚Äç‚ôÄÔ∏è', 'üíÇ', 'üíÇ‚Äç‚ôÇÔ∏è', 'üïµÔ∏è‚Äç‚ôÄÔ∏è', 'üïµ', 'üïµÔ∏è‚Äç‚ôÇÔ∏è', 'üë©‚Äç‚öïÔ∏è', 'üßë‚Äç‚öïÔ∏è', 'üë®‚Äç‚öïÔ∏è', 'üë©‚Äçüåæ',
            'üßë‚Äçüåæ', 'üë®‚Äçüåæ', 'üë©‚Äçüç≥', 'üßë‚Äçüç≥', 'üë®‚Äçüç≥', 'üë©‚Äçüéì', 'üßë‚Äçüéì', 'üë®‚Äçüéì', 'üë©‚Äçüé§', 'üßë‚Äçüé§',
            'üë®‚Äçüé§', 'üë©‚Äçüè´', 'üßë‚Äçüè´', 'üë®‚Äçüè´', 'üë©‚Äçüè≠', 'üßë‚Äçüè≠', 'üë®‚Äçüè≠', 'üë©‚Äçüíª', 'üßë‚Äçüíª', 'üë®‚Äçüíª',
            'üë©‚Äçüíº', 'üßë‚Äçüíº', 'üë®‚Äçüíº', 'üë©‚Äçüîß', 'üßë‚Äçüîß', 'üë®‚Äçüîß', 'üë©‚Äçüî¨', 'üßë‚Äçüî¨', 'üë®‚Äçüî¨', 'üë©‚Äçüé®',
            'üßë‚Äçüé®', 'üë®‚Äçüé®', 'üë©‚Äçüöí', 'üßë‚Äçüöí', 'üë®‚Äçüöí', 'üë©‚Äç‚úàÔ∏è', 'üßë‚Äç‚úàÔ∏è', 'üë®‚Äç‚úàÔ∏è', 'üë©‚ÄçüöÄ', 'üßë‚ÄçüöÄ',
            'üë®‚ÄçüöÄ', 'üë©‚Äç‚öñÔ∏è', 'üßë‚Äç‚öñÔ∏è', 'üë®‚Äç‚öñÔ∏è', 'üë∞', 'ü§µ', 'üë∏', 'ü§¥', 'ü¶∏‚Äç‚ôÄÔ∏è', 'ü¶∏',
            'ü¶∏‚Äç‚ôÇÔ∏è', 'ü¶π‚Äç‚ôÄÔ∏è', 'ü¶π', 'ü¶π‚Äç‚ôÇÔ∏è', 'ü§∂', 'üéÖ', 'üßô‚Äç‚ôÄÔ∏è', 'üßô', 'üßô‚Äç‚ôÇÔ∏è', 'üßù‚Äç‚ôÄÔ∏è',
            'üßù', 'üßù‚Äç‚ôÇÔ∏è', 'üßõ‚Äç‚ôÄÔ∏è', 'üßõ', 'üßõ‚Äç‚ôÇÔ∏è', 'üßü‚Äç‚ôÄÔ∏è', 'üßü', 'üßü‚Äç‚ôÇÔ∏è', 'üßû‚Äç‚ôÄÔ∏è', 'üßû',
            'üßû‚Äç‚ôÇÔ∏è', 'üßú‚Äç‚ôÄÔ∏è', 'üßú', 'üßú‚Äç‚ôÇÔ∏è', 'üßö‚Äç‚ôÄÔ∏è', 'üßö', 'üßö‚Äç‚ôÇÔ∏è', 'üëº', 'ü§∞', 'ü§±',
            'üôá‚Äç‚ôÄÔ∏è', 'üôá', 'üôá‚Äç‚ôÇÔ∏è', 'üíÅ‚Äç‚ôÄÔ∏è', 'üíÅ', 'üíÅ‚Äç‚ôÇÔ∏è', 'üôÖ‚Äç‚ôÄÔ∏è', 'üôÖ', 'üôÖ‚Äç‚ôÇÔ∏è', 'üôÜ‚Äç‚ôÄÔ∏è',
            'üôÜ', 'üôÜ‚Äç‚ôÇÔ∏è', 'üôã‚Äç‚ôÄÔ∏è', 'üôã', 'üôã‚Äç‚ôÇÔ∏è', 'üßè‚Äç‚ôÄÔ∏è', 'üßè', 'üßè‚Äç‚ôÇÔ∏è', 'ü§¶‚Äç‚ôÄÔ∏è', 'ü§¶',
            'ü§¶‚Äç‚ôÇÔ∏è', 'ü§∑‚Äç‚ôÄÔ∏è', 'ü§∑', 'ü§∑‚Äç‚ôÇÔ∏è', 'üôé‚Äç‚ôÄÔ∏è', 'üôé', 'üôé‚Äç‚ôÇÔ∏è', 'üôç‚Äç‚ôÄÔ∏è', 'üôç', 'üôç‚Äç‚ôÇÔ∏è',
            'üíá‚Äç‚ôÄÔ∏è', 'üíá', 'üíá‚Äç‚ôÇÔ∏è', 'üíÜ‚Äç‚ôÄÔ∏è', 'üíÜ', 'üíÜ‚Äç‚ôÇÔ∏è', 'üßñ‚Äç‚ôÄÔ∏è', 'üßñ', 'üßñ‚Äç‚ôÇÔ∏è', 'üíÖ',
            'ü§≥', 'üíÉ', 'üï∫', 'üëØ‚Äç‚ôÄÔ∏è', 'üëØ', 'üëØ‚Äç‚ôÇÔ∏è', 'üï¥', 'üë©‚Äçü¶Ω', 'üßë‚Äçü¶Ω', 'üë®‚Äçü¶Ω',
            'üë©‚Äçü¶º', 'üßë‚Äçü¶º', 'üë®‚Äçü¶º', 'üö∂‚Äç‚ôÄÔ∏è', 'üö∂', 'üö∂‚Äç‚ôÇÔ∏è', 'üë©‚Äçü¶Ø', 'üßë‚Äçü¶Ø', 'üë®‚Äçü¶Ø', 'üßé‚Äç‚ôÄÔ∏è',
            'üßé', 'üßé‚Äç‚ôÇÔ∏è', 'üèÉ‚Äç‚ôÄÔ∏è', 'üèÉ', 'üèÉ‚Äç‚ôÇÔ∏è', 'üßç‚Äç‚ôÄÔ∏è', 'üßç', 'üßç‚Äç‚ôÇÔ∏è', 'üë≠', 'üßë‚Äçü§ù‚Äçüßë',
            'üë¨', 'üë´', 'üßó‚Äç‚ôÄÔ∏è', 'üßó', 'üßó‚Äç‚ôÇÔ∏è', 'ü§∫', 'üèá', '‚õ∑', 'üèÇ', 'üèåÔ∏è‚Äç‚ôÄÔ∏è',
            'üèåÔ∏è', 'üèåÔ∏è‚Äç‚ôÇÔ∏è', 'üèÑ‚Äç‚ôÄÔ∏è', 'üèÑ', 'üèÑ‚Äç‚ôÇÔ∏è', 'üö£‚Äç‚ôÄÔ∏è', 'üö£', 'üö£‚Äç‚ôÇÔ∏è', 'üèä‚Äç‚ôÄÔ∏è', 'üèä',
            'üèä‚Äç‚ôÇÔ∏è', '‚õπÔ∏è‚Äç‚ôÄÔ∏è', '‚õπÔ∏è', '‚õπÔ∏è‚Äç‚ôÇÔ∏è', 'üèãÔ∏è‚Äç‚ôÄÔ∏è', 'üèã', 'üèãÔ∏è‚Äç‚ôÇÔ∏è', 'üö¥‚Äç‚ôÄÔ∏è', 'üö¥', 'üö¥‚Äç‚ôÇÔ∏è',
            'üöµ‚Äç‚ôÄÔ∏è', 'üöµ', 'üöµ‚Äç‚ôÇÔ∏è', 'ü§∏‚Äç‚ôÄÔ∏è', 'ü§∏', 'ü§∏‚Äç‚ôÇÔ∏è', 'ü§º‚Äç‚ôÄÔ∏è', 'ü§º', 'ü§º‚Äç‚ôÇÔ∏è', 'ü§Ω‚Äç‚ôÄÔ∏è',
            'ü§Ω', 'ü§Ω‚Äç‚ôÇÔ∏è', 'ü§æ‚Äç‚ôÄÔ∏è', 'ü§æ', 'ü§æ‚Äç‚ôÇÔ∏è', 'ü§π‚Äç‚ôÄÔ∏è', 'ü§π', 'ü§π‚Äç‚ôÇÔ∏è', 'üßò‚Äç‚ôÄÔ∏è', 'üßò',
            'üßò‚Äç‚ôÇÔ∏è', 'üõÄ', 'üõå', 'üë≠', 'üßë‚Äçü§ù‚Äçüßë', 'üë¨', 'üë´', 'üíè', 'üíë', 'üë™',
            'üó£', 'üë§', 'üë•', 'ü´Ç', 'üë£', 'ü¶∞', 'ü¶±', 'ü¶≥', 'ü¶≤', 'üêµ',
            'üêí', 'ü¶ç', 'ü¶ß', 'üê∂', 'üêï', 'ü¶Æ', 'üêï‚Äçü¶∫', 'üê©', 'üê∫', 'ü¶ä',
            'ü¶ù', 'üê±', 'üêà', 'üêà‚Äç‚¨õ', 'ü¶Å', 'üêØ', 'üêÖ', 'üêÜ', 'üê¥', 'üêé',
            'ü¶Ñ', 'ü¶ì', 'ü¶å', 'üêÆ', 'üêÇ', 'üêÉ', 'üêÑ', 'üê∑', 'üêñ', 'üêó',
            'üêΩ', 'üêè', 'üêë', 'üêê', 'üê™', 'üê´', 'ü¶ô', 'ü¶í', 'üêò', 'ü¶è',
            'ü¶õ', 'üê≠', 'üêÅ', 'üêÄ', 'üêπ', 'üê∞', 'üêá', 'üêø', 'ü¶î', 'ü¶á',
            'üêª', 'üê®', 'üêº', 'ü¶•', 'ü¶¶', 'ü¶®', 'ü¶ò', 'ü¶°', 'üêæ', 'ü¶É',
            'üêî', 'üêì', 'üê£', 'üê§', 'üê•', 'üê¶', 'üêß', 'üïä', 'ü¶Ö', 'ü¶Ü',
            'ü¶¢', 'ü¶â', 'ü¶©', 'ü¶ö', 'ü¶ú', 'üê∏', 'üêä', 'üê¢', 'ü¶é', 'üêç',
            'üê≤', 'üêâ', 'ü¶ï', 'ü¶ñ', 'üê≥', 'üêã', 'üê¨', 'üêü', 'üê†', 'üê°',
            'ü¶à', 'üêô', 'üêö', 'üêå', 'ü¶ã', 'üêõ', 'üêú', 'üêù', 'üêû', 'ü¶ó',
            'üï∑', 'üï∏', 'ü¶Ç', 'ü¶ü', 'ü¶†', 'üíê', 'üå∏', 'üíÆ', 'üèµ', 'üåπ',
            'ü•Ä', 'üå∫', 'üåª', 'üåº', 'üå∑', 'üå±', 'ü™¥', 'üå≤', 'üå≥', 'üå¥',
            'üåµ', 'üåæ', 'üåø', '‚òòÔ∏è', 'üçÄ', 'üçÅ', 'üçÇ', 'üçÉ', 'üçá', 'üçà',
            'üçâ', 'üçä', 'üçã', 'üçå', 'üçç', 'ü•≠', 'üçé', 'üçè', 'üçê', 'üçë',
            'üçí', 'üçì', 'ü•ù', 'üçÖ', 'ü••', 'ü•ë', 'üçÜ', 'ü•î', 'ü•ï', 'üåΩ',
            'üå∂', 'ü•í', 'ü•¨', 'ü•¶', 'üßÑ', 'üßÖ', 'üçÑ', 'ü•ú', 'üå∞', 'üçû',
            'ü•ê', 'ü•ñ', 'ü•®', 'ü•Ø', 'ü•û', 'üßá', 'üßÄ', 'üçñ', 'üçó', 'ü•©',
            'ü•ì', 'üçî', 'üçü', 'üçï', 'üå≠', 'ü•™', 'üåÆ', 'üåØ', 'ü•ô', 'üßÜ',
            'ü•ö', 'üç≥', 'ü•ò', 'üç≤', 'ü•£', 'ü•ó', 'üçø', 'üßà', 'üßÇ', 'ü•´',
            'üç±', 'üçò', 'üçô', 'üçö', 'üçõ', 'üçú', 'üçù', 'üç†', 'üç¢', 'üç£',
            'üç§', 'üç•', 'ü•Æ', 'üç°', 'ü•ü', 'ü•†', 'ü•°', 'ü¶Ä', 'ü¶û', 'ü¶ê',
            'ü¶ë', 'ü¶™', 'üç¶', 'üçß', 'üç®', 'üç©', 'üç™', 'üéÇ', 'üç∞', 'üßÅ',
            'ü•ß', 'üç´', 'üç¨', 'üç≠', 'üçÆ', 'üçØ', 'üçº', 'ü•õ', '‚òï', 'üçµ',
            'üç∂', 'üçæ', 'üç∑', 'üç∏', 'üçπ', 'üç∫', 'üçª', 'ü•Ç', 'ü•É', 'ü•§',
            'üßÉ', 'üßâ', 'üßä', 'ü•¢', 'üçΩ', 'üç¥', 'ü•Ñ', 'üî™', 'üè∫', 'üåç',
            'üåé', 'üåè', 'üåê', 'üó∫', 'üóæ', 'üß≠', 'üèî', '‚õ∞', 'üåã', 'üóª',
            'üèï', 'üèñ', 'üèú', 'üèù', 'üèû', 'üèü', 'üèõ', 'üèó', 'üß±', 'üèò',
            'üèö', 'üè†', 'üè°', 'üè¢', 'üè£', 'üè§', 'üè•', 'üè¶', 'üè®', 'üè©',
            'üè™', 'üè´', 'üè¨', 'üè≠', 'üèØ', 'üè∞', 'üíí', 'üóº', 'üóΩ', '‚õ™',
            'üïå', 'üõï', 'üïç', '‚õ©', 'üïã', '‚õ≤', '‚õ∫', 'üåÅ', 'üåÉ', 'üèô',
            'üåÑ', 'üåÖ', 'üåÜ', 'üåá', 'üåâ', '‚ô®Ô∏è', 'üé†', 'üé°', 'üé¢', 'üíà',
            'üé™', 'üöÇ', 'üöÉ', 'üöÑ', 'üöÖ', 'üöÜ', 'üöá', 'üöà', 'üöâ', 'üöä',
            'üöù', 'üöû', 'üöã', 'üöå', 'üöç', 'üöé', 'üöê', 'üöë', 'üöí', 'üöì',
            'üöî', 'üöï', 'üöñ', 'üöó', 'üöò', 'üöô', 'üöö', 'üöõ', 'üöú', 'üèé',
            'üèç', 'üõµ', 'ü¶Ω', 'ü¶º', 'üõ∫', 'üö≤', 'üõ¥', 'üõπ', 'üöè', 'üõ£',
            'üõ§', 'üõ¢', '‚õΩ', 'üö®', 'üö•', 'üö¶', 'üõë', 'üöß', '‚öì', '‚õµ',
            'üõ∂', 'üö§', 'üõ≥', '‚õ¥', 'üõ•', 'üö¢', '‚úàÔ∏è', 'üõ©', 'üõ´', 'üõ¨',
            'ü™Ç', 'üí∫', 'üöÅ', 'üöü', 'üö†', 'üö°', 'üõ∞', 'üöÄ', 'üõ∏', 'üõé',
            'üß≥', '‚åõ', '‚è≥', '‚åö', '‚è∞', '‚è±', '‚è≤', 'üï∞', 'üïõ', 'üïß',
            'üïê', 'üïú', 'üïë', 'üïù', 'üïí', 'üïû', 'üïì', 'üïü', 'üïî', 'üï†',
            'üïï', 'üï°', 'üïñ', 'üï¢', 'üïó', 'üï£', 'üïò', 'üï§', 'üïô', 'üï•',
            'üïö', 'üï¶', 'üåë', 'üåí', 'üåì', 'üåî', 'üåï', 'üåñ', 'üåó', 'üåò',
            'üåô', 'üåö', 'üåõ', 'üåú', 'üå°', '‚òÄÔ∏è', 'üåù', 'üåû', 'ü™ê', '‚≠ê',
            'üåü', 'üå†', 'üåå', '‚òÅÔ∏è', '‚õÖ', '‚õà', 'üå§', 'üå•', 'üå¶', 'üåß',
            'üå®', 'üå©', 'üå™', 'üå´', 'üå¨', 'üåÄ', 'üåà', 'üåÇ', '‚òÇÔ∏è', '‚òî',
            '‚õ±', '‚ö°', '‚ùÑÔ∏è', '‚òÉÔ∏è', '‚õÑ', '‚òÑÔ∏è', 'üî•', 'üíß', 'üåä', 'üéÉ',
            'üéÑ', 'üéÜ', 'üéá', 'üß®', '‚ú®', 'üéà', 'üéâ', 'üéä', 'üéã', 'üéç',
            'üéé', 'üéè', 'üéê', 'üéë', 'üßß', 'üéÄ', 'üéÅ', 'üéó', 'üéü', 'üé´',
            'üéñ', 'üèÜ', 'üèÖ', 'ü•á', 'ü•à', 'ü•â', '‚öΩ', '‚öæ', 'ü•é', 'üèÄ',
            'üèê', 'üèà', 'üèâ', 'üéæ', 'ü•è', 'üé≥', 'üèè', 'üèë', 'üèí', 'ü•ç',
            'üèì', 'üè∏', 'ü•ä', 'ü•ã', 'ü•Ö', '‚õ≥', '‚õ∏', 'üé£', 'ü§ø', 'üéΩ',
            'üéø', 'üõ∑', 'ü•å', 'üéØ', 'ü™Ä', 'ü™Å', 'üé±', 'üîÆ', 'üßø', 'üéÆ',
            'üïπ', 'üé∞', 'üé≤', 'üß©', 'üß∏', '‚ô†Ô∏è', '‚ô•Ô∏è', '‚ô¶Ô∏è', '‚ô£Ô∏è', '‚ôü',
            'üÉè', 'üÄÑ', 'üé¥', 'üé≠', 'üñº', 'üé®', 'üßµ', 'üß∂', 'üëì', 'üï∂',
            'ü•Ω', 'ü•º', 'ü¶∫', 'üëî', 'üëï', 'üëñ', 'üß£', 'üß§', 'üß•', 'üß¶',
            'üëó', 'üëò', 'ü•ª', 'ü©±', 'ü©≤', 'ü©≥', 'üëô', 'üëö', 'üëõ', 'üëú',
            'üëù', 'üõç', 'üéí', 'üëû', 'üëü', 'ü•æ', 'ü•ø', 'üë†', 'üë°', 'ü©∞',
            'üë¢', 'üëë', 'üëí', 'üé©', 'üéì', 'üß¢', '‚õë', 'üìø', 'üíÑ', 'üíç',
            'üíé', 'üîá', 'üîà', 'üîâ', 'üîä', 'üì¢', 'üì£', 'üìØ', 'üîî', 'üîï',
            'üéº', 'üéµ', 'üé∂', 'üéô', 'üéö', 'üéõ', 'üé§', 'üéß', 'üìª', 'üé∑',
            'üé∏', 'üéπ', 'üé∫', 'üéª', 'ü™ï', 'ü•Å', 'üì±', 'üì≤', '‚òéÔ∏è', 'üìû',
            'üìü', 'üì†', 'üîã', 'üîå', 'üíª', 'üñ•', 'üñ®', '‚å®Ô∏è', 'üñ±', 'üñ≤',
            'üíΩ', 'üíæ', 'üíø', 'üìÄ', 'üßÆ', 'üé•', 'üéû', 'üìΩ', 'üé¨', 'üì∫',
            'üì∑', 'üì∏', 'üìπ', 'üìº', 'üîç', 'üîé', 'üïØ', 'üí°', 'üî¶', 'üèÆ',
            'ü™î', 'üìî', 'üìï', 'üìñ', 'üìó', 'üìò', 'üìô', 'üìö', 'üìì', 'üìí',
            'üìÉ', 'üìú', 'üìÑ', 'üì∞', 'üóû', 'üìë', 'üîñ', 'üè∑', 'üí∞', 'üí¥',
            'üíµ', 'üí∂', 'üí∑', 'üí∏', 'üí≥', 'üßæ', 'üíπ', '‚úâÔ∏è', 'üìß', 'üì®',
            'üì©', 'üì§', 'üì•', 'üì¶', 'üì´', 'üì™', 'üì¨', 'üì≠', 'üìÆ', 'üó≥',
            '‚úèÔ∏è', '‚úíÔ∏è', 'üñã', 'üñä', 'üñå', 'üñç', 'üìù', 'üíº', 'üìÅ', 'üìÇ',
            'üóÇ', 'üìÖ', 'üìÜ', 'üóí', 'üóì', 'üìá', 'üìà', 'üìâ', 'üìä', 'üìã',
            'üìå', 'üìç', 'üìé', 'üñá', 'üìè', 'üìê', '‚úÇÔ∏è', 'üóÉ', 'üóÑ', 'üóë',
            'üîí', 'üîì', 'üîè', 'üîê', 'üîë', 'üóù', 'üî®', 'ü™ì', '‚õè', '‚öí',
            'üõ†', 'üó°', '‚öîÔ∏è', 'üî´', 'ü™É', 'üèπ', 'üõ°', 'ü™ö', 'üîß', 'ü™õ',
            'üî©', '‚öôÔ∏è', 'üóú', '‚öñÔ∏è', 'ü¶Ø', 'üîó', '‚õì', 'üß∞', 'üß≤', '‚öóÔ∏è',
            'üß™', 'üß´', 'üß¨', 'üî¨', 'üî≠', 'üì°', 'üíâ', 'ü©∏', 'üíä', 'ü©π',
            'ü©∫', 'üö™', 'üõó', 'ü™û', 'ü™ü', 'üõè', 'üõã', 'ü™ë', 'üöΩ', 'ü™†',
            'üöø', 'üõÅ', 'ü™§', 'ü™í', 'üß¥', 'üß∑', 'üßπ', 'üß∫', 'üßª', 'ü™£',
            'üßº', 'ü´ß', 'ü™•', 'üßΩ', 'üßØ', 'üõí', 'üö¨', '‚ö∞Ô∏è', 'ü™¶', '‚ö±Ô∏è',
            'üóø', 'ü™ß', 'üèß', 'üöÆ', 'üö∞', '‚ôø', 'üöπ', 'üö∫', 'üöª', 'üöº',
            'üöæ', 'üõÇ', 'üõÉ', 'üõÑ', 'üõÖ', '‚ö†Ô∏è', 'üö∏', '‚õî', 'üö´', 'üö≥',
            'üö≠', 'üöØ', 'üö±', 'üö∑', 'üìµ', 'üîû', '‚ò¢Ô∏è', '‚ò£Ô∏è', '‚¨ÜÔ∏è', '‚ÜóÔ∏è',
            '‚û°Ô∏è', '‚ÜòÔ∏è', '‚¨áÔ∏è', '‚ÜôÔ∏è', '‚¨ÖÔ∏è', '‚ÜñÔ∏è', '‚ÜïÔ∏è', '‚ÜîÔ∏è', '‚Ü©Ô∏è', '‚Ü™Ô∏è',
            '‚§¥Ô∏è', '‚§µÔ∏è', 'üîÉ', 'üîÑ', 'üîô', 'üîö', 'üîõ', 'üîú', 'üîù', 'üõê',
            '‚öõÔ∏è', 'üïâ', '‚ú°Ô∏è', '‚ò∏Ô∏è', '‚òØÔ∏è', '‚úùÔ∏è', '‚ò¶Ô∏è', '‚ò™Ô∏è', '‚òÆÔ∏è', 'üïé',
            'üîØ', '‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê',
            '‚ôë', '‚ôí', '‚ôì', '‚õé', 'üîÄ', 'üîÅ', 'üîÇ', '‚ñ∂Ô∏è', '‚è©', '‚è≠',
            '‚èØ', '‚óÄÔ∏è', '‚è™', '‚èÆ', 'üîº', '‚è´', 'üîΩ', '‚è¨', '‚è∏', '‚èπ',
            '‚è∫', '‚èèÔ∏è', 'üé¶', 'üîÖ', 'üîÜ', 'üì∂', 'üì≥', 'üì¥', '‚ôÄÔ∏è', '‚ôÇÔ∏è',
            '‚öïÔ∏è', '‚ôæ', '‚ôªÔ∏è', '‚öúÔ∏è', 'üî±', 'üìõ', 'üî∞', '‚≠ï', '‚úÖ', '‚òëÔ∏è',
            '‚úîÔ∏è', '‚úñÔ∏è', '‚ùå', '‚ùé', '‚ûï', '‚ûñ', '‚ûó', '‚û∞', '‚ûø', '„ÄΩÔ∏è',
            '‚ú≥Ô∏è', '‚ú¥Ô∏è', '‚ùáÔ∏è', '‚Äº', '‚Åâ', '‚ùì', '‚ùî', '‚ùï', '‚ùó', '„Ä∞Ô∏è',
            '¬©Ô∏è', '¬ÆÔ∏è', '‚Ñ¢Ô∏è', '#Ô∏è‚É£', '*Ô∏è‚É£', '0Ô∏è‚É£', '1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£',
            '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£', 'üîü', 'üî†', 'üî°', 'üî¢', 'üî£',
            'üî§', 'üÖ∞Ô∏è', 'üÜé', 'üÖ±Ô∏è', 'üÜë', 'üÜí', 'üÜì', '‚ÑπÔ∏è', 'üÜî', '‚ìÇÔ∏è',
            'üÜï', 'üÜñ', 'üÖæÔ∏è', 'üÜó', 'üÖøÔ∏è', 'üÜò', 'üÜô', 'üÜö', 'üàÅ', 'üàÇÔ∏è',
            'üà∑Ô∏è', 'üà∂', 'üàØ', 'üâê', 'üàπ', 'üàö', 'üà≤', 'üâë', 'üà∏', 'üà¥',
            'üà≥', '„äóÔ∏è', '„äôÔ∏è', 'üà∫', 'üàµ', 'üî¥', 'üü†', 'üü°', 'üü¢', 'üîµ',
            'üü£', 'üü§', '‚ö´', '‚ö™', 'üü•', 'üüß', 'üü®', 'üü©', 'üü¶', 'üü™',
            'üü´', '‚¨õ', '‚¨ú', '‚óºÔ∏è', '‚óªÔ∏è', '‚óæ', '‚óΩ', '‚ñ™Ô∏è', '‚ñ´Ô∏è', 'üî∂',
            'üî∑', 'üî∏', 'üîπ', 'üî∫', 'üîª', 'üí†', 'üîò', 'üî≥', 'üî≤', 'üèÅ',
            'üö©', 'üéå', 'üè¥', 'üè≥Ô∏è', 'üè≥Ô∏è‚Äçüåà', 'üè≥Ô∏è‚Äç‚ößÔ∏è', 'üè¥‚Äç‚ò†Ô∏è', 'üá¶üá®', 'üá¶üá©', 'üá¶üá™',
            'üá¶üá´', 'üá¶üá¨', 'üá¶üáÆ', 'üá¶üá±', 'üá¶üá≤', 'üá¶üá¥', 'üá¶üá∂', 'üá¶üá∑', 'üá¶üá∏', 'üá¶üáπ',
            'üá¶üá∫', 'üá¶üáº', 'üá¶üáΩ', 'üá¶üáø', 'üáßüá¶', 'üáßüáß', 'üáßüá©', 'üáßüá™', 'üáßüá´', 'üáßüá¨',
            'üáßüá≠', 'üáßüáÆ', 'üáßüáØ', 'üáßüá±', 'üáßüá≤', 'üáßüá≥', 'üáßüá¥', 'üáßüá∂', 'üáßüá∑', 'üáßüá∏',
            'üáßüáπ', 'üáßüáª', 'üáßüáº', 'üáßüáæ', 'üáßüáø', 'üá®üá¶', 'üá®üá®', 'üá®üá©', 'üá®üá´', 'üá®üá¨',
            'üá®üá≠', 'üá®üáÆ', 'üá®üá∞', 'üá®üá±', 'üá®üá≤', 'üá®üá≥', 'üá®üá¥', 'üá®üáµ', 'üá®üá∑', 'üá®üá∫',
            'üá®üáª', 'üá®üáº', 'üá®üáΩ', 'üá®üáæ', 'üá®üáø', 'üá©üá™', 'üá©üá¨', 'üá©üáØ', 'üá©üá∞', 'üá©üá≤',
            'üá©üá¥', 'üá©üáø', 'üá™üá¶', 'üá™üá®', 'üá™üá™', 'üá™üá¨', 'üá™üá≠', 'üá™üá∑', 'üá™üá∏', 'üá™üáπ',
            'üá™üá∫', 'üá´üáÆ', 'üá´üáØ', 'üá´üá∞', 'üá´üá≤', 'üá´üá¥', 'üá´üá∑', 'üá¨üá¶', 'üá¨üáß', 'üá¨üá©',
            'üá¨üá™', 'üá¨üá´', 'üá¨üá¨', 'üá¨üá≠', 'üá¨üáÆ', 'üá¨üá±', 'üá¨üá≤', 'üá¨üá≥', 'üá¨üáµ', 'üá¨üá∂',
            'üá¨üá∑', 'üá¨üá∏', 'üá¨üáπ', 'üá¨üá∫', 'üá¨üáº', 'üá¨üáæ', 'üá≠üá∞', 'üá≠üá≤', 'üá≠üá≥', 'üá≠üá∑',
            'üá≠üáπ', 'üá≠üá∫', 'üáÆüá®', 'üáÆüá©', 'üáÆüá™', 'üáÆüá±', 'üáÆüá≤', 'üáÆüá≥', 'üáÆüá¥', 'üáÆüá∂',
            'üáÆüá∑', 'üáÆüá∏', 'üáÆüáπ', 'üáØüá™', 'üáØüá≤', 'üáØüá¥', 'üáØüáµ', 'üá∞üá™', 'üá∞üá¨', 'üá∞üá≠',
            'üá∞üáÆ', 'üá∞üá≤', 'üá∞üá≥', 'üá∞üáµ', 'üá∞üá∑', 'üá∞üáº', 'üá∞üáæ', 'üá∞üáø', 'üá±üá¶', 'üá±üáß',
            'üá±üá®', 'üá±üáÆ', 'üá±üá∞', 'üá±üá∑', 'üá±üá∏', 'üá±üáπ', 'üá±üá∫', 'üá±üáª', 'üá±üáæ', 'üá≤üá¶',
            'üá≤üá®', 'üá≤üá©', 'üá≤üá™', 'üá≤üá´', 'üá≤üá¨', 'üá≤üá≠', 'üá≤üá∞', 'üá≤üá±', 'üá≤üá≤', 'üá≤üá≥',
            'üá≤üá¥', 'üá≤üáµ', 'üá≤üá∂', 'üá≤üá∑', 'üá≤üá∏', 'üá≤üáπ', 'üá≤üá∫', 'üá≤üáª', 'üá≤üáº', 'üá≤üáΩ',
            'üá≤üáæ', 'üá≤üáø', 'üá≥üá¶', 'üá≥üá®', 'üá≥üá™', 'üá≥üá´', 'üá≥üá¨', 'üá≥üáÆ', 'üá≥üá±', 'üá≥üá¥',
            'üá≥üáµ', 'üá≥üá∑', 'üá≥üá∫', 'üá≥üáø', 'üá¥üá≤', 'üáµüá¶', 'üáµüá™', 'üáµüá´', 'üáµüá¨', 'üáµüá≠',
            'üáµüá∞', 'üáµüá±', 'üáµüá≤', 'üáµüá≥', 'üáµüá∑', 'üáµüá∏', 'üáµüáπ', 'üáµüáº', 'üáµüáæ', 'üá∂üá¶',
            'üá∑üá™', 'üá∑üá¥', 'üá∑üá∏', 'üá∑üá∫', 'üá∑üáº', 'üá∏üá¶', 'üá∏üáß', 'üá∏üá®', 'üá∏üá©', 'üá∏üá™',
            'üá∏üá¨', 'üá∏üá≠', 'üá∏üáÆ', 'üá∏üáØ', 'üá∏üá∞', 'üá∏üá±', 'üá∏üá≤', 'üá∏üá≥', 'üá∏üá¥', 'üá∏üá∑',
            'üá∏üá∏', 'üá∏üáπ', 'üá∏üáª', 'üá∏üáΩ', 'üá∏üáæ', 'üá∏üáø', 'üáπüá¶', 'üáπüá®', 'üáπüá©', 'üáπüá´',
            'üáπüá¨', 'üáπüá≠', 'üáπüáØ', 'üáπüá∞', 'üáπüá±', 'üáπüá≤', 'üáπüá≥', 'üáπüá¥', 'üáπüá∑', 'üáπüáπ',
            'üáπüáª', 'üáπüáº', 'üáπüáø', 'üá∫üá¶', 'üá∫üá¨', 'üá∫üá≤', 'üá∫üá≥', 'üá∫üá∏', 'üá∫üáæ', 'üá∫üáø',
            'üáªüá¶', 'üáªüá®', 'üáªüá™', 'üáªüá¨', 'üáªüáÆ', 'üáªüá≥', 'üáªüá∫', 'üáºüá´', 'üáºüá∏', 'üáΩüá∞',
            'üáæüá™', 'üáæüáπ', 'üáøüá¶', 'üáøüá≤', 'üáøüáº'
        ];

        window.toggleEmojiPicker = (btnId) => {
            const picker = document.getElementById(btnId + '-picker');
            const allPickers = document.querySelectorAll('.emoji-picker-container');
            
            // Close other pickers first
            allPickers.forEach(el => {
                if (el.id !== btnId + '-picker') el.classList.add('hidden');
            });

            picker.classList.toggle('hidden');
        };

        window.insertEmoji = (editorId, emoji) => {
            const editor = document.getElementById(editorId);
            if (editor) {
                // Focus editor
                editor.focus();
                
                // Very basic insertion at end if selection is lost, or attempt execCommand
                // execCommand 'insertText' is best for preserving undo stack and simple text insertion
                document.execCommand('insertText', false, emoji);
                
                // Hide picker after selection
                const pickerId = editorId.replace('editor-', 'emoji-btn-') + '-picker';
                const picker = document.getElementById(pickerId);
                if (picker) picker.classList.add('hidden');
            }
        };

        window.openEntryModal = (type) => {
            currentEditType = type;
            currentEditId = null;
            document.getElementById('entry-modal-title').innerText = `Add ${type.charAt(0).toUpperCase() + type.slice(1, type.endsWith('s') ? -1 : undefined)}`; 
            document.getElementById('entry-form').reset();
            generateFormFields(type, null);
            document.getElementById('entry-modal').classList.remove('hidden');
            
            // Click outside listener for emoji picker closing
            setTimeout(() => {
                const closeEmojiOnClickOutside = (e) => {
                    if (!e.target.closest('.emoji-picker-container') && !e.target.closest('.emoji-trigger-btn')) {
                        document.querySelectorAll('.emoji-picker-container').forEach(el => el.classList.add('hidden'));
                    }
                };
                window.addEventListener('click', closeEmojiOnClickOutside);
                // Store reference to remove later if needed, though for this simple app simpler to leave or handle on close
            }, 100);
        };

        window.editEntry = (type, id) => {
            currentEditType = type;
            currentEditId = id;
            const item = appData[type].find(i => i.id === id);
            if (!item) return;
            document.getElementById('entry-modal-title').innerText = `Edit ${type.charAt(0).toUpperCase() + type.slice(1, type.endsWith('s') ? -1 : undefined)}`;
            generateFormFields(type, item);
            document.getElementById('entry-modal').classList.remove('hidden');
        };

        window.closeEntryModal = () => { document.getElementById('entry-modal').classList.add('hidden'); };

        window.deleteEntry = async (type, id) => {
            if(!confirm("Are you sure?")) return;
            showLoader();
            try { await deleteDoc(doc(getCollectionRef(type), id)); } catch(e) { console.error(e); }
            hideLoader();
        };

        window.handleEntrySubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // --- WYSIWYG Data Extraction ---
            // Since divs aren't inputs, we manually get their content and add it to the data object
            const descEditor = document.getElementById('editor-description');
            if (descEditor) data.description = descEditor.innerHTML;

            const bioEditor = document.getElementById('editor-bio');
            if (bioEditor) data.bio = bioEditor.innerHTML;
            
            const msgEditor = document.getElementById('editor-text');
            if (msgEditor) data.text = msgEditor.innerHTML;
            // -------------------------------

            if (currentEditType === 'announcements') data.urgent = formData.get('urgent') === 'on';
            
            showLoader();

            try {
                const fileInput = document.getElementById('form-image-file');
                if (fileInput && fileInput.files.length > 0) {
                    // Compress content images to max 1024px width
                    data.image = await processAndCompressImage(fileInput.files[0], 1024);
                } else if (!data.image && currentEditId) {
                     const oldItem = appData[currentEditType].find(i => i.id === currentEditId);
                     if(oldItem && oldItem.image) data.image = oldItem.image;
                }
                
                if (data.image && data.image.includes('drive.google.com')) {
                    const idMatch = data.image.match(/[-\w]{25,}/);
                    if(idMatch) data.image = `https://lh3.googleusercontent.com/d/${idMatch[0]}`;
                }

                if (currentEditId) await updateDoc(doc(getCollectionRef(currentEditType), currentEditId), data);
                else await addDoc(getCollectionRef(currentEditType), data);
                
                closeEntryModal();
            } catch(err) { 
                console.error(err); 
                alert("Error saving: " + err.message); 
            }
            hideLoader();
        };

        function generateFormFields(type, values) {
            const container = document.getElementById('entry-fields');
            let html = '';
            const v = values || {};
            
            // Rich Text Editor Toolbar Template with Emoji Support
            const richEditor = (fieldName, content, label) => {
                const btnId = `emoji-btn-${fieldName}`;
                return `
                <div>
                    <label class="block text-sm font-bold mb-1">${label}</label>
                    <div class="border rounded-lg w-full bg-white overflow-visible border-gray-300 focus-within:border-school-navy focus-within:ring-1 focus-within:ring-school-navy relative">
                        <!-- Toolbar -->
                        <div class="bg-gray-100 px-2 py-1.5 border-b flex space-x-1 items-center relative">
                            <button type="button" onmousedown="event.preventDefault();" onclick="document.execCommand('bold', false, null)" class="w-7 h-7 flex items-center justify-center hover:bg-gray-300 rounded text-xs font-bold" title="Bold">B</button>
                            <button type="button" onmousedown="event.preventDefault();" onclick="document.execCommand('italic', false, null)" class="w-7 h-7 flex items-center justify-center hover:bg-gray-300 rounded text-xs italic" title="Italic">I</button>
                            <button type="button" onmousedown="event.preventDefault();" onclick="document.execCommand('underline', false, null)" class="w-7 h-7 flex items-center justify-center hover:bg-gray-300 rounded text-xs underline" title="Underline">U</button>
                            
                            <!-- Emoji Button -->
                            <div class="relative ml-2 border-l pl-2 border-gray-300">
                                <button type="button" id="${btnId}" onclick="toggleEmojiPicker('${btnId}')" class="emoji-trigger-btn w-7 h-7 flex items-center justify-center hover:bg-gray-300 rounded text-sm grayscale hover:grayscale-0 transition-all" title="Insert Emoji">üòÄ</button>
                                
                                <!-- Emoji Picker Popup -->
                                <div id="${btnId}-picker" class="emoji-picker-container hidden absolute top-8 left-0 z-50 bg-white border border-gray-300 shadow-xl rounded-lg w-64 p-2">
                                    <div class="grid grid-cols-6 gap-1 max-h-48 overflow-y-auto custom-scrollbar">
                                        ${COMMON_EMOJIS.map(e => `<button type="button" onclick="insertEmoji('editor-${fieldName}', '${e}')" class="hover:bg-gray-100 rounded p-1 text-lg">${e}</button>`).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Editable Area -->
                        <div id="editor-${fieldName}" class="p-3 min-h-[100px] max-h-48 overflow-y-auto outline-none text-sm text-gray-700" contenteditable="true">${content || ''}</div>
                    </div>
                </div>
            `;
            };
            
            if (type === 'announcements') {
                html += `
                    <div><label class="block text-sm font-bold mb-1">Title</label><input name="title" required value="${v.title || ''}" class="w-full p-2 border rounded"></div>
                    ${richEditor('description', v.description, 'Description')}
                    
                    <div class="grid grid-cols-2 gap-4 bg-gray-50 p-3 rounded border">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Start Date (Optional)</label>
                            <input type="date" name="startDate" value="${v.startDate || ''}" class="w-full p-2 border rounded text-sm bg-white">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">End Date (Optional)</label>
                            <input type="date" name="endDate" value="${v.endDate || ''}" class="w-full p-2 border rounded text-sm bg-white">
                        </div>
                    </div>

                    <div class="flex items-center mt-2"><input type="checkbox" name="urgent" ${v.urgent ? 'checked' : ''} class="h-4 w-4"><label class="ml-2 text-sm font-bold text-red-600">Mark as Urgent</label></div>
                `;
            } else if (type === 'students') {
                html += `
                    <div><label class="block text-sm font-bold mb-1">Student Name</label><input name="name" required value="${v.name || ''}" class="w-full p-2 border rounded"></div>
                    <div><label class="block text-sm font-bold mb-1">Focus Area</label><input name="focus" placeholder="e.g. Science, Basketball" value="${v.focus || ''}" class="w-full p-2 border rounded"></div>
                    ${richEditor('description', v.description, 'Quote / Description')}
                `;
            } else if (type === 'teachers') {
                html += `
                    <div><label class="block text-sm font-bold mb-1">Name</label><input name="name" required value="${v.name || ''}" class="w-full p-2 border rounded"></div>
                    <div><label class="block text-sm font-bold mb-1">Department</label><select name="dept" class="w-full p-2 border rounded">${DEPARTMENTS.map(d => `<option value="${d}" ${v.dept === d ? 'selected' : ''}>${d}</option>`).join('')}</select></div>
                    ${richEditor('bio', v.bio, 'Bio')}
                `;
            } else if (type === 'events') {
                html += `
                    <div><label class="block text-sm font-bold mb-1">Event Title</label><input name="title" required value="${v.title || ''}" class="w-full p-2 border rounded"></div>
                    <div><label class="block text-sm font-bold mb-1">Date</label><input type="date" name="datetime" required value="${v.datetime || ''}" class="w-full p-2 border rounded"></div>
                    <div><label class="block text-sm font-bold mb-1">Location</label><input name="location" value="${v.location || ''}" class="w-full p-2 border rounded"></div>
                    
                    <div class="grid grid-cols-2 gap-4 bg-gray-50 p-3 rounded border mt-2">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Display Start Date (Opt)</label>
                            <input type="date" name="startDate" value="${v.startDate || ''}" class="w-full p-2 border rounded text-sm bg-white" title="When to start showing this event on the board">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Display End Date (Opt)</label>
                            <input type="date" name="endDate" value="${v.endDate || ''}" class="w-full p-2 border rounded text-sm bg-white" title="When to stop showing. Default is after the event date.">
                        </div>
                    </div>
                `;
            } else if (type === 'ticker') {
                html += richEditor('text', v.text, 'Message');
            } else if (type === 'media') {
                html += `
                    <div><label class="block text-sm font-bold mb-1">Media Type</label><select name="type" class="w-full p-2 border rounded">
                        <option value="youtube" ${v.type === 'youtube' ? 'selected' : ''}>YouTube Video</option>
                        <option value="facebook" ${v.type === 'facebook' ? 'selected' : ''}>Facebook Embed Code</option>
                        <option value="image" ${v.type === 'image' ? 'selected' : ''}>Image URL</option>
                    </select></div>
                    <div><label class="block text-sm font-bold mb-1">Content (URL or Code)</label><textarea name="content" required rows="3" class="w-full p-2 border rounded font-mono text-xs" placeholder="Paste URL or Code here...">${v.content || ''}</textarea></div>
                `;
            }
            if (type !== 'events' && type !== 'ticker' && type !== 'media') {
                html += `
                    <div class="border-t pt-4 mt-2">
                        <label class="block text-sm font-bold mb-1">Image (URL or Upload)</label>
                        <input name="image" placeholder="https://..." value="${v.image && v.image.startsWith('http') ? v.image : ''}" class="w-full p-2 border rounded mb-2 text-sm">
                        <input type="file" id="form-image-file" accept="image/*" class="text-sm">
                        <p class="text-xs text-gray-500 mt-1">Upload converts to Base64 (Max 1MB). URLs preferred.</p>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        // Updated: Image Processing & Compression
        const processAndCompressImage = (file, maxWidth = 1024, quality = 0.7) => {
            return new Promise((resolve, reject) => {
                if (!file) return resolve(null);
                
                // 1. Optimization: If file is < 800KB, upload as-is (preserves PNG transparency)
                if (file.size < 800 * 1024) {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = (error) => reject(error);
                    return;
                }

                // 2. Compression: If larger, resize and convert to JPEG
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;
                        
                        // Calculate new dimensions
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                        
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        
                        // Fill white background (prevents black background for transparent PNGs converted to JPEG)
                        ctx.fillStyle = "#FFFFFF";
                        ctx.fillRect(0, 0, width, height);
                        
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Compress to JPEG
                        const dataUrl = canvas.toDataURL('image/jpeg', quality);
                        
                        // Check output size (approximate)
                        const sizeInBytes = Math.ceil((dataUrl.length * 3) / 4);
                        
                        // 1MB Firestore Limit (leave safety margin)
                        if (sizeInBytes > 950000) {
                            reject(new Error("Image is too large/complex even after compression. Please use a smaller image."));
                        } else {
                            resolve(dataUrl);
                        }
                    };
                    img.onerror = (error) => reject(new Error("Invalid image file."));
                };
                reader.onerror = (error) => reject(error);
            });
        };
    </script>
</body>
</html>
