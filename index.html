<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Digital Bulletin Board</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        school: {
                            navy: '#003893',
                            gold: '#facc15',
                            goldDark: '#eab308'
                        }
                    },
                    fontFamily: {
                        sans: ['Open Sans', 'sans-serif'],
                        display: ['Montserrat', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { overflow: hidden; }
        .school-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .ticker-wrap {
            width: 100%;
            overflow: hidden;
            background-color: #facc15;
            padding-left: 100%;
            box-sizing: content-box; 
        }
        .ticker-move {
            display: inline-block;
            white-space: nowrap;
            padding-right: 100%;
            box-sizing: content-box;
            animation: ticker 20s linear infinite;
        }
        @keyframes ticker {
            0% { transform: translate3d(0, 0, 0); }
            100% { transform: translate3d(-100%, 0, 0); }
        }
        /* Custom scrollbar for events list */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Carousel Transitions */
        .fade-enter { opacity: 0; }
        .fade-enter-active { opacity: 1; transition: opacity 500ms ease-in; }
        .fade-exit { opacity: 1; }
        .fade-exit-active { opacity: 0; transition: opacity 500ms ease-out; }
        
        .aspect-circle {
            aspect-ratio: 1 / 1;
        }
        
        /* Iframe fixes */
        iframe { width: 100%; height: 100%; border: none; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col font-sans text-gray-800">

    <!-- Header -->
    <header class="bg-school-navy text-white pt-3 px-4 pb-2 shadow-lg z-10 flex-none flex flex-col">
        <div class="flex justify-between items-center mb-1">
            <!-- Logo & School Info -->
            <div class="flex items-center space-x-4 w-1/3">
                <div class="h-20 w-20 bg-white rounded-full flex-none flex items-center justify-center border-4 border-school-gold overflow-hidden school-logo-container relative">
                    <img id="header-logo" src="https://placehold.co/100x100?text=Logo" alt="School Logo" class="h-full w-full object-cover">
                </div>
                <div class="min-w-0">
                    <h1 id="header-school-name" class="text-3xl font-display font-extrabold tracking-wide uppercase whitespace-nowrap overflow-visible">Navajo Pine HS</h1>
                    <p id="header-subtitle" class="text-school-gold font-semibold text-lg leading-tight">School of Technology</p>
                </div>
            </div>

            <!-- Clock & Date -->
            <div class="text-center w-1/3">
                <div id="live-time" class="text-5xl font-display font-bold tabular-nums leading-none">12:00 PM</div>
                <div id="live-date" class="text-lg text-gray-200 mt-1 uppercase tracking-wider leading-none">Monday, January 1</div>
            </div>

            <!-- Weather Widget -->
            <div class="w-1/3 flex justify-end">
                <div class="bg-blue-900/50 rounded-xl p-2 backdrop-blur-sm border border-blue-700/50 flex items-center space-x-3 min-w-[260px]">
                    <div class="flex flex-col items-center justify-center px-2 border-r border-blue-700/50">
                        <span id="weather-city" class="text-[10px] text-school-gold font-bold uppercase mb-0 leading-none">Loading...</span>
                        <div class="text-2xl my-1" id="weather-current-icon"><i class="fas fa-cloud"></i></div>
                        <span id="weather-current-temp" class="text-lg font-bold leading-none">--°</span>
                    </div>
                    <div class="flex-1 flex justify-between text-center text-xs space-x-1" id="weather-forecast">
                        <!-- Forecast items injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Subtitle 2: Full Width -->
        <div class="w-full text-center border-t border-white/10 pt-2 mt-1">
            <p id="header-subtitle-2" class="text-gray-300 font-medium text-sm tracking-[0.2em] uppercase">Home of the Tech Warriors</p>
        </div>
    </header>

    <!-- Ticker -->
    <div class="bg-school-gold text-school-navy font-bold py-2 border-b-4 border-school-navy/20 flex-none z-10 relative shadow-md w-full overflow-hidden">
        <div class="ticker-wrap">
            <div class="ticker-move" id="ticker-content">
                Welcome to our digital bulletin board! Classes start at 8:00 AM. Go Tigers!
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <main class="flex-grow p-4 overflow-hidden flex flex-col md:flex-row gap-6">
        
        <!-- Main Grid (75%) -->
        <div class="w-full md:w-3/4 h-full">
            <div class="grid grid-cols-1 md:grid-cols-2 grid-rows-2 gap-6 h-full">
                
                <!-- Top Left: Student Spotlight -->
                <div class="bg-gradient-to-br from-white to-blue-100 rounded-2xl school-shadow border border-gray-200 flex flex-col overflow-hidden relative group">
                    <div class="bg-school-navy py-2 px-4 flex justify-between items-center">
                        <h2 class="text-white font-display font-bold text-xl"><i class="fas fa-star text-school-gold mr-2"></i> Student Spotlight</h2>
                    </div>
                    <div class="flex-grow relative p-6 flex items-center justify-center" id="student-carousel">
                        <div class="text-center w-full"><p class="text-gray-400">Loading...</p></div>
                    </div>
                    <div class="absolute bottom-0 left-0 h-1 bg-school-gold transition-all duration-300" id="student-progress" style="width: 0%"></div>
                </div>

                <!-- Top Right: Teacher Feature -->
                <div class="bg-gradient-to-br from-white to-yellow-100 rounded-2xl school-shadow border border-gray-200 flex flex-col overflow-hidden relative">
                    <div class="bg-school-navy py-2 px-4">
                        <h2 class="text-white font-display font-bold text-xl"><i class="fas fa-chalkboard-teacher text-school-gold mr-2"></i> Teacher/Staff Feature</h2>
                    </div>
                    <div class="flex-grow relative p-6 flex items-center justify-center" id="teacher-carousel">
                         <div class="text-center w-full"><p class="text-gray-400">Loading...</p></div>
                    </div>
                    <div class="absolute bottom-0 left-0 h-1 bg-school-gold transition-all duration-300" id="teacher-progress" style="width: 0%"></div>
                </div>

                <!-- Bottom Left: Upcoming Events -->
                <div class="bg-gradient-to-br from-white to-gray-200 rounded-2xl school-shadow border border-gray-200 flex flex-col overflow-hidden">
                    <div class="bg-school-navy py-2 px-4 flex justify-between items-center">
                        <h2 class="text-white font-display font-bold text-xl"><i class="fas fa-calendar-alt text-school-gold mr-2"></i> Upcoming Events</h2>
                        <span class="text-xs text-white bg-blue-800 px-2 py-1 rounded">Next 10</span>
                    </div>
                    <div class="flex-grow overflow-y-auto custom-scrollbar p-4" id="events-list">
                         <div class="text-center w-full text-gray-400 mt-4">Loading Events...</div>
                    </div>
                </div>

                <!-- Bottom Right: Announcements -->
                <div class="bg-gradient-to-br from-white to-blue-50 rounded-2xl school-shadow border border-gray-200 flex flex-col overflow-hidden relative">
                    <div class="bg-school-navy py-2 px-4">
                        <h2 class="text-white font-display font-bold text-xl"><i class="fas fa-bullhorn text-school-gold mr-2"></i> Announcements</h2>
                    </div>
                    <div class="flex-grow relative p-6 flex items-center justify-center" id="announcement-carousel">
                         <div class="text-center w-full"><p class="text-gray-400">No Announcements</p></div>
                    </div>
                    <div class="absolute bottom-0 left-0 h-1 bg-school-gold transition-all duration-300" id="announcement-progress" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Sidebar / Aside (25%) -->
        <aside class="w-full md:w-1/4 h-full flex flex-col gap-6">
            <!-- Media Slot 1 (Top) -->
            <div class="flex-1 bg-white rounded-2xl school-shadow border border-gray-200 overflow-hidden flex flex-col relative" id="media-slot-top">
                <div class="bg-gray-800 py-1 px-3">
                    <h3 class="text-xs font-bold text-white uppercase tracking-wider text-center">Media Feed</h3>
                </div>
                <div class="flex-grow bg-black relative" id="media-content-top">
                    <!-- Dynamic Media Content -->
                    <div class="absolute inset-0 flex items-center justify-center text-gray-500 text-sm">
                        <i class="fas fa-play-circle fa-2x mb-2"></i>
                    </div>
                </div>
            </div>

            <!-- Media Slot 2 (Bottom) -->
            <div class="flex-1 bg-white rounded-2xl school-shadow border border-gray-200 overflow-hidden flex flex-col relative" id="media-slot-bottom">
                 <div class="bg-gray-800 py-1 px-3">
                    <h3 class="text-xs font-bold text-white uppercase tracking-wider text-center">Social / Video</h3>
                </div>
                <div class="flex-grow bg-black relative" id="media-content-bottom">
                     <!-- Dynamic Media Content -->
                    <div class="absolute inset-0 flex items-center justify-center text-gray-500 text-sm">
                        <i class="fas fa-photo-video fa-2x mb-2"></i>
                    </div>
                </div>
            </div>
        </aside>

    </main>

    <!-- Admin Button -->
    <button onclick="toggleAdminModal()" class="fixed bottom-6 right-6 bg-gray-800/80 hover:bg-school-navy text-white p-4 rounded-full shadow-2xl transition-all duration-300 hover:scale-110 z-50 backdrop-blur">
        <i class="fas fa-cog fa-lg"></i>
    </button>

    <!-- Admin Modal -->
    <div id="admin-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-5xl h-[85vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
            <!-- Modal Header -->
            <div class="bg-gray-800 text-white p-4 flex justify-between items-center">
                <h3 class="text-xl font-bold font-display"><i class="fas fa-sliders-h mr-2"></i> Dashboard Configuration</h3>
                <button onclick="toggleAdminModal()" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="flex flex-grow overflow-hidden">
                <!-- Sidebar Tabs -->
                <div class="w-1/5 bg-gray-100 border-r border-gray-200 overflow-y-auto">
                    <nav class="flex flex-col p-2 space-y-1" id="admin-tabs">
                        <button onclick="switchTab('tab-announcements')" class="admin-tab-btn active text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-bullhorn w-6"></i> Announcements
                        </button>
                        <button onclick="switchTab('tab-students')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-user-graduate w-6"></i> Students
                        </button>
                        <button onclick="switchTab('tab-teachers')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-chalkboard-teacher w-6"></i> Teacher/Staff
                        </button>
                        <button onclick="switchTab('tab-events')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-calendar-alt w-6"></i> Events
                        </button>
                        <button onclick="switchTab('tab-ticker')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-scroll w-6"></i> Ticker
                        </button>
                         <button onclick="switchTab('tab-media')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-photo-video w-6"></i> Media Sidebar
                        </button>
                        <button onclick="switchTab('tab-config')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-tools w-6"></i> Config
                        </button>
                    </nav>
                </div>

                <!-- Content Area -->
                <div class="w-4/5 p-8 overflow-y-auto bg-gray-50 relative">
                    
                    <!-- Tab: Announcements -->
                    <div id="tab-announcements" class="admin-content block">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Manage Announcements</h2>
                            <button onclick="openEntryModal('announcements')" class="bg-school-navy hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition-colors"><i class="fas fa-plus mr-2"></i> Add New</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="admin-announcements-list"></div>
                    </div>

                    <!-- Tab: Students -->
                    <div id="tab-students" class="admin-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Manage Student Spotlight</h2>
                            <button onclick="openEntryModal('students')" class="bg-school-navy hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition-colors"><i class="fas fa-plus mr-2"></i> Add Student</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="admin-students-list"></div>
                    </div>

                    <!-- Tab: Teachers -->
                    <div id="tab-teachers" class="admin-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Manage Teacher/Staff Features</h2>
                            <button onclick="openEntryModal('teachers')" class="bg-school-navy hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition-colors"><i class="fas fa-plus mr-2"></i> Add Feature</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="admin-teachers-list"></div>
                    </div>

                    <!-- Tab: Events -->
                    <div id="tab-events" class="admin-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Manage Manual Events</h2>
                            <button onclick="openEntryModal('events')" class="bg-school-navy hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition-colors"><i class="fas fa-plus mr-2"></i> Add Event</button>
                        </div>
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                            <p class="text-sm text-blue-700"><strong>Note:</strong> Events from your Google Calendar link (set in Config) are fetched automatically. Add manual events here for things not on the calendar.</p>
                        </div>
                        <div class="space-y-2" id="admin-events-list"></div>
                    </div>

                    <!-- Tab: Ticker -->
                    <div id="tab-ticker" class="admin-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Manage Ticker Messages</h2>
                            <button onclick="openEntryModal('ticker')" class="bg-school-navy hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition-colors"><i class="fas fa-plus mr-2"></i> Add Message</button>
                        </div>
                        <div class="space-y-2" id="admin-ticker-list"></div>
                    </div>

                    <!-- Tab: Media Sidebar -->
                    <div id="tab-media" class="admin-content hidden">
                        <div class="max-w-3xl mx-auto space-y-6">
                            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                                <p class="text-sm text-blue-700">
                                    <strong>Instructions:</strong> For YouTube, paste the full video URL (e.g., https://www.youtube.com/watch?v=...). 
                                    For Facebook, paste the <strong>iframe embed code</strong> provided by Facebook's "Page Plugin" or "Embedded Video" tool.
                                </p>
                            </div>

                            <!-- Top Media -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border relative">
                                <span class="absolute top-2 right-2 text-xs font-bold text-gray-300">TOP SLOT</span>
                                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Sidebar Top Media</h3>
                                <div class="grid grid-cols-1 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Media Type</label>
                                        <select id="media-top-type" class="w-full p-2 border rounded">
                                            <option value="youtube">YouTube Video</option>
                                            <option value="facebook">Facebook Embed Code</option>
                                            <option value="image">Image URL</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Content (URL or Embed Code)</label>
                                        <textarea id="media-top-content" rows="3" class="w-full p-2 border rounded font-mono text-xs" placeholder="Paste URL or Code here..."></textarea>
                                    </div>
                                    <button onclick="saveMediaSlot('top')" class="bg-school-navy text-white px-4 py-2 rounded hover:bg-blue-800">Save Top Slot</button>
                                </div>
                            </div>

                            <!-- Bottom Media -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border relative">
                                <span class="absolute top-2 right-2 text-xs font-bold text-gray-300">BOTTOM SLOT</span>
                                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Sidebar Bottom Media</h3>
                                <div class="grid grid-cols-1 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Media Type</label>
                                        <select id="media-bottom-type" class="w-full p-2 border rounded">
                                            <option value="youtube">YouTube Video</option>
                                            <option value="facebook">Facebook Embed Code</option>
                                            <option value="image">Image URL</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Content (URL or Embed Code)</label>
                                        <textarea id="media-bottom-content" rows="3" class="w-full p-2 border rounded font-mono text-xs" placeholder="Paste URL or Code here..."></textarea>
                                    </div>
                                    <button onclick="saveMediaSlot('bottom')" class="bg-school-navy text-white px-4 py-2 rounded hover:bg-blue-800">Save Bottom Slot</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Config -->
                    <div id="tab-config" class="admin-content hidden">
                        <div class="max-w-3xl mx-auto space-y-6">
                            <div class="bg-white p-6 rounded-xl shadow-sm border">
                                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">School Identity</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <div class="flex justify-between items-center mb-1">
                                            <label class="block text-sm font-medium text-gray-700">School Name</label>
                                            <div class="space-x-1">
                                                <button type="button" onclick="formatText('conf-name', 'b')" class="px-2 py-0.5 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold" title="Bold">B</button>
                                                <button type="button" onclick="formatText('conf-name', 'i')" class="px-2 py-0.5 bg-gray-200 hover:bg-gray-300 rounded text-xs italic" title="Italic">I</button>
                                            </div>
                                        </div>
                                        <input type="text" id="conf-name" class="w-full p-2 border rounded">
                                    </div>
                                    <div>
                                        <div class="flex justify-between items-center mb-1">
                                            <label class="block text-sm font-medium text-gray-700">Subtitle</label>
                                            <div class="space-x-1">
                                                <button type="button" onclick="formatText('conf-subtitle', 'b')" class="px-2 py-0.5 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold" title="Bold">B</button>
                                                <button type="button" onclick="formatText('conf-subtitle', 'i')" class="px-2 py-0.5 bg-gray-200 hover:bg-gray-300 rounded text-xs italic" title="Italic">I</button>
                                            </div>
                                        </div>
                                        <input type="text" id="conf-subtitle" class="w-full p-2 border rounded">
                                    </div>
                                    <div class="md:col-span-2">
                                        <div class="flex justify-between items-center mb-1">
                                            <label class="block text-sm font-medium text-gray-700">Subtitle 2</label>
                                            <div class="space-x-1">
                                                <button type="button" onclick="formatText('conf-subtitle-2', 'b')" class="px-2 py-0.5 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold" title="Bold">B</button>
                                                <button type="button" onclick="formatText('conf-subtitle-2', 'i')" class="px-2 py-0.5 bg-gray-200 hover:bg-gray-300 rounded text-xs italic" title="Italic">I</button>
                                            </div>
                                        </div>
                                        <input type="text" id="conf-subtitle-2" class="w-full p-2 border rounded" placeholder="e.g. Home of the Tech Warriors">
                                    </div>
                                    
                                    <!-- Logo Upload Section -->
                                    <div class="md:col-span-2 border-t pt-4 mt-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">School Logo</label>
                                        <div class="flex items-center space-x-4">
                                            <div class="h-16 w-16 bg-white rounded-full border flex items-center justify-center overflow-hidden flex-none">
                                                 <img id="conf-logo-preview" src="https://placehold.co/100x100?text=Logo" class="h-full w-full object-cover">
                                            </div>
                                            <input type="file" id="conf-logo-file" accept="image/*" class="text-sm block w-full text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-school-navy/10 file:text-school-navy hover:file:bg-school-navy/20">
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1 ml-20">Upload a square image (PNG/JPG). Max 1MB (Firestore limit).</p>
                                    </div>

                                </div>
                            </div>
                            
                            <div class="bg-white p-6 rounded-xl shadow-sm border">
                                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Integrations</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Weather Location (City, State)</label>
                                        <input type="text" id="conf-location" class="w-full p-2 border rounded" placeholder="e.g. Navajo, NM">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Google Calendar Public iCal Link (.ics)</label>
                                        <input type="text" id="conf-calendar" class="w-full p-2 border rounded" placeholder="https://calendar.google.com/.../basic.ics">
                                        <p class="text-xs text-gray-500 mt-1">Paste the "Public address in iCal format" from your Google Calendar settings.</p>
                                    </div>
                                </div>
                            </div>

                            <button onclick="saveConfig()" class="w-full bg-school-navy hover:bg-blue-800 text-white font-bold py-3 rounded-lg transition-colors shadow">Save Configuration</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Entry Edit/Add Modal (Generic) -->
    <div id="entry-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative">
            <h3 id="entry-modal-title" class="text-xl font-bold mb-4">Add Item</h3>
            <form id="entry-form" onsubmit="handleEntrySubmit(event)" class="space-y-4">
                <!-- Dynamic Fields injected here -->
                <div id="entry-fields"></div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeEntryModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-school-navy text-white rounded hover:bg-blue-800">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="global-loader" class="fixed top-4 right-4 bg-white px-4 py-2 rounded-full shadow-lg z-[100] hidden flex items-center space-x-2">
        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-school-navy"></div>
        <span class="text-xs font-bold text-school-navy">Saving...</span>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, setDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        // Your actual config is here. DO NOT change the imports above.
        const firebaseConfig = {
                apiKey: "AIzaSyAtawxqfPOZqKJZcClKBVXSClC3IsIuDtM",
                authDomain: "digital-bulletin-board-6c660.firebaseapp.com",
                projectId: "digital-bulletin-board-6c660",
                storageBucket: "digital-bulletin-board-6c660.firebasestorage.app",
                messagingSenderId: "1051324595132",
                appId: "1:1051324595132:web:bb95ce7acc65d9e80d49b9",
                measurementId: "G-6VW2SKC09Z"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        
        // Initialize Analytics safely (in a try-catch to prevent app crash if ad-blockers block it)
        let analytics;
        try {
            analytics = getAnalytics(app);
        } catch (e) {
            console.warn("Analytics failed to initialize. Continuing without it.", e);
        }

        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const appId = 'navajo-pine-hs-v1'; 

        let currentUser = null;
        let appData = {
            announcements: [],
            students: [],
            teachers: [],
            events: [],
            externalEvents: [],
            ticker: "",
            settings: {},
            media: { top: {}, bottom: {} }
        };

        // --- Constants & Departments ---
        const DEPARTMENTS = [
            "General", "Admin", "History", "Navajo Language", "Math", 
            "ELA", "Science", "Tech", "Special Ed", "PE", "Health", 
            "Welding", "Sports", "Music", "Art"
        ];
        
        const COLLECTIONS = {
            ANNOUNCEMENTS: 'announcements',
            STUDENTS: 'students',
            TEACHERS: 'teachers',
            EVENTS: 'events',
            TICKER: 'ticker',
            SETTINGS: 'settings',
            MEDIA: 'media'
        };

        // --- DOM Elements ---
        const els = {
            schoolName: document.getElementById('header-school-name'),
            schoolSubtitle: document.getElementById('header-subtitle'),
            schoolSubtitle2: document.getElementById('header-subtitle-2'),
            liveTime: document.getElementById('live-time'),
            liveDate: document.getElementById('live-date'),
            ticker: document.getElementById('ticker-content'),
            
            // Carousels
            studentCarousel: document.getElementById('student-carousel'),
            studentProgress: document.getElementById('student-progress'),
            teacherCarousel: document.getElementById('teacher-carousel'),
            teacherProgress: document.getElementById('teacher-progress'),
            announcementCarousel: document.getElementById('announcement-carousel'),
            announcementProgress: document.getElementById('announcement-progress'),
            
            // Lists
            eventsList: document.getElementById('events-list'),
            
            // Weather
            weatherCity: document.getElementById('weather-city'),
            weatherIcon: document.getElementById('weather-current-icon'),
            weatherTemp: document.getElementById('weather-current-temp'),
            weatherForecast: document.getElementById('weather-forecast'),

            // Admin Lists
            adminAnnouncements: document.getElementById('admin-announcements-list'),
            adminStudents: document.getElementById('admin-students-list'),
            adminTeachers: document.getElementById('admin-teachers-list'),
            adminEvents: document.getElementById('admin-events-list'),
            adminTicker: document.getElementById('admin-ticker-list'),
            
            // Config Inputs
            confName: document.getElementById('conf-name'),
            confSubtitle: document.getElementById('conf-subtitle'),
            confSubtitle2: document.getElementById('conf-subtitle-2'),
            confLocation: document.getElementById('conf-location'),
            confCalendar: document.getElementById('conf-calendar'),
            
            // Media
            mediaTopContent: document.getElementById('media-content-top'),
            mediaBottomContent: document.getElementById('media-content-bottom')
        };

        // --- Initialization ---
        async function initAuth() {
            // Check for file protocol causing errors
            if (window.location.protocol === 'file:') {
                alert("CRITICAL ERROR: You are running this file directly from your computer (file://). This prevents the app from working.\n\nPlease upload this index.html to Netlify Drop or Firebase Hosting to use it.");
                return;
            }

            try {
                // No custom token needed for public deployment
                await signInAnonymously(auth);
            } catch(e) {
                console.error("Auth Failed", e);
                // Diagnostic alert for the user
                if (e.code === 'auth/operation-not-allowed') {
                    alert("SETUP ERROR: Anonymous Authentication is disabled.\n\nGo to Firebase Console -> Build -> Authentication -> Sign-in method -> Enable 'Anonymous'.");
                } else if (e.code === 'auth/configuration-not-found') {
                    alert("SETUP ERROR: Firebase config is invalid. Check your API Keys.");
                } else if (e.code === 'auth/unauthorized-domain') {
                    alert("DOMAIN ERROR: Firebase blocked this URL.\n\nGo to Firebase Console -> Build -> Authentication -> Settings -> Authorized Domains -> Add Domain (add your Netlify URL there).");
                } else {
                    alert("Connection Error: " + e.message);
                }
            }
        }

        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                setupListeners();
                startClock();
            }
        });

        // --- Firebase Listeners ---
        function getCollectionRef(colName) {
            return collection(db, 'artifacts', appId, 'public', 'data', colName);
        }

        function setupListeners() {
            // Generic listener builder
            const listen = (colName, callback) => {
                onSnapshot(getCollectionRef(colName), (snapshot) => {
                    const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    callback(data);
                }, (error) => console.error(`Error listening to ${colName}:`, error));
            };

            listen(COLLECTIONS.ANNOUNCEMENTS, (data) => {
                appData.announcements = data;
                renderCarousel('announcement', data);
                renderAdminList('announcements', data);
            });

            listen(COLLECTIONS.STUDENTS, (data) => {
                appData.students = data;
                renderCarousel('student', data);
                renderAdminList('students', data);
            });

            listen(COLLECTIONS.TEACHERS, (data) => {
                appData.teachers = data;
                renderCarousel('teacher', data);
                renderAdminList('teachers', data);
            });

            listen(COLLECTIONS.EVENTS, (data) => {
                appData.events = data;
                mergeAndRenderEvents();
                renderAdminList('events', data);
            });

            listen(COLLECTIONS.TICKER, (data) => {
                if (data.length > 0) {
                    appData.ticker = data;
                    const combinedText = data.map(item => item.text).join(' &nbsp; <span class="text-school-navy/50 mx-2">●</span> &nbsp; ');
                    els.ticker.innerHTML = combinedText;
                } else {
                     els.ticker.innerHTML = "Welcome to School Board";
                }
                renderAdminList('ticker', data);
            });

            listen(COLLECTIONS.SETTINGS, (data) => {
                if (data.length > 0) {
                    appData.settings = data[0];
                    appData.settingsId = data[0].id;
                    updateUIConfig(data[0]);
                } else {
                    const defaults = {
                        schoolName: "Navajo Pine HS",
                        subtitle: "School of Technology",
                        subtitle2: "<b><i>Home of the Tech Warriors (Tó éí Tech Naalʼánígíí Kéyah)</i></b>",
                        location: "Navajo, NM",
                        googleCalendar: ""
                    };
                    addDoc(getCollectionRef(COLLECTIONS.SETTINGS), defaults);
                }
            });

            listen(COLLECTIONS.MEDIA, (data) => {
                data.forEach(item => {
                    appData.media[item.id] = item;
                    renderMedia(item.id, item);
                });
                // Update Admin Fields
                ['top', 'bottom'].forEach(slot => {
                    if (appData.media[slot]) {
                        document.getElementById(`media-${slot}-type`).value = appData.media[slot].type || 'youtube';
                        document.getElementById(`media-${slot}-content`).value = appData.media[slot].content || '';
                    }
                });
            });
        }

        // --- Core Logic: Rendering ---

        // Config UI Update
        function updateUIConfig(settings) {
            if(settings.schoolName) els.schoolName.innerHTML = settings.schoolName;
            if(settings.subtitle) els.schoolSubtitle.innerHTML = settings.subtitle;
            if(settings.subtitle2) els.schoolSubtitle2.innerHTML = settings.subtitle2;
            if(settings.logo) {
                document.getElementById('header-logo').src = settings.logo;
                const preview = document.getElementById('conf-logo-preview');
                if(preview) preview.src = settings.logo;
            }
            
            // Update Admin Inputs
            els.confName.value = settings.schoolName || "";
            els.confSubtitle.value = settings.subtitle || "";
            els.confSubtitle2.value = settings.subtitle2 || "";
            els.confLocation.value = settings.location || "";
            els.confCalendar.value = settings.googleCalendar || "";

            // Trigger fetches if changed
            fetchWeather(settings.location);
            fetchCalendar(settings.googleCalendar);
        }

        // Render Media Sidebar Slots
        function renderMedia(slotId, data) {
            let container;
            if (slotId === 'top') container = els.mediaTopContent;
            else if (slotId === 'bottom') container = els.mediaBottomContent;
            else return;

            container.innerHTML = ''; // Clear

            if (!data || !data.content) {
                container.innerHTML = `<div class="absolute inset-0 flex items-center justify-center text-gray-500 text-sm">Empty Slot</div>`;
                return;
            }

            if (data.type === 'image') {
                container.innerHTML = `<img src="${data.content}" class="w-full h-full object-cover">`;
            } else if (data.type === 'youtube') {
                // Extract video ID with better support for Shorts and Embed links
                let videoId = '';
                try {
                    const url = new URL(data.content);
                    if (url.hostname.includes('youtube.com')) {
                        if (url.searchParams.has('v')) {
                            videoId = url.searchParams.get('v');
                        } else if (url.pathname.includes('/shorts/')) {
                            videoId = url.pathname.split('/shorts/')[1];
                        } else if (url.pathname.includes('/embed/')) {
                            videoId = url.pathname.split('/embed/')[1];
                        }
                    } else if (url.hostname.includes('youtu.be')) {
                        videoId = url.pathname.slice(1);
                    }
                } catch(e) { /* ignore invalid url */ }
                
                if (videoId) {
                    // Clean ID (remove potential extra params like ?feature=share)
                    videoId = videoId.split('?')[0].split('&')[0];
                    
                    // USE NO-COOKIE DOMAIN + ROBUST ATTRIBUTES
                    container.innerHTML = `
                        <iframe 
                            src="https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1&mute=1&loop=1&playlist=${videoId}&controls=0" 
                            title="YouTube video player" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                            referrerpolicy="strict-origin-when-cross-origin" 
                            allowfullscreen 
                            class="w-full h-full">
                        </iframe>`;
                } else {
                     container.innerHTML = `<div class="p-4 text-xs text-red-500">Invalid YouTube URL. Supported: Standard, Shorts, Share links.</div>`;
                }

            } else if (data.type === 'facebook') {
                // If user pasted iframe code, use it. If not, try to construct.
                if (data.content.includes('<iframe')) {
                    // Sanitize slightly? Trust admin for now.
                    container.innerHTML = data.content;
                } else {
                     container.innerHTML = `<div class="p-4 text-xs text-red-500">Please paste full Facebook embed code (iframe).</div>`;
                }
            }
        }

        // Carousel Logic
        const carousels = {
            student: { index: 0, timer: null, interval: 8000 },
            teacher: { index: 0, timer: null, interval: 10000 },
            announcement: { index: 0, timer: null, interval: 12000 }
        };

        function renderCarousel(type, data) {
            const container = els[`${type}Carousel`];
            const progressBar = els[`${type}Progress`];
            const config = carousels[type];

            // Clear existing interval
            if (config.timer) clearInterval(config.timer);
            
            if (!data || data.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400">No content available</div>`;
                return;
            }

            // Ensure index is valid
            if (config.index >= data.length) config.index = 0;

            const updateSlide = () => {
                // Reset progress bar
                progressBar.style.transition = 'none';
                progressBar.style.width = '0%';
                
                // Content Generation
                const item = data[config.index];
                let content = '';

                // Transition effect container
                container.innerHTML = `<div class="w-full h-full flex flex-col items-center justify-center animate-fade-in transition-opacity duration-500 opacity-0" id="${type}-slide-content"></div>`;
                const slide = document.getElementById(`${type}-slide-content`);

                if (type === 'student') {
                    slide.innerHTML = `
                        <div class="relative w-32 h-32 md:w-48 md:h-48 rounded-full border-4 border-school-gold overflow-hidden shadow-lg mb-4">
                            <img src="${item.image || 'https://placehold.co/200?text=Student'}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/200?text=No+Img'">
                        </div>
                        <h3 class="text-2xl font-bold text-school-navy mb-1">${item.name}</h3>
                        <span class="bg-school-gold text-school-navy px-3 py-1 rounded-full text-sm font-bold mb-3">${item.focus || 'Student'}</span>
                        <p class="text-center text-gray-600 italic line-clamp-3 px-4">"${item.description}"</p>
                    `;
                } else if (type === 'teacher') {
                    slide.innerHTML = `
                        <div class="flex flex-row items-center space-x-6 w-full px-4">
                            <div class="w-1/3 flex justify-end">
                                <div class="w-32 h-32 rounded-full border-4 border-school-navy overflow-hidden shadow-lg">
                                    <img src="${item.image || 'https://placehold.co/200?text=Staff'}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/200?text=No+Img'">
                                </div>
                            </div>
                            <div class="w-2/3 text-left">
                                <h3 class="text-2xl font-bold text-gray-800">${item.name}</h3>
                                <div class="text-school-navy font-bold uppercase tracking-wide text-sm mb-2">${item.dept}</div>
                                <p class="text-gray-600 text-sm line-clamp-4 border-l-4 border-school-gold pl-3">${item.bio}</p>
                            </div>
                        </div>
                    `;
                } else if (type === 'announcement') {
                    const isImg = item.image && item.image.length > 50; // simple check
                    slide.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full w-full">
                            ${isImg ? 
                                `<img src="${item.image}" class="max-h-32 rounded-lg shadow-sm mb-4 object-contain">` : 
                                `<div class="mb-4 text-school-gold"><i class="fas fa-bullhorn fa-3x"></i></div>`
                            }
                            <h3 class="text-2xl md:text-3xl font-bold text-center text-school-navy mb-2 leading-tight">${item.title}</h3>
                            <div class="h-1 w-20 bg-school-gold mb-3"></div>
                            <p class="text-center text-gray-700 text-lg md:text-xl line-clamp-4 px-6">${item.description}</p>
                            ${item.urgent ? '<span class="absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-bl-lg uppercase animate-pulse">Urgent</span>' : ''}
                        </div>
                    `;
                }

                // Trigger Fade In
                setTimeout(() => slide.classList.remove('opacity-0'), 50);

                // Animate Progress Bar
                setTimeout(() => {
                    progressBar.style.transition = `width ${config.interval}ms linear`;
                    progressBar.style.width = '100%';
                }, 100);

                // Increment
                config.index = (config.index + 1) % data.length;
            };

            updateSlide();
            config.timer = setInterval(updateSlide, config.interval);
        }

        // --- Weather & Calendar ---
        async function fetchWeather(location) {
             if (!location) return;
             try {
                const q = encodeURIComponent(location);
                let geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=1&language=en&format=json`);
                let geoData = await geoRes.json();
                if (!geoData.results && location.includes(',')) {
                    const city = location.split(',')[0].trim();
                    geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=en&format=json`);
                    geoData = await geoRes.json();
                }
                if (!geoData.results) {
                    els.weatherCity.innerText = "Loc not found";
                    return;
                }
                const { latitude, longitude, name, admin1 } = geoData.results[0];
                els.weatherCity.innerText = `${name}, ${admin1 || ''}`;
                const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto&temperature_unit=fahrenheit`);
                const wData = await wRes.json();
                els.weatherTemp.innerText = Math.round(wData.current.temperature_2m) + "°F";
                els.weatherIcon.innerHTML = getWeatherIcon(wData.current.weather_code);
                let forecastHTML = '';
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                for(let i=0; i<3; i++) {
                    const date = new Date(wData.daily.time[i]);
                    const dayName = i === 0 ? 'Today' : days[date.getDay()];
                    const max = Math.round(wData.daily.temperature_2m_max[i]);
                    const min = Math.round(wData.daily.temperature_2m_min[i]);
                    const code = wData.daily.weather_code[i];
                    forecastHTML += `
                        <div class="flex flex-col items-center">
                            <span class="font-bold text-gray-200">${dayName}</span>
                            <span class="text-lg my-1">${getWeatherIcon(code)}</span>
                            <span class="text-xs font-semibold">${max}°/${min}°</span>
                        </div>
                    `;
                }
                els.weatherForecast.innerHTML = forecastHTML;
            } catch (e) {
                console.error("Weather error", e);
                els.weatherCity.innerText = "Weather Unavailable";
            }
        }

        function getWeatherIcon(code) {
            if (code <= 1) return '<i class="fas fa-sun text-yellow-400"></i>';
            if (code <= 3) return '<i class="fas fa-cloud-sun text-gray-300"></i>';
            if (code <= 48) return '<i class="fas fa-smog text-gray-400"></i>';
            if (code <= 67) return '<i class="fas fa-cloud-rain text-blue-400"></i>';
            if (code <= 77) return '<i class="fas fa-snowflake text-white"></i>';
            if (code <= 82) return '<i class="fas fa-cloud-showers-heavy text-blue-500"></i>';
            if (code <= 99) return '<i class="fas fa-bolt text-yellow-500"></i>';
            return '<i class="fas fa-cloud"></i>';
        }

        async function fetchCalendar(url) {
            if (!url || !url.startsWith('http')) {
                appData.externalEvents = [];
                mergeAndRenderEvents();
                return;
            }
            try {
                const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
                if (!res.ok) throw new Error('Proxy error');
                const icsData = await res.text();
                appData.externalEvents = parseICS(icsData);
                mergeAndRenderEvents();
            } catch (e) {
                console.warn("Primary calendar proxy failed, trying fallback...", e);
                try {
                     const res2 = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                     const data2 = await res2.json();
                     if (data2.contents) {
                        appData.externalEvents = parseICS(data2.contents);
                        mergeAndRenderEvents();
                     }
                } catch (err2) { console.error("All calendar fetches failed", err2); }
            }
        }

        function parseICS(icsData) {
            const events = [];
            const lines = icsData.split(/\r\n|\n|\r/);
            let inEvent = false;
            let currentEvent = {};
            const parseICSDate = (val) => {
                if(!val) return null;
                const year = val.substring(0,4);
                const month = val.substring(4,6);
                const day = val.substring(6,8);
                return `${year}-${month}-${day}`;
            };
            for (let line of lines) {
                if (line.startsWith('BEGIN:VEVENT')) {
                    inEvent = true;
                    currentEvent = {};
                } else if (line.startsWith('END:VEVENT')) {
                    inEvent = false;
                    if (currentEvent.start) {
                        const evtDate = new Date(currentEvent.start);
                        const today = new Date();
                        today.setHours(0,0,0,0);
                        if (evtDate >= today) events.push(currentEvent);
                    }
                } else if (inEvent) {
                    const parts = line.split(':');
                    const key = parts[0].split(';')[0];
                    const val = parts.slice(1).join(':');
                    if (key === 'DTSTART') currentEvent.start = parseICSDate(val);
                    if (key === 'SUMMARY') currentEvent.title = val;
                    if (key === 'LOCATION') currentEvent.location = val.replace(/\\,/g, ',');
                }
            }
            return events;
        }

        function mergeAndRenderEvents() {
            const allEvents = [
                ...appData.events.map(e => ({ ...e, source: 'manual', dateObj: new Date(e.datetime) })),
                ...appData.externalEvents.map(e => ({ ...e, source: 'google', dateObj: new Date(e.start), datetime: e.start }))
            ];
            allEvents.sort((a, b) => a.dateObj - b.dateObj);
            const displayEvents = allEvents.slice(0, 10);
            if (displayEvents.length === 0) {
                els.eventsList.innerHTML = `<div class="text-center text-gray-500 mt-4">No upcoming events.</div>`;
                return;
            }
            els.eventsList.innerHTML = displayEvents.map(e => {
                const date = new Date(e.datetime); 
                const month = date.toLocaleString('default', { month: 'short' });
                const day = date.getDate();
                const isGoogle = e.source === 'google';
                const borderColor = isGoogle ? 'border-green-500' : 'border-school-gold';
                return `
                <div class="flex items-center bg-gray-50 p-3 rounded-lg border-l-4 ${borderColor} shadow-sm hover:bg-gray-100 transition-colors">
                    <div class="flex-none w-12 h-12 bg-white rounded-lg border border-gray-200 flex flex-col items-center justify-center mr-3 shadow-sm">
                        <span class="text-xs font-bold text-gray-500 uppercase">${month}</span>
                        <span class="text-xl font-bold text-school-navy leading-none">${day}</span>
                    </div>
                    <div class="flex-grow min-w-0">
                        <h4 class="font-bold text-gray-800 truncate">${e.title}</h4>
                        <p class="text-xs text-gray-500 truncate"><i class="fas fa-map-marker-alt mr-1"></i> ${e.location || 'TBA'} ${isGoogle ? '(Google Cal)' : ''}</p>
                    </div>
                </div>
                `;
            }).join('');
        }

        // --- Utils ---
        function startClock() {
            setInterval(() => {
                const now = new Date();
                els.liveTime.innerText = now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                els.liveDate.innerText = now.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' });
            }, 1000);
        }

        // --- Admin Functions ---
        
        window.formatText = (identifier, tag) => {
            let textarea = document.querySelector(`textarea[name="${identifier}"]`);
            if (!textarea) textarea = document.getElementById(identifier);
            if (!textarea) return;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            textarea.value = text.substring(0, start) + `<${tag}>` + text.substring(start, end) + `</${tag}>` + text.substring(end);
            textarea.focus();
        };

        window.toggleAdminModal = () => {
            document.getElementById('admin-modal').classList.toggle('hidden');
        };

        window.switchTab = (tabId) => {
            document.querySelectorAll('.admin-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.admin-tab-btn').forEach(el => {
                el.classList.remove('bg-white', 'shadow-sm', 'border-l-4', 'border-school-navy', 'text-school-navy');
                el.classList.add('border-transparent');
            });
            document.getElementById(tabId).classList.remove('hidden');
            const btn = Array.from(document.querySelectorAll('.admin-tab-btn')).find(b => b.getAttribute('onclick').includes(tabId));
            if(btn) {
                btn.classList.add('bg-white', 'shadow-sm', 'border-l-4', 'border-school-navy', 'text-school-navy');
                btn.classList.remove('border-transparent');
            }
        };

        window.saveTicker = async () => {
            const text = document.getElementById('ticker-input').value; // Wait, ticker is list now, this is legacy function if we used simple text. 
            // We are using list management for ticker, so this function isn't used by the new UI, but kept just in case.
        };
        
        window.saveMediaSlot = async (slot) => {
            const type = document.getElementById(`media-${slot}-type`).value;
            const content = document.getElementById(`media-${slot}-content`).value;
            
            showLoader();
            try {
                await setDoc(doc(getCollectionRef(COLLECTIONS.MEDIA), slot), { type, content });
            } catch(e) { console.error(e); }
            hideLoader();
        };

        window.saveConfig = async () => {
            showLoader();
            try {
                const logoFile = document.getElementById('conf-logo-file').files[0];
                let logoBase64 = appData.settings?.logo || "";
                if (logoFile) {
                    try { logoBase64 = await convertBase64(logoFile); } catch (err) { console.error(err); }
                }
                const conf = {
                    schoolName: els.confName.value,
                    subtitle: els.confSubtitle.value,
                    subtitle2: els.confSubtitle2.value,
                    location: els.confLocation.value,
                    googleCalendar: els.confCalendar.value,
                    logo: logoBase64
                };
                if (appData.settingsId) {
                    await updateDoc(doc(getCollectionRef(COLLECTIONS.SETTINGS), appData.settingsId), conf);
                } else {
                    await addDoc(getCollectionRef(COLLECTIONS.SETTINGS), conf);
                }
            } catch(e) { console.error(e); }
            hideLoader();
        };

        function showLoader() { document.getElementById('global-loader').classList.remove('hidden'); }
        function hideLoader() { document.getElementById('global-loader').classList.add('hidden'); }

        // --- Admin CRUD UI Generators ---

        function renderAdminList(type, data) {
            const container = els[`admin${type.charAt(0).toUpperCase() + type.slice(1)}`];
            if (!container) return;
            if (data.length === 0) {
                container.innerHTML = `<p class="text-gray-500 italic col-span-3">No items found.</p>`;
                return;
            }
            container.innerHTML = data.map(item => {
                let mainText = item.title || item.name || item.text;
                let subText = item.description || item.dept || item.datetime || '';
                let img = item.image;
                if (type === 'ticker') {
                     const tmp = document.createElement("DIV");
                     tmp.innerHTML = mainText;
                     mainText = tmp.textContent || tmp.innerText || "";
                     subText = "Ticker Message";
                }
                return `
                <div class="bg-white p-4 rounded-lg shadow border border-gray-200 flex justify-between items-start group">
                    <div class="flex items-start space-x-3 overflow-hidden">
                        ${img ? `<img src="${img}" class="w-10 h-10 rounded-full object-cover border">` : ''}
                        <div class="min-w-0">
                            <h4 class="font-bold text-gray-800 truncate text-sm">${mainText}</h4>
                            <p class="text-xs text-gray-500 truncate">${subText || ''}</p>
                        </div>
                    </div>
                    <div class="flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="editEntry('${type}', '${item.id}')" class="text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteEntry('${type}', '${item.id}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }).join('');
        }

        // --- Entry Modal Logic ---
        let currentEditType = null;
        let currentEditId = null;

        window.openEntryModal = (type) => {
            currentEditType = type;
            currentEditId = null;
            document.getElementById('entry-modal-title').innerText = `Add ${type.charAt(0).toUpperCase() + type.slice(1, type.endsWith('s') ? -1 : undefined)}`; 
            document.getElementById('entry-form').reset();
            generateFormFields(type, null);
            document.getElementById('entry-modal').classList.remove('hidden');
        };

        window.editEntry = (type, id) => {
            currentEditType = type;
            currentEditId = id;
            const item = appData[type].find(i => i.id === id);
            if (!item) return;
            document.getElementById('entry-modal-title').innerText = `Edit ${type.charAt(0).toUpperCase() + type.slice(1, type.endsWith('s') ? -1 : undefined)}`;
            generateFormFields(type, item);
            document.getElementById('entry-modal').classList.remove('hidden');
        };

        window.closeEntryModal = () => {
            document.getElementById('entry-modal').classList.add('hidden');
        };

        window.deleteEntry = async (type, id) => {
            if(!confirm("Are you sure?")) return;
            showLoader();
            try { await deleteDoc(doc(getCollectionRef(type), id)); } catch(e) { console.error(e); }
            hideLoader();
        };

        window.handleEntrySubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            if (currentEditType === 'announcements') data.urgent = formData.get('urgent') === 'on';
            const fileInput = document.getElementById('form-image-file');
            if (fileInput && fileInput.files.length > 0) {
                try { data.image = await convertBase64(fileInput.files[0]); } catch(err) { console.error("Image error"); }
            } else if (!data.image && currentEditId) {
                 const oldItem = appData[currentEditType].find(i => i.id === currentEditId);
                 if(oldItem) data.image = oldItem.image;
            }
            if (data.image && data.image.includes('drive.google.com')) {
                const idMatch = data.image.match(/[-\w]{25,}/);
                if(idMatch) data.image = `https://lh3.googleusercontent.com/d/${idMatch[0]}`;
            }
            showLoader();
            try {
                if (currentEditId) await updateDoc(doc(getCollectionRef(currentEditType), currentEditId), data);
                else await addDoc(getCollectionRef(currentEditType), data);
                closeEntryModal();
            } catch(err) { console.error(err); alert("Error saving."); }
            hideLoader();
        };

        function generateFormFields(type, values) {
            const container = document.getElementById('entry-fields');
            let html = '';
            const v = values || {};
            const toolbar = (fieldName) => `
                <div class="space-x-1 flex items-center">
                    <button type="button" onclick="formatText('${fieldName}', 'b')" class="px-2 py-0.5 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold" title="Bold">B</button>
                    <button type="button" onclick="formatText('${fieldName}', 'i')" class="px-2 py-0.5 bg-gray-200 hover:bg-gray-300 rounded text-xs italic" title="Italic">I</button>
                </div>
            `;
            
            if (type === 'announcements') {
                html += `
                    <div><label class="block text-sm font-bold mb-1">Title</label><input name="title" required value="${v.title || ''}" class="w-full p-2 border rounded"></div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <div class="flex items-center"><label class="block text-sm font-bold mr-2">Description</label></div>
                            ${toolbar('description')}
                        </div>
                        <textarea name="description" required rows="3" class="w-full p-2 border rounded">${v.description || ''}</textarea>
                    </div>
                    <div class="flex items-center mt-2"><input type="checkbox" name="urgent" ${v.urgent ? 'checked' : ''} class="h-4 w-4"><label class="ml-2 text-sm font-bold text-red-600">Mark as Urgent</label></div>
                `;
            } else if (type === 'students') {
                html += `
                    <div><label class="block text-sm font-bold mb-1">Student Name</label><input name="name" required value="${v.name || ''}" class="w-full p-2 border rounded"></div>
                    <div><label class="block text-sm font-bold mb-1">Focus Area</label><input name="focus" placeholder="e.g. Science, Basketball" value="${v.focus || ''}" class="w-full p-2 border rounded"></div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <div class="flex items-center"><label class="block text-sm font-bold mr-2">Quote / Description</label></div>
                            ${toolbar('description')}
                        </div>
                        <textarea name="description" required rows="3" class="w-full p-2 border rounded">${v.description || ''}</textarea>
                    </div>
                `;
            } else if (type === 'teachers') {
                html += `
                    <div><label class="block text-sm font-bold mb-1">Name</label><input name="name" required value="${v.name || ''}" class="w-full p-2 border rounded"></div>
                    <div><label class="block text-sm font-bold mb-1">Department</label><select name="dept" class="w-full p-2 border rounded">${DEPARTMENTS.map(d => `<option value="${d}" ${v.dept === d ? 'selected' : ''}>${d}</option>`).join('')}</select></div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <div class="flex items-center"><label class="block text-sm font-bold mr-2">Bio</label></div>
                            ${toolbar('bio')}
                        </div>
                        <textarea name="bio" required rows="3" class="w-full p-2 border rounded">${v.bio || ''}</textarea>
                    </div>
                `;
            } else if (type === 'events') {
                html += `
                    <div><label class="block text-sm font-bold mb-1">Event Title</label><input name="title" required value="${v.title || ''}" class="w-full p-2 border rounded"></div>
                    <div><label class="block text-sm font-bold mb-1">Date</label><input type="date" name="datetime" required value="${v.datetime || ''}" class="w-full p-2 border rounded"></div>
                    <div><label class="block text-sm font-bold mb-1">Location</label><input name="location" value="${v.location || ''}" class="w-full p-2 border rounded"></div>
                `;
            } else if (type === 'ticker') {
                html += `
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <div class="flex items-center"><label class="block text-sm font-bold mr-2">Message</label></div>
                        </div>
                        <textarea name="text" required rows="3" class="w-full p-2 border rounded">${v.text || ''}</textarea>
                    </div>
                `;
            }
            if (type !== 'events' && type !== 'ticker') {
                html += `
                    <div class="border-t pt-4 mt-2">
                        <label class="block text-sm font-bold mb-1">Image (URL or Upload)</label>
                        <input name="image" placeholder="https://..." value="${v.image && v.image.startsWith('http') ? v.image : ''}" class="w-full p-2 border rounded mb-2 text-sm">
                        <input type="file" id="form-image-file" accept="image/*" class="text-sm">
                        <p class="text-xs text-gray-500 mt-1">Upload converts to Base64 (Max 1MB). URLs preferred.</p>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        const convertBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const fileReader = new FileReader();
                fileReader.readAsDataURL(file);
                fileReader.onload = () => resolve(fileReader.result);
                fileReader.onerror = (error) => reject(error);
            });
        };

    </script>
</body>
</html>