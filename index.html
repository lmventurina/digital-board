<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>School Digital Bulletin Board</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        school: {
                            navy: '#003893',
                            gold: '#facc15',
                            goldDark: '#eab308'
                        }
                    },
                    fontFamily: {
                        sans: ['Open Sans', 'sans-serif'],
                        display: ['Montserrat', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Custom CSS -->
    <style>
        body { overflow: hidden; }
        .school-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .ticker-wrap { width: 100%; overflow: hidden; background-color: #facc15; padding-left: 100%; box-sizing: content-box; }
        .ticker-move { display: inline-block; white-space: nowrap; padding-right: 100%; box-sizing: content-box; animation: ticker 20s linear infinite; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-enter { opacity: 0; }
        .fade-enter-active { opacity: 1; transition: opacity 500ms ease-in; }
        .fade-exit { opacity: 1; }
        .fade-exit-active { opacity: 0; transition: opacity 500ms ease-out; }
        .aspect-circle { aspect-ratio: 1 / 1; }
        iframe { width: 100%; height: 100%; border: none; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col font-sans text-gray-800">

    <!-- Header -->
    <header class="bg-school-navy text-white pt-3 px-4 pb-2 shadow-lg z-10 flex-none flex flex-col">
        <div class="flex justify-between items-center mb-1">
            <!-- Logo & School Info -->
            <div class="flex items-center space-x-4 w-1/3">
                <div class="h-20 w-20 bg-white rounded-full flex-none flex items-center justify-center border-4 border-school-gold overflow-hidden school-logo-container relative">
                    <img id="header-logo" src="https://placehold.co/100x100?text=Logo" alt="School Logo" class="h-full w-full object-cover">
                </div>
                <div class="min-w-0">
                    <h1 id="header-school-name" class="text-3xl font-display font-extrabold tracking-wide uppercase whitespace-nowrap overflow-visible">Navajo Pine HS</h1>
                    <p id="header-subtitle" class="text-school-gold font-semibold text-lg leading-tight">School of Technology</p>
                </div>
            </div>

            <!-- Clock & Date -->
            <div class="text-center w-1/3">
                <!-- Removed hardcoded 12:00 PM to prevent flash of wrong time -->
                <div id="live-time" class="text-5xl font-display font-bold tabular-nums leading-none">--:--</div>
                <div id="live-date" class="text-lg text-gray-200 mt-1 uppercase tracking-wider leading-none">Fetching Date...</div>
            </div>

            <!-- Weather Widget -->
            <div class="w-1/3 flex justify-end">
                <div class="bg-blue-900/50 rounded-xl p-2 backdrop-blur-sm border border-blue-700/50 flex items-center space-x-3 min-w-[260px]">
                    <div class="flex flex-col items-center justify-center px-2 border-r border-blue-700/50">
                        <span id="weather-city" class="text-[10px] text-school-gold font-bold uppercase mb-0 leading-none">Loading...</span>
                        <div class="text-2xl my-1" id="weather-current-icon"><i class="fas fa-cloud"></i></div>
                        <span id="weather-current-temp" class="text-lg font-bold leading-none">--°</span>
                    </div>
                    <div class="flex-1 flex justify-between text-center text-xs space-x-1" id="weather-forecast">
                        <!-- Forecast items injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Subtitle 2: Full Width -->
        <div class="w-full text-center border-t border-white/10 pt-2 mt-1">
            <p id="header-subtitle-2" class="text-gray-300 font-medium text-sm tracking-[0.2em] uppercase">Home of the Tech Warriors</p>
        </div>
    </header>

    <!-- Ticker -->
    <div class="bg-school-gold text-school-navy font-bold py-4 text-3xl border-b-4 border-school-navy/20 flex-none z-10 relative shadow-md w-full overflow-hidden">
        <div class="ticker-wrap">
            <div class="ticker-move" id="ticker-content">
                Welcome to our digital bulletin board! Go Tigers!
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <main class="flex-grow p-2 overflow-hidden flex flex-col md:flex-row gap-3">
        
        <!-- Main Grid (75%) -->
        <div class="w-full md:w-3/4 h-full">
            <div class="grid grid-cols-1 md:grid-cols-2 grid-rows-2 gap-3 h-full">
                
                <!-- Top Left: Student Spotlight -->
                <div class="bg-gradient-to-br from-white to-blue-100 rounded-2xl school-shadow border border-gray-200 flex flex-col overflow-hidden relative group">
                    <div class="bg-school-navy py-2 px-4 text-center">
                        <h2 class="text-white font-display font-bold text-xl"><i class="fas fa-star text-school-gold mr-2"></i> Student Spotlight</h2>
                    </div>
                    <div class="flex-grow relative p-6 flex items-center justify-center" id="student-carousel">
                        <div class="text-center w-full"><p class="text-gray-400">Loading...</p></div>
                    </div>
                    <div class="absolute bottom-0 left-0 h-1 bg-school-gold transition-all duration-300" id="student-progress" style="width: 0%"></div>
                </div>

                <!-- Top Right: Teacher Feature -->
                <div class="bg-gradient-to-br from-white to-yellow-100 rounded-2xl school-shadow border border-gray-200 flex flex-col overflow-hidden relative">
                    <div class="bg-school-navy py-2 px-4 text-center">
                        <h2 class="text-white font-display font-bold text-xl"><i class="fas fa-chalkboard-teacher text-school-gold mr-2"></i> Teacher/Staff Feature</h2>
                    </div>
                    <div class="flex-grow relative p-6 flex items-center justify-center" id="teacher-carousel">
                         <div class="text-center w-full"><p class="text-gray-400">Loading...</p></div>
                    </div>
                    <div class="absolute bottom-0 left-0 h-1 bg-school-gold transition-all duration-300" id="teacher-progress" style="width: 0%"></div>
                </div>

                <!-- Bottom Left: Announcements -->
                <div class="bg-gradient-to-br from-white to-blue-50 rounded-2xl school-shadow border border-gray-200 flex flex-col overflow-hidden relative">
                    <div class="bg-school-navy py-2 px-4 text-center">
                        <h2 class="text-white font-display font-bold text-xl"><i class="fas fa-bullhorn text-school-gold mr-2"></i> Announcements</h2>
                    </div>
                    <div class="flex-grow relative p-6 flex items-center justify-center" id="announcement-carousel">
                         <div class="text-center w-full"><p class="text-gray-400">No Announcements</p></div>
                    </div>
                    <div class="absolute bottom-0 left-0 h-1 bg-school-gold transition-all duration-300" id="announcement-progress" style="width: 0%"></div>
                </div>

                <!-- Bottom Right: Media Feed -->
                <div class="bg-black rounded-2xl school-shadow border border-gray-200 flex flex-col overflow-hidden relative" id="media-slot-main">
                    <div class="bg-school-navy py-2 px-4">
                        <h3 class="text-white font-display font-bold text-xl"><i class="fas fa-photo-video text-school-gold mr-2"></i> Media Feed</h3>
                    </div>
                    <div class="flex-grow bg-black relative" id="media-carousel">
                        <!-- Dynamic Media Content -->
                        <div class="absolute inset-0 flex items-center justify-center text-gray-500 text-sm">
                            <div class="text-center">
                                <i class="fas fa-play-circle fa-2x mb-2"></i>
                                <p>No Media Set</p>
                            </div>
                        </div>
                    </div>
                    <div class="absolute bottom-0 left-0 h-1 bg-school-gold transition-all duration-300 z-10" id="media-progress" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Sidebar / Aside (25%) - Upcoming Events -->
        <aside class="w-full md:w-1/4 h-full flex flex-col">
            <div class="bg-gradient-to-br from-white to-gray-200 rounded-2xl school-shadow border border-gray-200 flex flex-col overflow-hidden h-full">
                <div class="bg-school-navy py-2 px-4 flex justify-between items-center">
                    <h2 class="text-white font-display font-bold text-xl"><i class="fas fa-calendar-alt text-school-gold mr-2"></i> Events</h2>
                    <span class="text-xs text-white bg-blue-800 px-2 py-1 rounded">Upcoming</span>
                </div>
                <div class="flex-grow overflow-y-auto custom-scrollbar p-4" id="events-list">
                        <div class="text-center w-full text-gray-400 mt-4">Loading Events...</div>
                </div>
            </div>
        </aside>

    </main>

    <!-- Admin Button (Anonymous) -->
    <button onclick="handleAdminClick()" class="fixed bottom-6 right-6 bg-gray-800/80 hover:bg-school-navy text-white p-4 rounded-full shadow-2xl transition-all duration-300 hover:scale-110 z-50 backdrop-blur">
        <i class="fas fa-cog fa-lg"></i>
    </button>

    <!-- Admin Modal -->
    <div id="admin-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-5xl h-[85vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
            <!-- Modal Header -->
            <div class="bg-gray-800 text-white p-4 flex justify-between items-center">
                <h3 class="text-xl font-bold font-display"><i class="fas fa-sliders-h mr-2"></i> Dashboard Configuration</h3>
                <button onclick="toggleAdminModal()" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="flex flex-grow overflow-hidden">
                <!-- Sidebar Tabs -->
                <div class="w-1/5 bg-gray-100 border-r border-gray-200 overflow-y-auto">
                    <nav class="flex flex-col p-2 space-y-1" id="admin-tabs">
                        <button onclick="switchTab('tab-announcements')" class="admin-tab-btn active text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-bullhorn w-6"></i> Announcements
                        </button>
                        <button onclick="switchTab('tab-students')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-user-graduate w-6"></i> Students
                        </button>
                        <button onclick="switchTab('tab-teachers')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-chalkboard-teacher w-6"></i> Teacher/Staff
                        </button>
                        <button onclick="switchTab('tab-events')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-calendar-alt w-6"></i> Events
                        </button>
                        <button onclick="switchTab('tab-ticker')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-scroll w-6"></i> Ticker
                        </button>
                         <button onclick="switchTab('tab-media')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-photo-video w-6"></i> Media Sidebar
                        </button>
                        <button onclick="switchTab('tab-config')" class="admin-tab-btn text-left px-4 py-3 rounded-lg font-medium text-gray-700 hover:bg-white hover:shadow-sm transition-all focus:outline-none border-l-4 border-transparent">
                            <i class="fas fa-tools w-6"></i> Config
                        </button>
                    </nav>
                </div>

                <!-- Content Area -->
                <div class="w-4/5 p-8 overflow-y-auto bg-gray-50 relative">
                    
                    <!-- Tab: Announcements -->
                    <div id="tab-announcements" class="admin-content block">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Manage Announcements</h2>
                            <button onclick="openEntryModal('announcements')" class="bg-school-navy hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition-colors"><i class="fas fa-plus mr-2"></i> Add New</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="admin-announcements-list"></div>
                    </div>

                    <!-- Tab: Students -->
                    <div id="tab-students" class="admin-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Manage Student Spotlight</h2>
                            <button onclick="openEntryModal('students')" class="bg-school-navy hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition-colors"><i class="fas fa-plus mr-2"></i> Add Student</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="admin-students-list"></div>
                    </div>

                    <!-- Tab: Teachers -->
                    <div id="tab-teachers" class="admin-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Manage Teacher/Staff Features</h2>
                            <button onclick="openEntryModal('teachers')" class="bg-school-navy hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition-colors"><i class="fas fa-plus mr-2"></i> Add Feature</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="admin-teachers-list"></div>
                    </div>

                    <!-- Tab: Events -->
                    <div id="tab-events" class="admin-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Manage Manual Events</h2>
                            <button onclick="openEntryModal('events')" class="bg-school-navy hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition-colors"><i class="fas fa-plus mr-2"></i> Add Event</button>
                        </div>
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                            <p class="text-sm text-blue-700"><strong>Note:</strong> Events from your Google Calendar link (set in Config) are fetched automatically. Add manual events here for things not on the calendar.</p>
                        </div>
                        <div class="space-y-2" id="admin-events-list"></div>
                    </div>

                    <!-- Tab: Ticker -->
                    <div id="tab-ticker" class="admin-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Manage Ticker Messages</h2>
                            <button onclick="openEntryModal('ticker')" class="bg-school-navy hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition-colors"><i class="fas fa-plus mr-2"></i> Add Message</button>
                        </div>
                        <div class="space-y-2" id="admin-ticker-list"></div>
                    </div>

                    <!-- Tab: Media Sidebar -->
                    <div id="tab-media" class="admin-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Manage Media Sidebar</h2>
                            <button onclick="openEntryModal('media')" class="bg-school-navy hover:bg-blue-800 text-white px-4 py-2 rounded-lg shadow transition-colors"><i class="fas fa-plus mr-2"></i> Add Media</button>
                        </div>
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                            <p class="text-sm text-blue-700">
                                <strong>Instructions:</strong> Add YouTube videos, Facebook embeds, or Images. These items will rotate automatically in the sidebar. <br>
                                <strong>Note:</strong> Carousel will wait for videos to finish playing before rotating.
                            </p>
                        </div>
                        <div class="space-y-2" id="admin-media-list"></div>
                    </div>

                    <!-- Tab: Config -->
                    <div id="tab-config" class="admin-content hidden">
                        <div class="max-w-3xl mx-auto space-y-6">
                            <div class="bg-white p-6 rounded-xl shadow-sm border">
                                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">School Identity</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <div class="flex justify-between items-center mb-1">
                                            <label class="block text-sm font-medium text-gray-700">School Name</label>
                                            <div class="space-x-1">
                                                <button type="button" onclick="formatText('conf-name', 'b')" class="px-2 py-0.5 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold" title="Bold">B</button>
                                                <button type="button" onclick="formatText('conf-name', 'i')" class="px-2 py-0.5 bg-gray-200 hover:bg-gray-300 rounded text-xs italic" title="Italic">I</button>
                                            </div>
                                        </div>
                                        <input type="text" id="conf-name" class="w-full p-2 border rounded">
                                    </div>
                                    <div>
                                        <div class="flex justify-between items-center mb-1">
                                            <label class="block text-sm font-medium text-gray-700">Subtitle</label>
                                            <div class="space-x-1">
                                                <button type="button" onclick="formatText('conf-subtitle', 'b')" class="px-2 py-0.5 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold" title="Bold">B</button>
                                                <button type="button" onclick="formatText('conf-subtitle', 'i')" class="px-2 py-0.5 bg-gray-200 hover:bg-gray-300 rounded text-xs italic" title="Italic">I</button>
                                            </div>
                                        </div>
                                        <input type="text" id="conf-subtitle" class="w-full p-2 border rounded">
                                    </div>
                                    <div class="md:col-span-2">
                                        <div class="flex justify-between items-center mb-1">
                                            <label class="block text-sm font-medium text-gray-700">Subtitle 2</label>
                                            <div class="space-x-1">
                                                <button type="button" onclick="formatText('conf-subtitle-2', 'b')" class="px-2 py-0.5 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold" title="Bold">B</button>
                                                <button type="button" onclick="formatText('conf-subtitle-2', 'i')" class="px-2 py-0.5 bg-gray-200 hover:bg-gray-300 rounded text-xs italic" title="Italic">I</button>
                                            </div>
                                        </div>
                                        <input type="text" id="conf-subtitle-2" class="w-full p-2 border rounded" placeholder="e.g. Home of the Tech Warriors">
                                    </div>
                                    
                                    <!-- Logo Upload Section -->
                                    <div class="md:col-span-2 border-t pt-4 mt-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">School Logo</label>
                                        <div class="flex items-center space-x-4">
                                            <div class="h-16 w-16 bg-white rounded-full border flex items-center justify-center overflow-hidden flex-none">
                                                 <img id="conf-logo-preview" src="https://placehold.co/100x100?text=Logo" class="h-full w-full object-cover">
                                            </div>
                                            <input type="file" id="conf-logo-file" accept="image/*" class="text-sm block w-full text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-school-navy/10 file:text-school-navy hover:file:bg-school-navy/20">
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1 ml-20">Upload a square image (PNG/JPG). Max 1MB (Firestore limit).</p>
                                    </div>

                                </div>
                            </div>
                            
                            <div class="bg-white p-6 rounded-xl shadow-sm border">
                                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Integrations</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Weather Location (City, State)</label>
                                        <input type="text" id="conf-location" class="w-full p-2 border rounded" placeholder="e.g. Navajo, NM">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Google Calendar Public iCal Link (.ics)</label>
                                        <input type="text" id="conf-calendar" class="w-full p-2 border rounded" placeholder="https://calendar.google.com/.../basic.ics">
                                        <p class="text-xs text-gray-500 mt-1">Paste the "Public address in iCal format" from your Google Calendar settings.</p>
                                    </div>
                                </div>
                            </div>

                            <button onclick="saveConfig()" class="w-full bg-school-navy hover:bg-blue-800 text-white font-bold py-3 rounded-lg transition-colors shadow">Save Configuration</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Entry Edit/Add Modal (Generic) -->
    <div id="entry-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative">
            <h3 id="entry-modal-title" class="text-xl font-bold mb-4">Add Item</h3>
            <form id="entry-form" onsubmit="handleEntrySubmit(event)" class="space-y-4">
                <!-- Dynamic Fields injected here -->
                <div id="entry-fields"></div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeEntryModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-school-navy text-white rounded hover:bg-blue-800">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="global-loader" class="fixed top-4 right-4 bg-white px-4 py-2 rounded-full shadow-lg z-[100] hidden flex items-center space-x-2">
        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-school-navy"></div>
        <span class="text-xs font-bold text-school-navy">Saving...</span>
    </div>

    <!-- Main Logic -->
    <script type="module">
        // !!! UPDATED: Reverted to Version 10.12.2 to match original app.js and fix 404s !!!
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, setDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Inject YouTube IFrame API
        let ytApiReady = false;
        window.onYouTubeIframeAPIReady = () => { ytApiReady = true; };
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // --- Configuration ---
        // Robust Config: Checks for environment variable (Canvas) OR uses Fallback (Local/GitHub)
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            // Fallback to original app.js credentials
            firebaseConfig = {
                apiKey: "AIzaSyAtawxqfPOZqKJZcClKBVXSClC3IsIuDtM",
                authDomain: "digital-bulletin-board-6c660.firebaseapp.com",
                projectId: "digital-bulletin-board-6c660",
                storageBucket: "digital-bulletin-board-6c660.firebasestorage.app",
                messagingSenderId: "1051324595132",
                appId: "1:1051324595132:web:bb95ce7acc65d9e80d49b9",
                measurementId: "G-6VW2SKC09Z"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Handle appId similarly
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'navajo-pine-hs-v1'; 

        let currentUser = null;
        let appData = { announcements: [], students: [], teachers: [], events: [], externalEvents: [], ticker: "", settings: {}, media: [] };

        const DEPARTMENTS = ["General", "Admin", "History", "Navajo Language", "Math", "ELA", "Science", "Tech", "Special Ed", "PE", "Health", "Welding", "Sports", "Music", "Art"];
        const COLLECTIONS = { ANNOUNCEMENTS: 'announcements', STUDENTS: 'students', TEACHERS: 'teachers', EVENTS: 'events', TICKER: 'ticker', SETTINGS: 'settings', MEDIA: 'media' };

        const els = {
            schoolName: document.getElementById('header-school-name'),
            schoolSubtitle: document.getElementById('header-subtitle'),
            schoolSubtitle2: document.getElementById('header-subtitle-2'),
            liveTime: document.getElementById('live-time'),
            liveDate: document.getElementById('live-date'),
            ticker: document.getElementById('ticker-content'),
            studentCarousel: document.getElementById('student-carousel'),
            studentProgress: document.getElementById('student-progress'),
            teacherCarousel: document.getElementById('teacher-carousel'),
            teacherProgress: document.getElementById('teacher-progress'),
            announcementCarousel: document.getElementById('announcement-carousel'),
            announcementProgress: document.getElementById('announcement-progress'),
            mediaCarousel: document.getElementById('media-carousel'),
            mediaProgress: document.getElementById('media-progress'),
            eventsList: document.getElementById('events-list'),
            weatherCity: document.getElementById('weather-city'),
            weatherIcon: document.getElementById('weather-current-icon'),
            weatherTemp: document.getElementById('weather-current-temp'),
            weatherForecast: document.getElementById('weather-forecast'),
            adminAnnouncements: document.getElementById('admin-announcements-list'),
            adminStudents: document.getElementById('admin-students-list'),
            adminTeachers: document.getElementById('admin-teachers-list'),
            adminEvents: document.getElementById('admin-events-list'),
            adminTicker: document.getElementById('admin-ticker-list'),
            adminMedia: document.getElementById('admin-media-list'),
            confName: document.getElementById('conf-name'),
            confSubtitle: document.getElementById('conf-subtitle'),
            confSubtitle2: document.getElementById('conf-subtitle-2'),
            confLocation: document.getElementById('conf-location'),
            confCalendar: document.getElementById('conf-calendar')
        };

        // --- Authentication & Initialization ---
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Auth failed", e);
            }
        }
        initAuth();

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                console.log("Connected as User:", user.uid);
                setupListeners();
            }
        });

        // --- Missing Functions Implementation ---
        function startClock() {
            const update = () => {
                const now = new Date();
                els.liveTime.innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                els.liveDate.innerText = now.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' });
            };
            update();
            setInterval(update, 1000);
        }
        startClock();

        let weatherInterval;
        async function fetchWeather(location) {
            if (!location) {
                els.weatherCity.innerText = "NO LOCATION";
                return;
            }
            els.weatherCity.innerText = location;
            
            // Simple Open-Meteo Integration
            // 1. Geocoding (Simulated for common places or using a simple heuristic)
            // For this demo, we will use coordinates for Navajo, NM as default if lookup fails
            // Navajo, NM: 35.8973, -109.0289
            let lat = 35.8973;
            let lon = -109.0289;

            // Very basic "Geocoding" for demo purposes. 
            // In a real production app, use Google Maps Geocoding API or OpenStreetMap Nominatim.
            if (location.toLowerCase().includes('gallup')) { lat = 35.5281; lon = -108.7426; }
            if (location.toLowerCase().includes('window rock')) { lat = 35.6731; lon = -109.0556; }
            if (location.toLowerCase().includes('albuquerque')) { lat = 35.0844; lon = -106.6504; }

            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,weathercode&temperature_unit=fahrenheit&timezone=auto`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                
                // Helper to map WMO codes to Font Awesome
                const getWeatherIcon = (code) => {
                    if (code <= 1) return 'fa-sun';
                    if (code <= 3) return 'fa-cloud-sun';
                    if (code <= 48) return 'fa-smog';
                    if (code <= 67) return 'fa-cloud-rain';
                    if (code <= 77) return 'fa-snowflake';
                    if (code <= 82) return 'fa-cloud-showers-heavy';
                    if (code <= 86) return 'fa-snowflake';
                    return 'fa-bolt'; // 95+
                };

                if (data.current_weather) {
                    els.weatherTemp.innerText = `${Math.round(data.current_weather.temperature)}°`;
                    const iconClass = getWeatherIcon(data.current_weather.weathercode);
                    els.weatherIcon.innerHTML = `<i class="fas ${iconClass}"></i>`;
                }

                if (data.daily) {
                    let forecastHtml = '';
                    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                    for(let i=1; i<=3; i++) {
                        const d = new Date(data.daily.time[i]);
                        // Fix for timezone offset in daily strings
                        d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
                        
                        const dayName = days[d.getDay()];
                        const max = Math.round(data.daily.temperature_2m_max[i]);
                        const min = Math.round(data.daily.temperature_2m_min[i]);
                        // Get icon for the day
                        const dayIcon = getWeatherIcon(data.daily.weathercode[i]);

                        forecastHtml += `
                            <div class="flex flex-col items-center">
                                <span class="font-bold text-school-gold text-[10px] uppercase mb-0.5">${dayName}</span>
                                <i class="fas ${dayIcon} text-white mb-0.5 text-xs"></i>
                                <span class="text-[10px] font-semibold">${max}°/${min}°</span>
                            </div>
                        `;
                    }
                    els.weatherForecast.innerHTML = forecastHtml;
                }

            } catch (e) {
                console.error("Weather Fetch Error", e);
                els.weatherCity.innerText = "Weather Unavail";
            }
        }

        async function fetchCalendar(icalUrl) {
            // Mocking logic for demo since direct iCal fetch is CORS blocked
            if(icalUrl && icalUrl.length > 10) {
               console.log("Calendar URL recognized:", icalUrl);
               // In production, use a proxy to fetch this URL
               appData.externalEvents = [
                   { title: "School Board Mtg", datetime: new Date(Date.now() + 86400000).toISOString().split('T')[0], location: "Admin" },
                   { title: "Early Release", datetime: new Date(Date.now() + 172800000).toISOString().split('T')[0], location: "Campus" }
               ];
               mergeAndRenderEvents();
            } else {
                appData.externalEvents = [];
                mergeAndRenderEvents();
            }
        }

        // --- Auth Functions ---
        window.handleAdminClick = () => {
            document.getElementById('admin-modal').classList.remove('hidden');
        };

        // --- Firebase Listeners ---
        function getCollectionRef(colName) {
            return collection(db, 'artifacts', appId, 'public', 'data', colName);
        }

        function setupListeners() {
            if(window.listenersActive) return;
            window.listenersActive = true;

            const listen = (colName, callback) => {
                onSnapshot(getCollectionRef(colName), (snapshot) => {
                    const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    callback(data);
                }, (error) => console.error(`Error listening to ${colName}:`, error));
            };

            listen(COLLECTIONS.ANNOUNCEMENTS, (data) => {
                appData.announcements = data;
                renderCarousel('announcement', data);
                renderAdminList('announcements', data);
            });

            listen(COLLECTIONS.STUDENTS, (data) => {
                appData.students = data;
                renderCarousel('student', data);
                renderAdminList('students', data);
            });

            listen(COLLECTIONS.TEACHERS, (data) => {
                appData.teachers = data;
                renderCarousel('teacher', data);
                renderAdminList('teachers', data);
            });

            listen(COLLECTIONS.EVENTS, (data) => {
                appData.events = data;
                mergeAndRenderEvents();
                renderAdminList('events', data);
            });

            listen(COLLECTIONS.TICKER, (data) => {
                if (data.length > 0) {
                    appData.ticker = data;
                    const combinedText = data.map(item => item.text).join(' &nbsp; <span class="text-school-navy/50 mx-2">●</span> &nbsp; ');
                    els.ticker.innerHTML = combinedText;
                } else {
                     els.ticker.innerHTML = "Welcome to School Board";
                }
                renderAdminList('ticker', data);
            });

            listen(COLLECTIONS.SETTINGS, (data) => {
                if (data.length > 0) {
                    appData.settings = data[0];
                    appData.settingsId = data[0].id;
                    updateUIConfig(data[0]);
                } else {
                    // Create default settings if they don't exist
                    if(currentUser) {
                        const defaults = {
                            schoolName: "Navajo Pine HS",
                            subtitle: "School of Technology",
                            subtitle2: "<b><i>Home of the Tech Warriors (Tó éí Tech Naalʼánígíí Kéyah)</i></b>",
                            location: "Navajo, NM",
                            googleCalendar: ""
                        };
                        addDoc(getCollectionRef(COLLECTIONS.SETTINGS), defaults);
                    }
                }
            });

            listen(COLLECTIONS.MEDIA, (data) => {
                appData.media = data;
                renderCarousel('media', data);
                renderAdminList('media', data);
            });
        }

        // --- Core Logic ---
        function updateUIConfig(settings) {
            if(settings.schoolName) els.schoolName.innerHTML = settings.schoolName;
            if(settings.subtitle) els.schoolSubtitle.innerHTML = settings.subtitle;
            if(settings.subtitle2) els.schoolSubtitle2.innerHTML = settings.subtitle2;
            if(settings.logo) {
                document.getElementById('header-logo').src = settings.logo;
            }
            els.confName.value = settings.schoolName || "";
            els.confSubtitle.value = settings.subtitle || "";
            els.confSubtitle2.value = settings.subtitle2 || "";
            els.confLocation.value = settings.location || "";
            els.confCalendar.value = settings.googleCalendar || "";
            
            // Call API functions
            fetchWeather(settings.location);
            fetchCalendar(settings.googleCalendar);
        }

        function mergeAndRenderEvents() {
            const all = [...appData.events, ...appData.externalEvents];
            // Sort by date
            all.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
            
            // Filter past events (keep today + future)
            const now = new Date();
            now.setHours(0,0,0,0);
            const upcoming = all.filter(e => new Date(e.datetime) >= now);

            if (upcoming.length === 0) {
                els.eventsList.innerHTML = `<p class="text-center text-gray-400 mt-4">No Upcoming Events</p>`;
                return;
            }

            els.eventsList.innerHTML = upcoming.map(e => {
                const d = new Date(e.datetime);
                // Fix for timezone offset
                d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
                
                const month = d.toLocaleDateString([], {month:'short'});
                const day = d.toLocaleDateString([], {day:'numeric'});
                return `
                <div class="flex items-center bg-white p-3 rounded-lg shadow-sm mb-3 border-l-4 border-school-navy">
                    <div class="flex-none w-12 text-center">
                        <div class="text-xs font-bold text-gray-500 uppercase">${month}</div>
                        <div class="text-xl font-bold text-school-navy leading-none">${day}</div>
                    </div>
                    <div class="ml-3">
                        <h4 class="font-bold text-sm text-gray-800 leading-tight">${e.title}</h4>
                        <p class="text-xs text-gray-500">${e.location || 'TBA'}</p>
                    </div>
                </div>`;
            }).join('');
        }

        // Carousel Logic
        const carousels = {
            student: { index: 0, timer: null, interval: 8000 },
            teacher: { index: 0, timer: null, interval: 10000 },
            announcement: { index: 0, timer: null, interval: 12000 },
            media: { index: 0, timer: null, interval: 15000 }
        };

        function extractYouTubeID(url) {
            let videoId = '';
            try {
                const u = new URL(url);
                if (u.hostname.includes('youtube.com')) {
                    if (u.searchParams.has('v')) videoId = u.searchParams.get('v');
                    else if (u.pathname.includes('/shorts/')) videoId = u.pathname.split('/shorts/')[1];
                    else if (u.pathname.includes('/embed/')) videoId = u.pathname.split('/embed/')[1];
                } else if (u.hostname.includes('youtu.be')) {
                    videoId = u.pathname.slice(1);
                }
            } catch(e) {}
            return videoId ? videoId.split('?')[0].split('&')[0] : null;
        }

        function renderCarousel(type, data) {
            const container = els[`${type}Carousel`];
            const progressBar = els[`${type}Progress`];
            const config = carousels[type];

            if (config.timer) { clearTimeout(config.timer); clearInterval(config.timer); }
            if (type === 'media' && window.currentMediaPlayer) { try { window.currentMediaPlayer.destroy(); } catch(e){} window.currentMediaPlayer = null; }

            if (!data || data.length === 0) {
                container.innerHTML = `<div class="w-full h-full flex items-center justify-center text-center text-gray-400">No content available</div>`;
                return;
            }
            if (config.index >= data.length) config.index = 0;

            const showSlide = () => {
                // Clear any running timer to prevent overlaps
                if (config.timer) clearTimeout(config.timer);
                
                // Cleanup previous media player if exists
                if (type === 'media' && window.currentMediaPlayer) { 
                    try { window.currentMediaPlayer.destroy(); } catch(e){} 
                    window.currentMediaPlayer = null; 
                }

                if (progressBar) { progressBar.style.transition = 'none'; progressBar.style.width = '0%'; }
                const item = data[config.index];
                container.innerHTML = `<div class="w-full h-full flex flex-col items-center justify-center opacity-0 transition-opacity duration-500 relative" id="${type}-slide-content"></div>`;
                const slide = document.getElementById(`${type}-slide-content`);
                
                const queueNext = (delay) => {
                    if (progressBar) { setTimeout(() => { progressBar.style.transition = `width ${delay}ms linear`; progressBar.style.width = '100%'; }, 50); }
                    config.timer = setTimeout(() => { config.index = (config.index + 1) % data.length; showSlide(); }, delay);
                };

                if (type === 'media' && item.type === 'youtube') {
                    slide.classList.remove('opacity-0'); 
                    let videoId = extractYouTubeID(item.content);
                    if (videoId && ytApiReady) {
                        const playerId = `yt-player-${Date.now()}`;
                        slide.innerHTML = `<div id="${playerId}" style="width:100%; height:100%;"></div>`;
                        
                        const origin = window.location.protocol.startsWith('http') ? window.location.origin : undefined;

                        window.currentMediaPlayer = new YT.Player(playerId, {
                            height: '100%', width: '100%', videoId: videoId,
                            playerVars: { 
                                'autoplay': 1, 
                                'controls': 0, 
                                'rel': 0, 
                                'showinfo': 0, 
                                'modestbranding': 1, 
                                'mute': 0, 
                                'origin': origin, 
                                'enablejsapi': 1,
                                'iv_load_policy': 3 // Removes video annotations/popups
                            },
                            events: {
                                'onReady': (event) => { event.target.playVideo(); },
                                // event.data === 0 is YT.PlayerState.ENDED. This ensures we wait for video to finish.
                                'onStateChange': (event) => { if (event.data === 0) { config.index = (config.index + 1) % data.length; showSlide(); } },
                                'onError': (e) => { 
                                    console.warn("Skipping restricted/unavailable video."); 
                                    slide.innerHTML = `<div class="flex items-center justify-center h-full text-white bg-black"><p>Video Unavailable</p></div>`; 
                                    queueNext(3000); 
                                }
                            }
                        });
                        // Fallback timer: Force next slide after 10 minutes if video gets stuck or is infinite
                        config.timer = setTimeout(() => { config.index = (config.index + 1) % data.length; showSlide(); }, 600000); 
                    } else {
                        slide.innerHTML = `<p class="text-red-500">Video Loading...</p>`;
                        if (!ytApiReady) setTimeout(showSlide, 1000); else queueNext(5000);
                    }
                } else if (type === 'media' && item.type === 'facebook') {
                    slide.innerHTML = item.content.includes('<iframe') ? item.content : `<div class="flex items-center justify-center h-full text-red-500 font-bold">Invalid Embed Code</div>`;
                    const fbFrame = slide.querySelector('iframe');
                    if (fbFrame) { fbFrame.style.width = '100%'; fbFrame.style.height = '100%'; }
                    setTimeout(() => slide.classList.remove('opacity-0'), 50);
                    queueNext(config.interval);
                } else {
                    // Standard content
                    if (type === 'media' && item.type === 'image') {
                         slide.innerHTML = `<img src="${item.content}" class="w-full h-full object-cover">`;
                    } else if (type === 'student') {
                        slide.innerHTML = `
                            <div class="flex flex-row items-center w-full h-full px-4 gap-4">
                                <div class="flex-none w-32 h-32 md:w-40 md:h-40 rounded-full border-4 border-school-gold overflow-hidden shadow-lg bg-gray-200">
                                    <img src="${item.image || 'https://placehold.co/200?text=Student'}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/200?text=No+Img'">
                                </div>
                                <div class="flex-1 flex flex-col items-start justify-center text-left min-w-0">
                                    <h3 class="text-2xl font-bold text-school-navy mb-1 leading-tight">${item.name}</h3>
                                    <span class="bg-school-gold text-school-navy px-3 py-1 rounded-full text-sm font-bold mb-3">${item.focus || 'Student'}</span>
                                    <p class="text-gray-600 italic line-clamp-3 text-sm md:text-base">"${item.description}"</p>
                                </div>
                            </div>
                        `;
                    } else if (type === 'teacher') {
                        slide.innerHTML = `
                            <div class="flex flex-row items-center w-full h-full px-4 gap-4">
                                <div class="flex-none w-32 h-32 md:w-40 md:h-40 rounded-full border-4 border-school-navy overflow-hidden shadow-lg bg-gray-200">
                                    <img src="${item.image || 'https://placehold.co/200?text=Staff'}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/200?text=No+Img'">
                                </div>
                                <div class="flex-1 text-left min-w-0">
                                    <h3 class="text-2xl font-bold text-gray-800 leading-tight">${item.name}</h3>
                                    <div class="text-school-navy font-bold uppercase tracking-wide text-sm mb-2">${item.dept}</div>
                                    <p class="text-gray-600 text-sm line-clamp-4 border-l-4 border-school-gold pl-3">${item.bio}</p>
                                </div>
                            </div>
                        `;
                    } else if (type === 'announcement') {
                        const isImg = item.image && item.image.length > 50; 
                        slide.innerHTML = `
                            <div class="flex flex-row items-center w-full h-full px-4 gap-4 relative">
                                ${isImg ? 
                                    `<div class="flex-none w-1/3 h-full flex items-center justify-center p-2">
                                        <img src="${item.image}" class="max-h-full max-w-full rounded-lg shadow-sm object-contain">
                                     </div>` : 
                                    `<div class="flex-none w-24 flex items-center justify-center text-school-gold">
                                        <i class="fas fa-bullhorn fa-4x"></i>
                                     </div>`
                                }
                                <div class="flex-1 flex flex-col justify-center text-left min-w-0">
                                    <h3 class="text-xl md:text-2xl font-bold text-school-navy mb-2 leading-tight">${item.title}</h3>
                                    <div class="h-1 w-20 bg-school-gold mb-3"></div>
                                    <p class="text-gray-700 text-sm md:text-lg line-clamp-4">${item.description}</p>
                                </div>
                                ${item.urgent ? '<span class="absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-bl-lg uppercase animate-pulse">Urgent</span>' : ''}
                            </div>
                        `;
                    }
                    setTimeout(() => slide.classList.remove('opacity-0'), 50);
                    queueNext(config.interval);
                }
            };
            showSlide();
        }

        // --- Admin Interface ---
        window.formatText = (identifier, tag) => {
            let textarea = document.querySelector(`textarea[name="${identifier}"]`);
            if (!textarea) textarea = document.getElementById(identifier);
            if (!textarea) return;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            textarea.value = text.substring(0, start) + `<${tag}>` + text.substring(start, end) + `</${tag}>` + text.substring(end);
            textarea.focus();
        };

        window.toggleAdminModal = () => { document.getElementById('admin-modal').classList.toggle('hidden'); };

        window.switchTab = (tabId) => {
            document.querySelectorAll('.admin-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.admin-tab-btn').forEach(el => {
                el.classList.remove('bg-white', 'shadow-sm', 'border-l-4', 'border-school-navy', 'text-school-navy');
                el.classList.add('border-transparent');
            });
            document.getElementById(tabId).classList.remove('hidden');
            const btn = Array.from(document.querySelectorAll('.admin-tab-btn')).find(b => b.getAttribute('onclick').includes(tabId));
            if(btn) {
                btn.classList.add('bg-white', 'shadow-sm', 'border-l-4', 'border-school-navy', 'text-school-navy');
                btn.classList.remove('border-transparent');
            }
        };

        window.saveConfig = async () => {
            showLoader();
            try {
                const logoFile = document.getElementById('conf-logo-file').files[0];
                let logoBase64 = appData.settings?.logo || "";
                if (logoFile) { try { logoBase64 = await convertBase64(logoFile); } catch (err) { console.error(err); } }
                const conf = {
                    schoolName: els.confName.value,
                    subtitle: els.confSubtitle.value,
                    subtitle2: els.confSubtitle2.value,
                    location: els.confLocation.value,
                    googleCalendar: els.confCalendar.value,
                    logo: logoBase64
                };
                if (appData.settingsId) await updateDoc(doc(getCollectionRef(COLLECTIONS.SETTINGS), appData.settingsId), conf);
                else await addDoc(getCollectionRef(COLLECTIONS.SETTINGS), conf);
            } catch(e) { console.error(e); }
            hideLoader();
        };

        function showLoader() { document.getElementById('global-loader').classList.remove('hidden'); }
        function hideLoader() { document.getElementById('global-loader').classList.add('hidden'); }

        function renderAdminList(type, data) {
            const container = els[`admin${type.charAt(0).toUpperCase() + type.slice(1)}`];
            if (!container) return;
            if (data.length === 0) { container.innerHTML = `<p class="text-gray-500 italic col-span-3">No items found.</p>`; return; }
            container.innerHTML = data.map(item => {
                let mainText = item.title || item.name || item.text;
                let subText = item.description || item.dept || item.datetime || '';
                let img = item.image;
                if (type === 'ticker') { const tmp = document.createElement("DIV"); tmp.innerHTML = mainText; mainText = tmp.textContent || tmp.innerText || ""; subText = "Ticker Message"; } 
                else if (type === 'media') { mainText = item.type.toUpperCase() + ' Media'; subText = item.content ? item.content.substring(0, 40) + '...' : 'No Content'; if (item.type === 'image') img = item.content; }
                return `
                <div class="bg-white p-4 rounded-lg shadow border border-gray-200 flex justify-between items-start group">
                    <div class="flex items-start space-x-3 overflow-hidden">
                        ${img ? `<img src="${img}" class="w-10 h-10 rounded-full object-cover border">` : ''}
                        <div class="min-w-0"><h4 class="font-bold text-gray-800 truncate text-sm">${mainText}</h4><p class="text-xs text-gray-500 truncate">${subText || ''}</p></div>
                    </div>
                    <div class="flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="editEntry('${type}', '${item.id}')" class="text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteEntry('${type}', '${item.id}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }).join('');
        }

        let currentEditType = null;
        let currentEditId = null;

        window.openEntryModal = (type) => {
            currentEditType = type;
            currentEditId = null;
            document.getElementById('entry-modal-title').innerText = `Add ${type.charAt(0).toUpperCase() + type.slice(1, type.endsWith('s') ? -1 : undefined)}`; 
            document.getElementById('entry-form').reset();
            generateFormFields(type, null);
            document.getElementById('entry-modal').classList.remove('hidden');
        };

        window.editEntry = (type, id) => {
            currentEditType = type;
            currentEditId = id;
            const item = appData[type].find(i => i.id === id);
            if (!item) return;
            document.getElementById('entry-modal-title').innerText = `Edit ${type.charAt(0).toUpperCase() + type.slice(1, type.endsWith('s') ? -1 : undefined)}`;
            generateFormFields(type, item);
            document.getElementById('entry-modal').classList.remove('hidden');
        };

        window.closeEntryModal = () => { document.getElementById('entry-modal').classList.add('hidden'); };

        window.deleteEntry = async (type, id) => {
            if(!confirm("Are you sure?")) return;
            showLoader();
            try { await deleteDoc(doc(getCollectionRef(type), id)); } catch(e) { console.error(e); }
            hideLoader();
        };

        window.handleEntrySubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            if (currentEditType === 'announcements') data.urgent = formData.get('urgent') === 'on';
            const fileInput = document.getElementById('form-image-file');
            if (fileInput && fileInput.files.length > 0) {
                try { data.image = await convertBase64(fileInput.files[0]); } catch(err) { console.error("Image error"); }
            } else if (!data.image && currentEditId) {
                 const oldItem = appData[currentEditType].find(i => i.id === currentEditId);
                 if(oldItem && oldItem.image) data.image = oldItem.image;
            }
            if (data.image && data.image.includes('drive.google.com')) {
                const idMatch = data.image.match(/[-\w]{25,}/);
                if(idMatch) data.image = `https://lh3.googleusercontent.com/d/${idMatch[0]}`;
            }
            showLoader();
            try {
                if (currentEditId) await updateDoc(doc(getCollectionRef(currentEditType), currentEditId), data);
                else await addDoc(getCollectionRef(currentEditType), data);
                closeEntryModal();
            } catch(err) { console.error(err); alert("Error saving."); }
            hideLoader();
        };

        function generateFormFields(type, values) {
            const container = document.getElementById('entry-fields');
            let html = '';
            const v = values || {};
            const toolbar = (fieldName) => `
                <div class="space-x-1 flex items-center">
                    <button type="button" onclick="formatText('${fieldName}', 'b')" class="px-2 py-0.5 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold" title="Bold">B</button>
                    <button type="button" onclick="formatText('${fieldName}', 'i')" class="px-2 py-0.5 bg-gray-200 hover:bg-gray-300 rounded text-xs italic" title="Italic">I</button>
                </div>
            `;
            
            if (type === 'announcements') {
                html += `
                    <div><label class="block text-sm font-bold mb-1">Title</label><input name="title" required value="${v.title || ''}" class="w-full p-2 border rounded"></div>
                    <div><div class="flex justify-between items-center mb-1"><div class="flex items-center"><label class="block text-sm font-bold mr-2">Description</label></div>${toolbar('description')}</div><textarea name="description" required rows="3" class="w-full p-2 border rounded">${v.description || ''}</textarea></div>
                    <div class="flex items-center mt-2"><input type="checkbox" name="urgent" ${v.urgent ? 'checked' : ''} class="h-4 w-4"><label class="ml-2 text-sm font-bold text-red-600">Mark as Urgent</label></div>
                `;
            } else if (type === 'students') {
                html += `
                    <div><label class="block text-sm font-bold mb-1">Student Name</label><input name="name" required value="${v.name || ''}" class="w-full p-2 border rounded"></div>
                    <div><label class="block text-sm font-bold mb-1">Focus Area</label><input name="focus" placeholder="e.g. Science, Basketball" value="${v.focus || ''}" class="w-full p-2 border rounded"></div>
                    <div><div class="flex justify-between items-center mb-1"><div class="flex items-center"><label class="block text-sm font-bold mr-2">Quote / Description</label></div>${toolbar('description')}</div><textarea name="description" required rows="3" class="w-full p-2 border rounded">${v.description || ''}</textarea></div>
                `;
            } else if (type === 'teachers') {
                html += `
                    <div><label class="block text-sm font-bold mb-1">Name</label><input name="name" required value="${v.name || ''}" class="w-full p-2 border rounded"></div>
                    <div><label class="block text-sm font-bold mb-1">Department</label><select name="dept" class="w-full p-2 border rounded">${DEPARTMENTS.map(d => `<option value="${d}" ${v.dept === d ? 'selected' : ''}>${d}</option>`).join('')}</select></div>
                    <div><div class="flex justify-between items-center mb-1"><div class="flex items-center"><label class="block text-sm font-bold mr-2">Bio</label></div>${toolbar('bio')}</div><textarea name="bio" required rows="3" class="w-full p-2 border rounded">${v.bio || ''}</textarea></div>
                `;
            } else if (type === 'events') {
                html += `
                    <div><label class="block text-sm font-bold mb-1">Event Title</label><input name="title" required value="${v.title || ''}" class="w-full p-2 border rounded"></div>
                    <div><label class="block text-sm font-bold mb-1">Date</label><input type="date" name="datetime" required value="${v.datetime || ''}" class="w-full p-2 border rounded"></div>
                    <div><label class="block text-sm font-bold mb-1">Location</label><input name="location" value="${v.location || ''}" class="w-full p-2 border rounded"></div>
                `;
            } else if (type === 'ticker') {
                html += `<div><div class="flex justify-between items-center mb-1"><div class="flex items-center"><label class="block text-sm font-bold mr-2">Message</label></div></div><textarea name="text" required rows="3" class="w-full p-2 border rounded">${v.text || ''}</textarea></div>`;
            } else if (type === 'media') {
                html += `
                    <div><label class="block text-sm font-bold mb-1">Media Type</label><select name="type" class="w-full p-2 border rounded">
                        <option value="youtube" ${v.type === 'youtube' ? 'selected' : ''}>YouTube Video</option>
                        <option value="facebook" ${v.type === 'facebook' ? 'selected' : ''}>Facebook Embed Code</option>
                        <option value="image" ${v.type === 'image' ? 'selected' : ''}>Image URL</option>
                    </select></div>
                    <div><label class="block text-sm font-bold mb-1">Content (URL or Code)</label><textarea name="content" required rows="3" class="w-full p-2 border rounded font-mono text-xs" placeholder="Paste URL or Code here...">${v.content || ''}</textarea></div>
                `;
            }
            if (type !== 'events' && type !== 'ticker' && type !== 'media') {
                html += `
                    <div class="border-t pt-4 mt-2">
                        <label class="block text-sm font-bold mb-1">Image (URL or Upload)</label>
                        <input name="image" placeholder="https://..." value="${v.image && v.image.startsWith('http') ? v.image : ''}" class="w-full p-2 border rounded mb-2 text-sm">
                        <input type="file" id="form-image-file" accept="image/*" class="text-sm">
                        <p class="text-xs text-gray-500 mt-1">Upload converts to Base64 (Max 1MB). URLs preferred.</p>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        const convertBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const fileReader = new FileReader();
                fileReader.readAsDataURL(file);
                fileReader.onload = () => resolve(fileReader.result);
                fileReader.onerror = (error) => reject(error);
            });
        };
    </script>
</body>
</html>
